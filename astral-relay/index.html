<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AIãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ãƒãƒ£ãƒƒãƒˆ ãƒ¦ãƒ¡ãƒŸãƒ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        console.log("Yumemiru v3 (Modal-Room) script parsing started...");

        // === Firebase SDK ===
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut, signInAnonymously, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, orderBy, limit, addDoc, serverTimestamp, getDocs, writeBatch, where, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // === ã‚°ãƒ­ãƒ¼ãƒãƒ«å®šæ•° (Canvasç’°å¢ƒ) ===
        // â˜… ä¿®æ­£: Canvasç’°å¢ƒã® __app_id ã‚’å„ªå…ˆçš„ã«ä½¿ç”¨
        const appId = typeof __app_id !== 'undefined' ? __app_id : '1:86771631381:web:090a3f36c113fa7aca951c';
        
        // â˜… ä¿®æ­£: Canvasç’°å¢ƒã® __firebase_config ã‚’å„ªå…ˆçš„ã«ä½¿ç”¨
        let firebaseConfig = {};
        const hardcodedFallbackConfig = {
            apiKey: "AIzaSyDolupeBhsGeZH2NJQAUJWzrH20pLnLyhs",
            authDomain: "astral-relay.firebaseapp.com",
            projectId: "astral-relay",
            storageBucket: "astral-relay.firebasestorage.app",
            messagingSenderId: "86771631381",
            appId: "1:86771631381:web:090a3f36c113fa7aca951c",
            measurementId: "G-8RD3U5NHXF"
        };
        
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
                console.log("Yumemiru: Loaded Firebase config from __firebase_config.");
            } catch (e) {
                console.error("Yumemiru: Failed to parse __firebase_config, using hardcoded fallback.", e);
                firebaseConfig = hardcodedFallbackConfig;
            }
        } else {
            console.warn("Yumemiru: __firebase_config is not defined, using hardcoded fallback (standalone mode?).");
            firebaseConfig = hardcodedFallbackConfig;
        }

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const WELCOME_GUIDE_KEY = `yumemiru_welcome_guide_shown_v3_${appId}`;
        const LAST_ROOM_KEY = `yumemiru_last_room_id_${appId}`; // â˜… v3: æœ€çµ‚ãƒ«ãƒ¼ãƒ ä¿å­˜ç”¨ (ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿)
        const LAST_SPEAKER_KEY = `yumemiru_last_speaker_id_${appId}`; // â˜… v3: æœ€çµ‚ãƒ­ãƒ¼ãƒ«ä¿å­˜ç”¨ (ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿)

        // â˜… v10 æ–°è¦å®šç¾©: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®è¨­å®šã‚’ä¿å­˜ã™ã‚‹Firestoreãƒ‘ã‚¹
        const getUserPreferenceRef = (uid) => {
            if (!db || !uid) return null;
            return doc(db, 'artifacts', appId, 'users', uid, 'settings', 'preference');
        }

        // === APIå®šæ•° ===
        const API_KEY = "";
        const IMAGEN_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${API_KEY}`;
        const FLASH_IMAGE_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${API_KEY}`;
        const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`;
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        const IMAGEN_MIME_TYPE = 'image/png';

        // â˜… v23: ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«ï¼ˆæ©Ÿèƒ½è§£èª¬AIï¼‰ã®ãŸã‚ã®æ©Ÿèƒ½ä»•æ§˜æ›¸ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        const SYSTEM_MANUAL_PROMPT = `
ã‚ãªãŸã¯ã€AIãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã€Œãƒ¦ãƒ¡ãƒŸãƒ«ã€ã®æ©Ÿèƒ½è§£èª¬AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®è³ªå•ã«å¯¾ã—ã€ä»¥ä¸‹ã®æ©Ÿèƒ½ä»•æ§˜æ›¸ã«åŸºã¥ã„ã¦ã€ç°¡æ½”ã«ã€åˆ†ã‹ã‚Šã‚„ã™ãã€ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚

# AIãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ãƒãƒ£ãƒƒãƒˆã€Œãƒ¦ãƒ¡ãƒŸãƒ«ã€æ©Ÿèƒ½ä»•æ§˜æ›¸

## 1. åŸºæœ¬æ¦‚è¦
ã€Œãƒ¦ãƒ¡ãƒŸãƒ«ã€ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã—ãŸAIãƒ­ãƒ¼ãƒ«ï¼ˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼‰ã‚„ã€ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã—ãŸAIãƒ­ãƒ¼ãƒ«ãŸã¡ã¨ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ä¼šè©±ï¼ˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ï¼‰ã‚’æ¥½ã—ã‚ã‚‹ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã§ã™ã€‚

## 2. ãƒ«ãƒ¼ãƒ æ©Ÿèƒ½
- **ãƒ«ãƒ¼ãƒ ä¸€è¦§ (ğŸ  ã‚¢ã‚¤ã‚³ãƒ³)**: ã‚¢ãƒ—ãƒªã®å…¥ã‚Šå£ã§ã™ã€‚ãƒ˜ãƒƒãƒ€ãƒ¼ã®å®¶ã®ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰é–‹ãã¾ã™ã€‚
- **ãƒ«ãƒ¼ãƒ ä½œæˆ**: å¥½ããªåå‰ã¨èª¬æ˜ã§æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã§ãã¾ã™ã€‚
- **ãƒ«ãƒ¼ãƒ å…¥å®¤**: æ—¢å­˜ã®ãƒ«ãƒ¼ãƒ ã«å…¥å®¤ã§ãã¾ã™ã€‚ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã‚„æ‹›å¾…ã•ã‚ŒãŸAIãƒ­ãƒ¼ãƒ«ã¯ãƒ«ãƒ¼ãƒ ã”ã¨ã«ç‹¬ç«‹ã—ã¦ã„ã¾ã™ã€‚
- **ãƒ«ãƒ¼ãƒ å‰Šé™¤**: è‡ªåˆ†ãŒä½œæˆã—ãŸãƒ«ãƒ¼ãƒ ã¯å‰Šé™¤ã§ãã¾ã™ã€‚

## 3. ãƒ­ãƒ¼ãƒ«ï¼ˆAIã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼‰æ©Ÿèƒ½
- **ãƒ­ãƒ¼ãƒ«ç®¡ç† (â˜° ã‚¢ã‚¤ã‚³ãƒ³)**: ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰å·¦ã‚«ãƒ©ãƒ ã‚’é–‹ãã€AIãƒ­ãƒ¼ãƒ«ã®ç®¡ç†ã‚„è¨­å®šãŒè¡Œãˆã¾ã™ã€‚
- **ãƒ­ãƒ¼ãƒ«ä½œæˆ**:
    - **è‡ªåˆ†ã®åˆ†èº«ã‚’ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ä½œæˆ**: ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§ã€ç™ºè¨€ç”¨ã®ï¼ˆAIã§ã¯ãªã„ï¼‰ãƒ­ãƒ¼ãƒ«ã‚’å³åº§ã«ä½œæˆã—ã¾ã™ã€‚ã“ã‚Œã¯ä¸»ã«ãƒãƒ£ãƒƒãƒˆã«å‚åŠ ã™ã‚‹ãŸã‚ã®ã‚¢ãƒã‚¿ãƒ¼ã§ã™ã€‚
    - **ãƒ­ãƒ¼ãƒ«ã®ä½œæˆ (è©³ç´°)**: AIãƒ­ãƒ¼ãƒ«ï¼ˆAIã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼‰ã‚’è©³ç´°ã«è¨­å®šã—ã¦ä½œæˆã—ã¾ã™ã€‚
- **ãƒ­ãƒ¼ãƒ«ç·¨é›†**: è‡ªåˆ†ãŒä½œæˆã—ãŸãƒ­ãƒ¼ãƒ«ã¯ã„ã¤ã§ã‚‚ç·¨é›†ã§ãã¾ã™ã€‚
- **è¨­å®šé …ç›®**:
    - **åå‰**: AIãƒ­ãƒ¼ãƒ«ã®åå‰ã€‚
    - **ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼**: AIç™ºè¨€æ™‚ã®ãƒãƒ£ãƒƒãƒˆãƒãƒ–ãƒ«ã®è‰²ã€‚
    - **TTSãƒœã‚¤ã‚¹**: AIãŒä½¿ç”¨ã™ã‚‹éŸ³å£°åˆæˆã®ãƒœã‚¤ã‚¹ã€‚
    - **System Prompt (äººæ ¼å®šç¾©)**: **æœ€ã‚‚é‡è¦**ã€‚AIã®æ€§æ ¼ã€å£èª¿ã€èƒŒæ™¯è¨­å®šã€å½¹å‰²ãªã©ã‚’è©³ç´°ã«å®šç¾©ã—ã¾ã™ã€‚
    - **ã‚¢ãƒã‚¿ãƒ¼ç”»åƒ (æ„Ÿæƒ…åˆ¥)**: Standard (æ¨™æº–), Happy (å–œã³), Sad (æ‚²ã—ã¿), Curiosity (ç–‘å•) ã®4ç¨®é¡ã®ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã‚’è¨­å®šã§ãã¾ã™ã€‚
    - **è¨˜æ†¶ (Memory)**: AIãŒä¼šè©±ã‹ã‚‰å­¦ç¿’ã—ãŸå†…å®¹ï¼ˆè¦ç´„ï¼‰ã€‚é€šå¸¸ã¯10åˆ†ã”ã¨ã«è‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã™ãŒã€ç·¨é›†ç”»é¢ã§æ‰‹å‹•æ›´æ–°ã‚‚å¯èƒ½ã§ã™ã€‚
- **AIã«ã‚ˆã‚‹ææ¡ˆæ©Ÿèƒ½ (âœ¨)**:
    - ãƒ­ãƒ¼ãƒ«ç·¨é›†ç”»é¢ã§ã€ŒAIã«ä»»ã›ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€å…¥åŠ›ã•ã‚ŒãŸã€Œãƒ­ãƒ¼ãƒ«åã€ã¨ã€Œãƒœã‚¤ã‚¹ã®æ€§åˆ¥ã€ã«åŸºã¥ãã€AIãŒã€ŒSystem Promptã€ã¨ã€Œå…¨æ„Ÿæƒ…ã®ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã€ã‚’è‡ªå‹•ç”Ÿæˆãƒ»ææ¡ˆã—ã¾ã™ã€‚

## 4. ãƒãƒ£ãƒƒãƒˆã¨AIã®å‹•ä½œ
- **ãƒ«ãƒ¼ãƒ ã¸ã®æ‹›å¾…**: å·¦ã‚«ãƒ©ãƒ  (â˜°) ã§ã€ã€Œå…¨ãƒ­ãƒ¼ãƒ«ä¸€è¦§ã€ã‹ã‚‰ã€AIãƒ­ãƒ¼ãƒ«ã®ã€Œæ‹›å¾… (OFF)ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ãã®AIãŒç¾åœ¨ã®ãƒ«ãƒ¼ãƒ ã«æ‹›å¾…ã•ã‚Œã¾ã™ã€‚æ‹›å¾…ã•ã‚ŒãŸAIã®ã¿ãŒãƒãƒ£ãƒƒãƒˆã«å‚åŠ ã—ã¾ã™ã€‚ï¼ˆè£½ä½œè€…ãŒã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã®AIã¯æ‹›å¾…ã§ãã¾ã›ã‚“ï¼‰
- **ç™ºè¨€è€…ã®é¸æŠ (ğŸ‘¤/â“ ã‚¢ã‚¤ã‚³ãƒ³)**:
    - ãƒãƒ£ãƒƒãƒˆå…¥åŠ›æ¬„ã®å·¦ã«ã‚ã‚‹ã‚¢ã‚¤ã‚³ãƒ³ (ğŸ‘¤/â“) ã‚’æŠ¼ã™ã¨ã€ç™ºè¨€è€…ã‚’é¸æŠã§ãã¾ã™ã€‚
    - **è‡ªåˆ†ã®ãƒ­ãƒ¼ãƒ« (ğŸ‘¤)**: è‡ªåˆ†ãŒä½œæˆã—ãŸãƒ­ãƒ¼ãƒ«ã‚’é¸æŠã™ã‚‹ã¨ã€ãã®ãƒ­ãƒ¼ãƒ«ã¨ã—ã¦ãƒãƒ£ãƒƒãƒˆã«ç™ºè¨€ã§ãã¾ã™ã€‚
    - **ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ« (â“)**: ã“ã®ãƒ­ãƒ¼ãƒ«ï¼ˆã‚ãªãŸã€AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆï¼‰ã‚’é¸æŠã™ã‚‹ã¨ã€ãƒãƒ£ãƒƒãƒˆæ¬„ãŒæ©Ÿèƒ½è§£èª¬ã®ãŸã‚ã®è³ªå•ãƒœãƒƒã‚¯ã‚¹ã«å¤‰ã‚ã‚Šã¾ã™ã€‚ã“ã®ãƒ¢ãƒ¼ãƒ‰ã§é€ä¿¡ã•ã‚ŒãŸå†…å®¹ã¯ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã«ã¯æ®‹ã‚Šã¾ã›ã‚“ã€‚
- **AIã®å¿œç­” (AIãƒ­ãƒ¼ãƒ«)**:
    - **æŒ‡åå¿œç­”**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚„ä»–ã®AIã®ç™ºè¨€ã«ã€ç‰¹å®šã®AIãƒ­ãƒ¼ãƒ«ã®åå‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€æŒ‡åã•ã‚ŒãŸAIãŒå¿œç­”ã—ã¾ã™ã€‚ï¼ˆä¾‹: ã€Œã‚¯ãƒ­ãƒ¼ãƒ‰ã•ã‚“ã€ã“ã‚“ã«ã¡ã¯ï¼ã€ï¼‰
    - **é€šå¸¸å¿œç­”**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™ºè¨€ï¼ˆAIã®ç™ºè¨€ã§ã¯ãªã„ï¼‰ã«å¯¾ã—ã¦ã€æ‹›å¾…ã•ã‚Œã¦ã„ã‚‹AIï¼ˆç™ºè¨€è€…ã¨æŒ‡åã•ã‚ŒãŸAIã‚’é™¤ãï¼‰ãŒç¢ºç‡ã§å¿œç­”ã—ã¾ã™ã€‚
    - **è‡ªç™ºçš„ç™ºè¨€ (ğŸ’¡ ã‚¢ã‚¤ã‚³ãƒ³)**: ãƒ˜ãƒƒãƒ€ãƒ¼ã®é›»çƒã‚¢ã‚¤ã‚³ãƒ³ã‚’ONã«ã™ã‚‹ã¨ã€ä¼šè©±ãŒé€”åˆ‡ã‚ŒãŸå ´åˆã«ã€AIãŒãƒ©ãƒ³ãƒ€ãƒ ã«è‡ªç™ºçš„ãªç™ºè¨€ï¼ˆé›‘è«‡ï¼‰ã‚’ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
- **ç”»åƒæ·»ä»˜ (ğŸ“ ã‚¢ã‚¤ã‚³ãƒ³)**: ãƒãƒ£ãƒƒãƒˆå…¥åŠ›æ™‚ã«ã‚¯ãƒªãƒƒãƒ—ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰ç”»åƒã‚’æ·»ä»˜ã—ã¦é€ä¿¡ã§ãã¾ã™ã€‚AIã‚‚ç”»åƒã‚’èªè­˜ã—ã¦å¿œç­”ã—ã¾ã™ã€‚
- **TTS (ğŸ”Š ã‚¢ã‚¤ã‚³ãƒ³)**: AIã‚„ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™ºè¨€ãƒãƒ–ãƒ«ã«ã‚ã‚‹ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’æŠ¼ã™ã¨ã€ãã®ç™ºè¨€ã‚’èª­ã¿ä¸Šã’ã¾ã™ã€‚
- **TTSè‡ªå‹•å†ç”Ÿ (ãƒ˜ãƒƒãƒ€ãƒ¼ã® ğŸ”Š ã‚¢ã‚¤ã‚³ãƒ³)**: ONã«ã™ã‚‹ã¨ã€è‡ªåˆ†ä»¥å¤–ã®ç™ºè¨€ãŒè‡ªå‹•ã§èª­ã¿ä¸Šã’ã‚‰ã‚Œã¾ã™ã€‚

## 5. ãã®ä»–ã®æ©Ÿèƒ½
- **ä¼šè©±ã®è¦ç´„ (âœ¨)**: å·¦ã‚«ãƒ©ãƒ  (â˜°) ã®ã€Œã“ã®ä¼šè©±ã‚’è¦ç´„ã€ãƒœã‚¿ãƒ³ã§ã€ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ ã®ç›´è¿‘ã®ä¼šè©±ã‚’AIãŒè¦ç´„ã—ã¾ã™ã€‚
- **è¨­å®šã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ**: å·¦ã‚«ãƒ©ãƒ  (â˜°) ã‹ã‚‰ã€è‡ªåˆ†ãŒä½œæˆã—ãŸå…¨ãƒ­ãƒ¼ãƒ«è¨­å®šã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰ã—ãŸã‚Šã€èª­ã¿è¾¼ï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼‰ã‚“ã ã‚Šã§ãã¾ã™ã€‚
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼åå¤‰æ›´**: å·¦ã‚«ãƒ©ãƒ  (â˜°) ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®æ¨ªã«ã‚ã‚‹ é‰›ç­†(âœï¸)ã‚¢ã‚¤ã‚³ãƒ³ ã‹ã‚‰ã€è‡ªåˆ†ã®è¡¨ç¤ºåã‚’å¤‰æ›´ã§ãã¾ã™ã€‚

ã‚ãªãŸã¯ã“ã‚Œã‚‰ã®æƒ…å ±ã«åŸºã¥ãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚
`;


        // === ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ ===
        let db, auth, storage;
        let currentUser = null;
        let currentUserName = "ã‚²ã‚¹ãƒˆ";

        // --- ç”»é¢çŠ¶æ…‹ ---
        // â˜… v3: currentView å»ƒæ­¢ã€‚ãƒ¢ãƒ¼ãƒ€ãƒ«ã®é–‹é–‰ã§ç®¡ç†ã€‚
        let currentRoomId = null;
        let currentRoomName = "ãƒ«ãƒ¼ãƒ æœªå…¥å®¤";
        // â˜… v22: AIãƒ­ãƒƒã‚¯ã‚’ã€Œå¿œç­”ç™ºè©±ã€ã¨ã€Œè‡ªå‹•ç™ºè©±ã€ã«åˆ†é›¢
        let isAIPosting_Response = false;
        let isAIPosting_Spontaneous = false;
        let isUpdatingMemory = false;

        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ (å…¨ãƒ«ãƒ¼ãƒ å…±é€š) ---
        let roles = []; // å…¨ãƒ­ãƒ¼ãƒ«ã®å®šç¾©
        let usersOnline = {}; // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ (Global Presence)
        let rooms = []; // å…¨ãƒ«ãƒ¼ãƒ ä¸€è¦§

        // --- ãƒ«ãƒ¼ãƒ å†…ãƒ‡ãƒ¼ã‚¿ (å…¥å®¤æ™‚ã«å–å¾—) ---
        let currentRoomInvitedRoles = {}; // { roleId: { roleId, name, ... } }
        let currentRoomPresence = {}; // { userId: { uid, displayName, selectedRole, ... } }
        let currentRoomLogs = []; // è¡¨ç¤ºç”¨ãƒ­ã‚°ãƒãƒƒãƒ•ã‚¡

        // --- ãƒªã‚¹ãƒŠãƒ¼ (Unsubscribeç”¨) ---
        let globalRolesListener = null;
        let globalPresenceListener = null;
        let roomsListener = null; // â˜… v3: ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒªã‚¹ãƒŠãƒ¼ã«å¤‰æ›´
        let roomInvitesListener = null;
        let roomPresenceListener = null;
        let chatLogsListener = null;

        // --- å®šæœŸå®Ÿè¡Œã‚¿ã‚¹ã‚¯ (ãƒ«ãƒ¼ãƒ å†…) ---
        let mainIntervalTimer = null; // setIntervalã®ID
        let isSpontaneousSpeech_Enabled = false; // è‡ªç™ºçš„ç™ºè¨€ãƒˆã‚°ãƒ«
        let lastMemoryUpdateTime = 0;
        let nextSpontaneousCheckTime = 0; // â˜… v12: æ¬¡ã®è‡ªç™ºçš„ç™ºè¨€ãƒã‚§ãƒƒã‚¯æ™‚åˆ» (ãƒŸãƒªç§’)
        let lastChatLogIdForMemory = null;

        // --- TTS (å…±é€š) ---
        let isAutoTTS_Enabled = false;
        let playedLogIds = new Set();
        let ttsQueue = [];
        let isPlayingTTS = false;
        let audioContext;

        // â˜…â˜…â˜… Electroné€£æºç”¨ è¿½åŠ  â˜…â˜…â˜…
        /**
         * @description Electronãƒ›ã‚¹ãƒˆç’°å¢ƒã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹
         */
        let isElectronHost = false;
        /**
         * @description Electronãƒ›ã‚¹ãƒˆã‹ã‚‰èª­ã¿è¾¼ã‚“ã AIå®šç¾©ãƒªã‚¹ãƒˆ
         * @type {Array<{id: string, name: string}>}
         */
        let electronAIList = [];
        // â˜…â˜…â˜… ã“ã“ã¾ã§ â˜…â˜…â˜…

        // === æ„Ÿæƒ…ãƒ»ãƒœã‚¤ã‚¹å®šç¾© (å¤‰æ›´ãªã—) ===
        const EMOTIONS = {
            standard: { label: 'æ¨™æº–', emoji: 'ğŸ˜Š' },
            happy: { label: 'å–œã³', emoji: 'ğŸ˜„' },
            sad: { label: 'æ‚²ã—ã¿', emoji: 'ğŸ˜¢' },
            curiosity: { label: 'ç–‘å•', emoji: 'ğŸ¤”' }
        };
        const DEFAULT_EMOTION = 'standard';
        const TTS_VOICES = [
            { name: "Kore", description: "Firm (æ¨™æº–çš„ãªå¥³æ€§)", gender: "female" },
            { name: "Zephyr", description: "Bright (æ˜ã‚‹ã„å¥³æ€§)", gender: "female" },
            { name: "Leda", description: "Youthful (è‹¥ã€…ã—ã„å¥³æ€§)", gender: "female" },
            { name: "Aoede", description: "Breezy (ãã‚ˆé¢¨ã®ã‚ˆã†ãªå¥³æ€§)", gender: "female" },
            { name: "Callirrhoe", description: "Easy-going (æ°—æ¥½ãªå¥³æ€§)", gender: "female" },
            { name: "Autonoe", description: "Informative (ã—ã£ã‹ã‚Šã—ãŸå¥³æ€§)", gender: "female" },
            { name: "Puck", description: "Upbeat (é™½æ°—ãªç”·æ€§)", gender: "male" },
            { name: "Charon", description: "Informative (æƒ…å ±æä¾›çš„ãªç”·æ€§)", gender: "male" },
            { name: "Fenrir", description: "Excitable (å…ƒæ°—ãªç”·æ€§)", gender: "male" },
            { name: "Orus", description: "Firm (å¼·å›ºãªç”·æ€§)", gender: "male" },
            { name: "Enceladus", description: "Breathy (æ¯ã¥ã‹ã„ã®ã‚ã‚‹ç”·æ€§)", gender: "male" },
            { name: "Iapetus", description: "Clear (ã‚¯ãƒªã‚¢ãªç”·æ€§)", gender: "male" },
            { name: "Umbriel", description: "Easy-going (æ°—æ¥½ãªç”·æ€§)", gender: "male" },
        ];


        // === TTS / Audio Context Utility (ä¿®æ­£ãªã—) ===
        const getAudioContext = () => {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume().catch(e => console.error("AudioContext resume failed", e));
            }
            return audioContext;
        };
        const base64ToArrayBuffer = (base64) => {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        };
        const pcmToWav = (pcmData, sampleRate) => {
            const numChannels = 1;
            const bitsPerSample = 16;
            const byteRate = sampleRate * numChannels * (bitsPerSample / 8);
            const blockAlign = numChannels * (bitsPerSample / 8);
            const dataSize = pcmData.length * (bitsPerSample / 8);
            const wavSize = 36 + dataSize;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);
            view.setUint32(0, 0x52494646, false); // "RIFF"
            view.setUint32(4, wavSize, true); // (file size - 8)
            view.setUint32(8, 0x57415645, false); // "WAVE"
            view.setUint32(12, 0x666d7420, false); // "fmt "
            view.setUint32(16, 16, true); // Subchunk1Size (16 for PCM)
            view.setUint16(20, 1, true); // AudioFormat (1 for PCM)
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);
            view.setUint32(36, 0x64617461, false); // "data"
            view.setUint32(40, dataSize, true);
            let offset = 44;
            for (let i = 0; i < pcmData.length; i++, offset += 2) {
                view.setInt16(offset, pcmData[i], true);
            }
            return new Blob([buffer], { type: 'audio/wav' });
        };
        window.updateTTSIndicator = () => {
            const indicator = document.getElementById('tts-indicator');
            if (!indicator) return;
            if (isPlayingTTS || ttsQueue.length > 0) {
                indicator.classList.remove('hidden'); indicator.classList.add('flex');
            } else {
                indicator.classList.add('hidden'); indicator.classList.remove('flex');
            }
        };
        const generateAudioBlob = async (roleId, text, voiceName) => {
            try {
                let selectedVoiceName = voiceName;
                if (!selectedVoiceName && roleId) {
                    const role = roles.find(r => r.id === roleId);
                    selectedVoiceName = role ? role.ttsVoice : TTS_VOICES[0].name;
                } else if (!selectedVoiceName) {
                    selectedVoiceName = TTS_VOICES[0].name;
                }
                const payload = {
                    contents: [{ parts: [{ text: text }] }],
                    generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: selectedVoiceName } } } },
                    model: "gemini-2.5-flash-preview-tts"
                };
                const response = await window.apiCall(TTS_API_URL, payload);
                const part = response?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;
                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    return pcmToWav(pcm16, sampleRate);
                } else {
                    throw new Error("TTS API response is missing or incorrect audio format.");
                }
            } catch (error) {
                console.error("TTS Generation Error:", error);
                return null;
            }
        };
        const processPlaybackQueue = async () => {
            if (isPlayingTTS || ttsQueue.length === 0) {
                if (!isPlayingTTS && ttsQueue.length === 0) { window.updateTTSIndicator(); }
                return;
            }
            const nextItem = ttsQueue[0];
            if (!nextItem.audioBlob) {
                window.updateTTSIndicator();
                return;
            }
            isPlayingTTS = true;
            window.updateTTSIndicator();
            const itemToPlay = ttsQueue.shift();
            try {
                const localAudioContext = getAudioContext();
                if (localAudioContext.state === 'suspended') { await localAudioContext.resume(); }
                const audioUrl = URL.createObjectURL(itemToPlay.audioBlob);
                const audio = new Audio(audioUrl);
                await new Promise((resolve, reject) => {
                    audio.onended = () => { URL.revokeObjectURL(audioUrl); resolve(); };
                    audio.onerror = (e) => { URL.revokeObjectURL(audioUrl); reject(e); };
                    audio.play().catch(reject);
                });
            } catch (error) {
                console.error("TTS Playback Error:", error);
            } finally {
                isPlayingTTS = false;
                window.updateTTSIndicator();
                processPlaybackQueue();
            }
        };
        window.playTTS = (roleId, text, logId = null) => {
            if (!currentUser || !text || text.trim().length === 0) return;

            // â˜… ä¿®æ­£: iOSã§ã®AudioContextå†é–‹ã‚’ã‚ˆã‚Šç¢ºå®Ÿã«ã™ã‚‹ãŸã‚ã€ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°å‰ã«å®Ÿè¡Œ
            getAudioContext();

            if (logId) { playedLogIds.add(logId); }
            const queueItem = { roleId: roleId, text: text, generationPromise: null, audioBlob: null };
            queueItem.generationPromise = generateAudioBlob(roleId, text, null);
            queueItem.generationPromise.then(blob => {
                if (blob) {
                    queueItem.audioBlob = blob;
                    processPlaybackQueue();
                } else {
                    const index = ttsQueue.indexOf(queueItem);
                    if (index > -1) { ttsQueue.splice(index, 1); }
                    window.updateTTSIndicator();
                }
            }).catch(e => {
                console.error("TTS Generation Promise Error:", e);
                const index = ttsQueue.indexOf(queueItem);
                if (index > -1) { ttsQueue.splice(index, 1); }
                window.updateTTSIndicator();
            });
            ttsQueue.push(queueItem);
            window.updateTTSIndicator();
            processPlaybackQueue();
        };
        window.playTTSSample = () => {
            const selectElement = document.getElementById('ttsVoice');
            if (!selectElement) { console.error("TTS voice select element not found."); return; }
            const selectedVoiceName = selectElement.value;
            const sampleText = "ã‚¨ãƒ¼ã‚¢ã‚¤ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ãƒãƒ£ãƒƒãƒˆã€ãƒ¦ãƒ¡ãƒŸãƒ«ã€‚";
            const queueItem = { roleId: null, text: sampleText, generationPromise: null, audioBlob: null };
            queueItem.generationPromise = generateAudioBlob(null, sampleText, selectedVoiceName);
            queueItem.generationPromise.then(blob => {
                if (blob) {
                    queueItem.audioBlob = blob;
                    processPlaybackQueue();
                } else {
                    const index = ttsQueue.indexOf(queueItem);
                    if (index > -1) { ttsQueue.splice(index, 1); }
                    window.updateTTSIndicator();
                }
            }).catch(e => {
                console.error("TTS Sample Generation Promise Error:", e);
                const index = ttsQueue.indexOf(queueItem);
                if (index > -1) { ttsQueue.splice(index, 1); }
                window.updateTTSIndicator();
            });
            ttsQueue.push(queueItem);
            window.updateTTSIndicator();
            processPlaybackQueue();
        };

        // === Image Utility ===
        const resizeBase64Image = (base64, mimeType, maxWidth, maxHeight) => {
            return new Promise((resolve, reject) => {
                if (mimeType === 'image/svg+xml') {
                    // SVGã¯ãƒªã‚µã‚¤ã‚ºã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã€ãã®ã¾ã¾è¿”ã™
                    resolve(base64);
                    return;
                }
                const img = new Image();
                img.onload = () => {
                    let width = img.width, height = img.height;
                    if (width > height) {
                        if (width > maxWidth) { height = Math.round(height * (maxWidth / width)); width = maxWidth; }
                    } else {
                        if (height > maxHeight) { width = Math.round(width * (maxHeight / height)); height = maxHeight; }
                    }
                    if (width === 0 || height === 0) { width = 1; height = 1; }
                    const canvas = document.createElement('canvas');
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, width, height);
                    // PNGã¾ãŸã¯JPEGã¨ã—ã¦å†ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    resolve(canvas.toDataURL(mimeType).split(',')[1]);
                };
                img.onerror = (error) => reject(error);
                img.src = `data:${mimeType};base64,${base64}`;
            });
        };

        const resizeBase64ImageAsPng = (base64, originalMimeType, maxWidth, maxHeight) => {
            return new Promise((resolve, reject) => {
                // SVGã¯ãã®ã¾ã¾Base64ã‚’è¿”ã™ï¼ˆãƒªã‚µã‚¤ã‚ºã‚‚å½¢å¼å¤‰æ›ã‚‚ã‚¹ã‚­ãƒƒãƒ—ï¼‰
                if (originalMimeType === 'image/svg+xml') {
                    resolve(base64);
                    return;
                }

                const img = new Image();
                img.onload = () => {
                    let width = img.width, height = img.height;
                    if (width > height) {
                        if (width > maxWidth) { height = Math.round(height * (maxWidth / width)); width = maxWidth; }
                    } else {
                        if (height > maxHeight) { width = Math.round(width * (maxHeight / height)); height = maxHeight; }
                    }
                    if (width === 0 || height === 0) { width = 1; height = 1; }

                    const canvas = document.createElement('canvas');
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, width, height);

                    // â˜… ä¿®æ­£: PNGã¨ã—ã¦å†ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã€Base64ã®ãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†ã‚’è¿”ã™
                    // mimeTypeã‚’ 'image/png' ã«å›ºå®š
                    const dataUrl = canvas.toDataURL('image/png');
                    resolve(dataUrl.split(',')[1]);
                };
                img.onerror = (error) => reject(error);
                img.src = `data:${originalMimeType};base64,${base64}`;
            });
        };

        window.fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                if (file.size > 5 * 1024 * 1024) { reject(new Error("File size exceeds 5MB limit.")); return; }
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64String = reader.result.split(',')[1];
                    const mimeType = reader.result.split(',')[0].split(':')[1].split(';')[0];
                    resolve({ base64: base64String, mimeType: mimeType });
                };
                reader.onerror = error => reject(error);
            });
        };
        let attachedImage = { base64: null, mimeType: null };
        window.handleImageAttachment = async (fileInput) => {
            const file = fileInput.files[0];
            if (!file) return;
            window.toggleUI(true, 'ç”»åƒã‚’å‡¦ç†ä¸­...');
            try {
                const { base64, mimeType } = await window.fileToBase64(file);

                // â˜… ä¿®æ­£: PNGå›ºå®šã®é–¢æ•°ã‚’ä½¿ç”¨ã€‚MIMEã‚¿ã‚¤ãƒ—ã¯ 'image/png' ã«å›ºå®šã€‚
                const resizedBase64 = await resizeBase64ImageAsPng(base64, mimeType, 400, 400);
                const fixedMimeType = (mimeType === 'image/svg+xml') ? mimeType : 'image/png';

                attachedImage = { base64: resizedBase64, mimeType: fixedMimeType };
                document.getElementById('image-preview-img').src = `data:${fixedMimeType};base64,${resizedBase64}`;
                document.getElementById('image-preview-container').classList.remove('hidden');
            } catch (error) {
                console.error("Image attachment error:", error);
                window.displayTemporaryMessage("ç”»åƒå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚5MBä»¥ä¸‹ã®ç”»åƒã‚’é¸ã‚“ã§ãã ã•ã„ã€‚");
                window.clearImageAttachment();
            } finally {
                window.toggleUI(false);
                fileInput.value = '';
            }
        };
        window.clearImageAttachment = () => {
            attachedImage = { base64: null, mimeType: null };
            document.getElementById('image-preview-img').src = '';
            document.getElementById('image-preview-container').classList.add('hidden');
        };

        // === Storage Utility (v6.1 ã‚¹ã‚¿ã‚¤ãƒ«) ===
        const getStorageAvatarRef = (fileName) => {
            // client.html ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° (currentUser, appId) ã‚’ä½¿ç”¨
            if (!storage || !appId || !currentUser) return null;
            const safeFileName = fileName.replace(/[^a-zA-Z0-9_.-]/g, ''); // ã‚µãƒ‹ã‚¿ã‚¤ã‚º
            return ref(storage, `artifacts/${appId}/users/${currentUser.uid}/avatars/${Date.now()}_${safeFileName}`);
        }

        const resizeImageToBlob = (file, maxWidth, maxHeight) => {
            return new Promise((resolve, reject) => {
                if (file.type === 'image/svg+xml') {
                    resolve(file);
                    return;
                }
                const img = new Image();
                img.onload = () => {
                    let width = img.width, height = img.height;
                    if (width > height) {
                        if (width > maxWidth) { height = Math.round(height * (maxWidth / width)); width = maxWidth; }
                    } else {
                        if (height > maxHeight) { width = Math.round(width * (maxHeight / height)); height = maxHeight; }
                    }
                    if (width === 0 || height === 0) { width = 1; height = 1; }
                    const canvas = document.createElement('canvas');
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, width, height);
                    canvas.toBlob((blob) => {
                        if (blob) {
                            resolve(blob);
                        } else {
                            reject(new Error('Canvas to Blob conversion failed.'));
                        }
                    }, file.type || 'image/png', 0.9);
                };
                img.onerror = (error) => reject(error);
                img.src = URL.createObjectURL(file);
            });
        }

        window.uploadAvatarToStorage = async (file) => {
            if (!storage || !currentUser) throw new Error("Storage or user not initialized.");
            const resizedBlob = await resizeImageToBlob(file, 256, 256);
            const storageRef = getStorageAvatarRef(file.name);
            const snapshot = await uploadBytes(storageRef, resizedBlob);
            const downloadURL = await getDownloadURL(snapshot.ref);
            return { url: downloadURL, path: snapshot.ref.fullPath, mimeType: file.type };
        };

        window.deleteAvatarFromStorage = async (storagePath) => {
            if (!storage || !storagePath) return;
            try {
                const storageRef = ref(storage, storagePath);
                await deleteObject(storageRef);
                console.log("Deleted old avatar from Storage:", storagePath);
            } catch (error) {
                if (error.code !== 'storage/object-not-found') {
                    console.warn("Failed to delete old avatar from Storage:", error);
                }
            }
        };

        // === ç”»é¢åˆ‡ã‚Šæ›¿ãˆ (v3: ãƒ«ãƒ¼ãƒ å…¥é€€å®¤ãƒ­ã‚¸ãƒƒã‚¯) ===

        // â˜… v3: ãƒ«ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        window.openRoomModal = () => {
            const modal = document.getElementById('room-list-modal');
            if (!modal) return;
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‰ã«ã€ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ ä¸€è¦§ã‚’æç”»
            window.renderRoomList();
            modal.classList.remove('hidden');
        };

        // â˜… v3: ãƒ«ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        window.closeRoomModal = (event) => {
            if (event && event.target.id !== 'room-list-modal') return;
            const modal = document.getElementById('room-list-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        };

        // â˜… v3: ãƒ«ãƒ¼ãƒ ã«å…¥å®¤ã™ã‚‹ (ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰å‘¼ã°ã‚Œã‚‹)
        window.enterRoom = async (roomId, roomName) => {
            if (!roomId || roomId === currentRoomId) {
                window.closeRoomModal();
                return;
            }
            console.log(`Entering Room: ${roomId} (${roomName})`);

            // 1. å¤ã„ãƒ«ãƒ¼ãƒ ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’åœæ­¢
            await window.exitRoom();

            // 2. æ–°ã—ã„ãƒ«ãƒ¼ãƒ IDã‚’è¨­å®š
            currentRoomId = roomId;
            currentRoomName = roomName;

            // â˜… v10 ä¿®æ­£: DBã«ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ ã‚’ä¿å­˜
            if (currentUser) {
                const userPrefRef = getUserPreferenceRef(currentUser.uid);
                if (userPrefRef) {
                    await setDoc(userPrefRef, { lastRoomId: roomId, lastRoomName: roomName }, { merge: true }).catch(e => console.warn("Failed to save room preference to DB:", e));
                }
            }
            // â˜… v10 ä¿®æ­£: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚‚æ›´æ–°ï¼ˆå³æ™‚å¾©å…ƒç”¨ï¼‰
            try {
                localStorage.setItem(LAST_ROOM_KEY, JSON.stringify({ id: roomId, name: roomName }));
            } catch (e) { console.warn("LocalStorage write failed."); }

            // 3. ãƒ«ãƒ¼ãƒ å†…ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
            currentRoomInvitedRoles = {};
            currentRoomPresence = {};
            currentRoomLogs = [];
            playedLogIds.clear();

            // 4. ãƒãƒ£ãƒƒãƒˆãƒ˜ãƒƒãƒ€ãƒ¼æ›´æ–°
            document.getElementById('chat-room-name').textContent = roomName;
            document.getElementById('dialog-log').innerHTML = '<p class="text-center text-gray-500">ãƒ«ãƒ¼ãƒ ã®ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';

            // 5. ã“ã®ãƒ«ãƒ¼ãƒ å°‚ç”¨ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’é–‹å§‹
            if (currentUser) {
                await window.startChatRoomListeners(roomId);
            }

            // â˜… v11 ä¿®æ­£: enterRoomæ™‚ã«LocalStorageã®ãƒ­ãƒ¼ãƒ«ï¼ˆDBã‹ã‚‰å¾©å…ƒã•ã‚ŒãŸå€¤ï¼‰ã‚’Presenceã«åæ˜ ã•ã›ã‚‹
            let initialRoleId = null;
            try { initialRoleId = localStorage.getItem(LAST_SPEAKER_KEY); } catch (e) { }
            if (initialRoleId && initialRoleId !== 'system_user') { // â˜… v23: system_user ã¯ RoomPresence ã«ä¿å­˜ã—ãªã„
                const roomPresenceRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', roomId, 'presence', currentUser.uid);
                await setDoc(roomPresenceRef, { selectedRole: initialRoleId }, { merge: true }).catch(e => console.warn("Failed to set initial role in room presence:", e));
            }


            // 6. ç™ºè¨€è€…ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’åˆæœŸåŒ–
            window.renderSpeakerDropdown();
            window.renderRoleManagementUI(); // å·¦ã‚«ãƒ©ãƒ ã®æ‹›å¾…çŠ¶æ…‹ã‚’æ›´æ–°

            // 7. ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            window.closeRoomModal();
        };

        // â˜… v3: ãƒ«ãƒ¼ãƒ ã‹ã‚‰é€€å®¤ã™ã‚‹ï¼ˆãƒªã‚¹ãƒŠãƒ¼åœæ­¢å‡¦ç†ï¼‰
        window.exitRoom = async () => {
            if (!currentRoomId || !currentUser) return;
            console.log(`Exiting Room: ${currentRoomId}`);

            // 1. ãƒ«ãƒ¼ãƒ å†…ãƒªã‚¹ãƒŠãƒ¼ã‚’åœæ­¢
            window.stopChatRoomListeners();

            // â˜… v12: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ«ãƒ¼ãƒ é€€å‡ºãƒ­ã‚°ã‚’æŠ•ç¨¿
            const logsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId, 'chat_logs');
            try {
                // ã“ã“ã§ã¯ addDoc ã‚’ç›´æ¥ä½¿ç”¨ï¼ˆaddNewLogToFirestoreã¯ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŒã¤ãŸã‚exitã«ã¯ä¸å‘ãï¼‰
                await addDoc(logsCollectionRef, {
                    senderId: 'system', senderName: 'ã‚·ã‚¹ãƒ†ãƒ ', text: `${currentUserName} ãŒãƒ«ãƒ¼ãƒ ã‹ã‚‰é€€å‡ºã—ã¾ã—ãŸã€‚`,
                    isRole: false, makerId: currentUser.uid, isAIGenerated: false,
                    isSystemLog: true, systemType: 'user_leave', emotion: 'standard', timestamp: serverTimestamp()
                });
            } catch (e) { console.error("Failed to post leave log:", e); }

            // 2. ã“ã®ãƒ«ãƒ¼ãƒ ã®Presenceã‹ã‚‰è‡ªåˆ†ã‚’å‰Šé™¤
            try {
                const roomPresenceRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId, 'presence', currentUser.uid);
                await deleteDoc(roomPresenceRef);
            } catch (e) { console.error("Failed to delete room presence:", e); }

            // 3. çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            currentRoomId = null;
            currentRoomName = "ãƒ«ãƒ¼ãƒ æœªå…¥å®¤";
            currentRoomInvitedRoles = {};
            currentRoomPresence = {};
            currentRoomLogs = [];
            playedLogIds.clear();

            // 4. UIã‚’æœªå…¥å®¤çŠ¶æ…‹ã«æ›´æ–°
            document.getElementById('chat-room-name').textContent = "ãƒ«ãƒ¼ãƒ æœªå…¥å®¤";
            document.getElementById('dialog-log').innerHTML = '<p class="text-center text-gray-500">ãƒ«ãƒ¼ãƒ ã«å…¥å®¤ã—ã¦ãã ã•ã„ã€‚</p>';
            window.renderActiveRoles();
            window.renderRoleManagementUI();
            window.renderSpeakerDropdown(); // ç™ºè¨€ä¸å¯çŠ¶æ…‹ã«ã™ã‚‹
        };


        // (æ—¢å­˜ã® initializeFirebase é–¢æ•°ã‚’ã“ã‚Œã§ç½®ãæ›ãˆ)
        window.initializeFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                document.getElementById('auth-overlay-content').innerHTML = '<h2 class="text-xl font-bold text-red-700 mb-4">åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼</h2><p class="text-gray-600">Firebaseã®æ¥ç¶šè¨­å®šãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«ã”é€£çµ¡ãã ã•ã„ã€‚</p>';
                document.getElementById('auth-overlay').classList.remove('hidden');
                return;
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    const presenceRef = doc(db, 'artifacts', appId, 'public', 'data', 'presence', user.uid);
                    try {
                        const docSnap = await getDoc(presenceRef);
                        currentUserName = docSnap.exists() && docSnap.data().displayName ? docSnap.data().displayName : "ã‚²ã‚¹ãƒˆ";
                    } catch (e) { currentUserName = "ã‚²ã‚¹ãƒˆ"; }
                    window.updateHeaderUserName(currentUserName);

                    await window.startGlobalListeners(); //
                    document.getElementById('auth-overlay').classList.add('hidden'); //

                    // â˜…â˜…â˜… Electroné€£æºç”¨ è¿½åŠ  â˜…â˜…â˜…
                    if (window.electronHostBridge && typeof window.electronHostBridge.getSettings === 'function') {
                        isElectronHost = true;
                        console.log("Yumemiru: Electronãƒ›ã‚¹ãƒˆç’°å¢ƒã‚’æ¤œçŸ¥ã—ã¾ã—ãŸã€‚");
                        try {
                            // Electronã‹ã‚‰è¨­å®š(AIå®šç¾©ãƒªã‚¹ãƒˆ)ã‚’èª­ã¿è¾¼ã‚€
                            const result = await window.electronHostBridge.getSettings();
                            if (result && result.settings && result.settings.aiDefinitions) {
                                const aiDefs = result.settings.aiDefinitions;
                                // [{id: 'gpt', name: 'ï¼¡ï¼©å¦¹'}, ...] ã®å½¢å¼ã§ä¿å­˜
                                electronAIList = Object.entries(aiDefs).map(([id, def]) => ({
                                    id: id,
                                    name: def.roleName || id
                                }));
                                console.log("Yumemiru: Electron AIãƒªã‚¹ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ:", electronAIList);

                                // â˜… Discordã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒªãƒƒã‚¹ãƒ³
                                window.electronHostBridge.onDiscordMessage((msg) => {
                                    console.log("Yumemiru: Discordã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡:", msg);
                                    // (Discordãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã«è¿½åŠ ã™ã‚‹å‡¦ç†)
                                    window.addDiscordLogToFirestore(msg.author, msg.content);
                                });

                                // â˜… AIãƒ¯ãƒ¼ã‚«ãƒ¼ã‹ã‚‰ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ãª(æœªè¦æ±‚ã®)å¿œç­”ã‚’ãƒªãƒƒã‚¹ãƒ³
                                // (ä»Šå›ã¯ä½¿ã‚ãªã„ãŒã€å°†æ¥ã®ãŸã‚ã«å®šç¾©)
                                window.electronHostBridge.onAIResponse((msg) => {
                                    console.log(`Yumemiru: Electron AI (${msg.source}) ã‹ã‚‰ã‚°ãƒ­ãƒ¼ãƒãƒ«å¿œç­”ã‚’å—ä¿¡:`, msg.text);
                                });
                            }
                        } catch (e) {
                            console.error("Yumemiru: Electronè¨­å®šã®ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—:", e);
                        }
                    } else {
                        console.log("Yumemiru: ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³Webç’°å¢ƒã§å®Ÿè¡Œã—ã¾ã™ã€‚");
                    }
                    // â˜…â˜…â˜… ã“ã“ã¾ã§ â˜…â˜…â˜…

                    let targetRoomId = null;
                    let targetRoomName = null;
                    let targetRoleId = null;

                    try {
                        const userPrefRef = getUserPreferenceRef(user.uid); //
                        if (userPrefRef) {
                            const prefSnap = await getDoc(userPrefRef); //
                            if (prefSnap.exists()) {
                                const prefData = prefSnap.data(); //
                                targetRoomId = prefData.lastRoomId || null; //
                                targetRoomName = prefData.lastRoomName || null; //
                                targetRoleId = prefData.lastRoleId || null; //
                            }
                        }
                    } catch (e) {
                        console.warn("Firestore user preference read failed:", e);
                    }

                    if (targetRoleId) {
                        try {
                            if (targetRoleId === 'system_user' || roles.find(r => r.id === targetRoleId && r.makerId === user.uid)) { //
                                localStorage.setItem(LAST_SPEAKER_KEY, targetRoleId); //
                            } else {
                                localStorage.setItem(LAST_SPEAKER_KEY, 'system_user'); //
                            }
                        } catch (e) { console.warn("LocalStorage write failed for speaker key."); }
                    } else {
                        try {
                            localStorage.setItem(LAST_SPEAKER_KEY, 'system_user'); //
                        } catch (e) { }
                    }

                    if (targetRoomId && targetRoomName) {
                        const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', targetRoomId); //
                        const roomSnap = await getDoc(roomRef); //
                        if (roomSnap.exists()) { //
                            await window.enterRoom(targetRoomId, targetRoomName); //
                        } else {
                            if (currentUser) {
                                const userPrefRef = getUserPreferenceRef(currentUser.uid); //
                                if (userPrefRef) {
                                    await setDoc(userPrefRef, { lastRoomId: null, lastRoomName: null }, { merge: true }).catch(e => console.warn("Failed to clear DB room preference:", e)); //
                                }
                            }
                            window.openRoomModal(); //
                        }
                    } else {
                        window.openRoomModal(); //
                    }

                    document.getElementById('app-shell').addEventListener('click', window.getAudioContext, { once: true }); //

                } else {
                    currentUser = null; //
                    currentUserName = "æœªãƒ­ã‚°ã‚¤ãƒ³"; //
                    window.updateHeaderUserName(currentUserName); //
                    await window.exitRoom(); //
                    window.stopAllListeners(); //
                    
                    // â˜… ä¿®æ­£: ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ï¼ˆuserãŒnullã®å ´åˆï¼‰ã€ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ãŸçŠ¶æ…‹ã«æˆ»ã™
                    const authContent = document.getElementById('auth-overlay-content');
                    authContent.innerHTML = `
                        <h2 class="text-2xl font-bold text-indigo-700 mb-4 title-font">ãƒ¦ãƒ¡ãƒŸãƒ«ã¸ã‚ˆã†ã“ã</h2>
                        <p class="text-gray-600 mb-6">ãƒ­ã‚°ã‚¤ãƒ³æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
                        <div class="space-y-3">
                            <button onclick="window.signInWithGoogle()" class="w-full flex items-center justify-center px-4 py-2 border border-gray-300 rounded-lg shadow-sm bg-white text-gray-700 hover:bg-gray-50 transition">
                                <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                                Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³
                            </button>
                            <button onclick="window.signInAsGuest()" class="w-full px-4 py-2 border border-transparent rounded-lg shadow-sm bg-gray-600 text-white hover:bg-gray-700 transition">
                                åŒ¿åã§ç¶šã‘ã‚‹ (ã‚²ã‚¹ãƒˆ)
                            </button>
                        </div>
                    `;
                    document.getElementById('auth-overlay').classList.remove('hidden'); //
                    document.getElementById('auth-overlay').addEventListener('click', window.getAudioContext, { once: true }); //
                }
            });

            // â˜… ä¿®æ­£: è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã®å¤‰æ›´
            if (initialAuthToken) { //
                try { 
                    await signInWithCustomToken(auth, initialAuthToken); 
                    // æˆåŠŸã™ã‚Œã° onAuthStateChanged ãŒ user ã‚’æŒã£ã¦ç™ºç«ã™ã‚‹
                } //
                catch (error) { 
                    // ãƒˆãƒ¼ã‚¯ãƒ³ãŒä¸æ­£ãªã‚‰ã€æ‰‹å‹•ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤ºï¼ˆè‡ªå‹•ã§åŒ¿åãƒ­ã‚°ã‚¤ãƒ³ã—ãªã„ï¼‰
                    console.error("Custom token sign in failed:", error);
                    // onAuthStateChanged ãŒ user=null ã§ç™ºç«ã—ã€ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹
                } //
            } else {
                // initialAuthToken ãŒãªã„å ´åˆã€è‡ªå‹•ã§åŒ¿åãƒ­ã‚°ã‚¤ãƒ³ã¯è¡Œã‚ãªã„ã€‚
                // onAuthStateChanged ãŒ user=null ã§ç™ºç«ã—ã€ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹
            }
        };

        // â˜…â˜…â˜… æ–°è¦è¿½åŠ : Googleãƒ­ã‚°ã‚¤ãƒ³å‡¦ç† â˜…â˜…â˜…
        window.signInWithGoogle = async () => {
            if (!auth) return;
            const provider = new GoogleAuthProvider();
            try {
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã«å¤‰æ›´
                const authContent = document.getElementById('auth-overlay-content');
                authContent.innerHTML = `
                    <h2 class="text-xl font-bold text-indigo-700 mb-4">Googleã«æ¥ç¶šä¸­...</h2>
                    <div class="flex justify-center items-center space-x-2">
                        <div class="loading-dot w-3 h-3 bg-indigo-500 rounded-full"></div>
                        <div class="loading-dot w-3 h-3 bg-indigo-500 rounded-full"></div>
                        <div class="loading-dot w-3 h-3 bg-indigo-500 rounded-full"></div>
                    </div>
                `;
                await signInWithPopup(auth, provider);
                // æˆåŠŸã™ã‚‹ã¨ onAuthStateChanged ãŒç™ºç«ã—ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒéè¡¨ç¤ºã«ãªã‚‹
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
                const authContent = document.getElementById('auth-overlay-content');
                authContent.innerHTML = `
                    <h2 class="text-xl font-bold text-red-700 mb-4">ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼</h2>
                    <p class="text-gray-600 mb-6">${error.message}</p>
                    <button onclick="window.location.reload()" class="w-full px-4 py-2 border border-transparent rounded-lg shadow-sm bg-gray-600 text-white hover:bg-gray-700 transition">
                        ãƒªãƒˆãƒ©ã‚¤
                    </button>
                `;
            }
        };

        // â˜…â˜…â˜… æ–°è¦è¿½åŠ : åŒ¿åãƒ­ã‚°ã‚¤ãƒ³å‡¦ç† â˜…â˜…â˜…
        window.signInAsGuest = async () => {
            if (!auth) return;
            try {
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã«å¤‰æ›´
                const authContent = document.getElementById('auth-overlay-content');
                authContent.innerHTML = `
                    <h2 class="text-xl font-bold text-indigo-700 mb-4">ã‚²ã‚¹ãƒˆã¨ã—ã¦æ¥ç¶šä¸­...</h2>
                    <div class="flex justify-center items-center space-x-2">
                        <div class="loading-dot w-3 h-3 bg-indigo-500 rounded-full"></div>
                        <div class="loading-dot w-3 h-3 bg-indigo-500 rounded-full"></div>
                        <div class="loading-dot w-3 h-3 bg-indigo-500 rounded-full"></div>
                    </div>
                `;
                await signInAnonymously(auth);
                // æˆåŠŸã™ã‚‹ã¨ onAuthStateChanged ãŒç™ºç«ã—ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒéè¡¨ç¤ºã«ãªã‚‹
            } catch (error) {
                console.error("Anonymous Sign-In Error:", error);
                // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
                const authContent = document.getElementById('auth-overlay-content');
                authContent.innerHTML = `
                    <h2 class="text-xl font-bold text-red-700 mb-4">ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼</h2>
                    <p class="text-gray-600 mb-6">${error.message}</p>
                    <button onclick="window.location.reload()" class="w-full px-4 py-2 border border-transparent rounded-lg shadow-sm bg-gray-600 text-white hover:bg-gray-700 transition">
                        ãƒªãƒˆãƒ©ã‚¤
                    </button>
                `;
            }
        };


        // ãƒ¦ãƒ¼ã‚¶ãƒ¼åå¤‰æ›´ (å¤‰æ›´ãªã—)
        window.updateUserName = () => {
            if (!currentUser) return;
            const modal = document.getElementById('name-editor-modal');
            const input = document.getElementById('new-name-input');
            if (currentUserName === "ã‚²ã‚¹ãƒˆ") {
                input.value = ''; input.placeholder = 'æ–°ã—ã„åå‰ã‚’å…¥åŠ›...';
            } else {
                input.value = currentUserName; input.placeholder = '';
            }
            modal.classList.remove('hidden');
            setTimeout(() => input.focus(), 100);
        };
        window.closeNameEditor = (event) => {
            if (!event || event.target.id === 'name-editor-modal') {
                document.getElementById('name-editor-modal').classList.add('hidden');
            }
        };
        window.submitNewName = async () => {
            if (!currentUser) return;
            const newName = document.getElementById('new-name-input').value.trim();
            if (!newName || newName === currentUserName) {
                window.closeNameEditor(); return;
            }
            window.toggleUI(true, 'ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’æ›´æ–°ä¸­...');
            const presenceRef = doc(db, 'artifacts', appId, 'public', 'data', 'presence', currentUser.uid);
            try {
                const batch = writeBatch(db);
                batch.set(presenceRef, { displayName: newName }, { merge: true });
                const rolesRef = collection(db, 'artifacts', appId, 'public', 'data', 'roles');
                const q = query(rolesRef, where("makerId", "==", currentUser.uid));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach((doc) => {
                    batch.update(doc.ref, { makerDisplayName: newName });
                });
                await batch.commit();
                currentUserName = newName;
                window.updateHeaderUserName(newName);
                window.displayTemporaryMessage("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’æ›´æ–°ã—ã¾ã—ãŸï¼");
                window.closeNameEditor();
            } catch (error) {
                console.error("Error updating user name or roles:", error);
                window.displayTemporaryMessage("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
            } finally {
                window.toggleUI(false);
            }
        };
        window.updateHeaderUserName = (name) => {
            const userNames = document.querySelectorAll('.user-display-name');
            userNames.forEach(el => el.textContent = name);
            // const guideName = document.getElementById('welcome-guide-username'); // â˜… v23: å‰Šé™¤
            // if (guideName) { guideName.textContent = name; } // â˜… v23: å‰Šé™¤
        };

        // â˜… v3: ãƒ­ãƒ¼ãƒ«é¸æŠæ›´æ–° (ãƒ«ãƒ¼ãƒ å†…)
        window.updateSelectedRole = async (newRoleId) => {
            if (!auth.currentUser) return; // â˜… v23: ãƒ«ãƒ¼ãƒ å…¥å®¤ä¸­ã‹ã©ã†ã‹ã¯å•ã‚ãªã„
            const uid = auth.currentUser.uid;

            // â˜… v23: system_user ã¯ RoomPresence ã«ä¿å­˜ã—ãªã„
            if (currentRoomId && newRoleId !== 'system_user') {
                const userRoomPresenceRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId, 'presence', uid);
                await setDoc(userRoomPresenceRef, {
                    selectedRole: newRoleId
                }, { merge: true }).catch(e => console.error("Error updating selected role:", e));
            }

            // â˜… v10 ä¿®æ­£: DBã«é¸æŠãƒ­ãƒ¼ãƒ«ã‚’ä¿å­˜ (system_user ã‚‚ä¿å­˜)
            const userPrefRef = getUserPreferenceRef(uid);
            if (userPrefRef) {
                await setDoc(userPrefRef, { lastRoleId: newRoleId }, { merge: true }).catch(e => console.warn("Failed to save role preference to DB:", e));
            }
        };

        // === Core Data Listeners (v3: æ§‹é€ è¦‹ç›´ã—) ===
        window.stopAllListeners = () => {
            if (globalRolesListener) globalRolesListener();
            if (globalPresenceListener) globalPresenceListener();
            if (roomsListener) roomsListener();
            window.stopChatRoomListeners();
        };

        window.startGlobalListeners = async () => {
            if (!currentUser) return;
            window.stopAllListeners(); // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’å…¨ã¦åœæ­¢

            // 1. ã‚°ãƒ­ãƒ¼ãƒãƒ«Presence (è‡ªåˆ†ãŒã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§ã‚ã‚‹ã“ã¨ã‚’é€šçŸ¥)
            const globalPresenceRef = doc(db, 'artifacts', appId, 'public', 'data', 'presence', currentUser.uid);
            const updateData = {
                uid: currentUser.uid,
                online: true,
                lastSeen: serverTimestamp(),
                displayName: currentUserName !== "ã‚²ã‚¹ãƒˆ" ? currentUserName : "ã‚²ã‚¹ãƒˆ"
            };
            await setDoc(globalPresenceRef, updateData, { merge: true });
            window.addEventListener('beforeunload', () => {
                if (auth.currentUser) {
                    setDoc(globalPresenceRef, { online: false, lastSeen: serverTimestamp() }, { merge: true });
                    window.exitRoom(); // â˜… v3: ã‚¿ãƒ–é–‰ã˜ã‚‹ã¨ãã«ãƒ«ãƒ¼ãƒ ã‹ã‚‰ã‚‚é€€å‡º
                }
            });

            // 2. ã‚°ãƒ­ãƒ¼ãƒãƒ«Presenceä¸€è¦§ (å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ -> usersOnline)
            globalPresenceListener = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'presence'), (snapshot) => {
                usersOnline = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const cutoff = Date.now() - 5 * 60 * 1000; // 5åˆ†
                    if (data.online || (data.lastSeen && data.lastSeen.toMillis() > cutoff)) {
                        usersOnline[doc.id] = data;
                    }
                });
                // ç¾åœ¨ã®ãƒ“ãƒ¥ãƒ¼ã«å¿œã˜ã¦å†æç”»
                if (currentRoomId) {
                    window.renderActiveRoles();
                    window.renderRoleManagementUI();
                }
            }, (error) => console.error("Error fetching global presence:", error));

            // 3. ã‚°ãƒ­ãƒ¼ãƒãƒ«Roles (å…¨ãƒ­ãƒ¼ãƒ«å®šç¾© -> roles)
            globalRolesListener = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'roles'), (snapshot) => {
                roles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // ç¾åœ¨ã®ãƒ“ãƒ¥ãƒ¼ã«å¿œã˜ã¦å†æç”»
                window.renderRoleManagementUI(); // å·¦ã‚«ãƒ©ãƒ  (å…¥å®¤ä¸­ã§ã‚‚ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ã‚‚)
                window.renderSpeakerDropdown(); // ãƒãƒ£ãƒƒãƒˆå…¥åŠ›æ¬„ (å…¥å®¤ä¸­ã®ã¿)
                if (currentRoomId) {
                    window.renderActiveRoles(); // ãƒ˜ãƒƒãƒ€ãƒ¼
                }
                // â˜… v23: showWelcomeMessageIfNew ã¯ roles ã‚’å‚ç…§ã—ãªããªã£ãŸãŸã‚ã€å‘¼ã³å‡ºã—ã‚’ç§»å‹•
                setTimeout(window.showWelcomeMessageIfNew, 500);
            }, (error) => console.error("Error fetching global roles:", error));

            // 4. ãƒ«ãƒ¼ãƒ ä¸€è¦§ (rooms) -> ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§å¸¸æ™‚ç›£è¦–
            roomsListener = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'rooms'), orderBy('createdAt', 'desc')), (snapshot) => {
                rooms = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã®ã¿å†æç”»
                if (!document.getElementById('room-list-modal').classList.contains('hidden')) {
                    window.renderRoomList();
                }
            }, (error) => console.error("Error fetching rooms:", error));
        };

        window.stopChatRoomListeners = () => {
            if (chatLogsListener) chatLogsListener();
            if (roomInvitesListener) roomInvitesListener();
            if (roomPresenceListener) roomPresenceListener();
            if (mainIntervalTimer) clearInterval(mainIntervalTimer);

            chatLogsListener = null;
            roomInvitesListener = null;
            roomPresenceListener = null;
            mainIntervalTimer = null;
        };

        window.startChatRoomListeners = async (roomId) => {
            if (!currentUser || !roomId) return;
            window.stopChatRoomListeners(); // æ—¢å­˜ã®ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒŠãƒ¼ã‚’åœæ­¢

            // 1. ãƒ«ãƒ¼ãƒ å†…Presence (è‡ªåˆ†ãŒã“ã®ãƒ«ãƒ¼ãƒ ã«ã„ã‚‹ã“ã¨ã‚’é€šçŸ¥)
            const roomPresenceRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', roomId, 'presence', currentUser.uid);
            const myGlobalPresence = usersOnline[currentUser.uid] || { displayName: currentUserName };

            // â˜… v4: æœ€å¾Œã«é¸æŠã—ãŸãƒ­ãƒ¼ãƒ«ã‚’LocalStorageã‹ã‚‰èª­ã¿è¾¼ã‚€ (DBä¿å­˜å„ªå…ˆã®ãŸã‚ã€ã“ã“ã§ã¯Localã®å€¤ã‚’ç›´æ¥ä½¿ã‚ãªã„)
            let mySelectedRole = "";
            try {
                // LocalStorageã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆã“ã‚Œã¯DBã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã‚ˆã‚Šå„ªå…ˆé †ä½ãŒä½ã„ãŒã€ã“ã“ã§ã¯ä¸€æ™‚çš„ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ä½¿ã†ï¼‰
                mySelectedRole = localStorage.getItem(LAST_SPEAKER_KEY) || "";
            } catch (e) { console.warn("LocalStorage read failed for speaker key."); }

            // â˜… v23: system_user ã ã£ãŸå ´åˆã¯ã€è‡ªåˆ†ã®æœ€åˆã®ãƒ­ãƒ¼ãƒ«ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã™ã‚‹
            if (mySelectedRole === 'system_user') {
                mySelectedRole = "";
            }

            // è‡ªåˆ†ã®ãƒ­ãƒ¼ãƒ«ã§ãªã„ã€ã¾ãŸã¯å­˜åœ¨ã—ãªã„IDã®å ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            if (!mySelectedRole || !roles.find(r => r.id === mySelectedRole && r.makerId === currentUser.uid)) {
                mySelectedRole = roles.find(r => r.makerId === currentUser.uid)?.id || "";
            }

            // â˜… v23: ã“ã“ã§ system_user ãŒ Presence ã«ä¿å­˜ã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹
            // mySelectedRole ãŒç©ºï¼ˆè‡ªåˆ†ã®ãƒ­ãƒ¼ãƒ«ãŒãªã„ï¼‰ã®å ´åˆã€ç©ºãŒä¿å­˜ã•ã‚Œã‚‹
            await setDoc(roomPresenceRef, {
                uid: currentUser.uid,
                displayName: myGlobalPresence.displayName,
                lastSeen: serverTimestamp(),
                selectedRole: mySelectedRole // ãƒ«ãƒ¼ãƒ å…¥å®¤æ™‚ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠ
            }, { merge: true });

            // â˜… v12: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ«ãƒ¼ãƒ å‚åŠ ãƒ­ã‚°ã‚’æŠ•ç¨¿
            await window.addNewLogToFirestore({
                senderId: 'system', senderName: 'ã‚·ã‚¹ãƒ†ãƒ ', text: `${currentUserName} ãŒãƒ«ãƒ¼ãƒ ã«å‚åŠ ã—ã¾ã—ãŸã€‚`,
                isRole: false, makerId: currentUser.uid, isAIGenerated: false,
                isSystemLog: true, systemType: 'user_join', emotion: 'standard', timestamp: serverTimestamp()
            });

            // 2. ãƒ«ãƒ¼ãƒ å†…Presenceä¸€è¦§ (currentRoomPresence)
            roomPresenceListener = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'rooms', roomId, 'presence'), (snapshot) => {
                currentRoomPresence = {};
                snapshot.forEach(doc => {
                    currentRoomPresence[doc.id] = doc.data();
                });
                window.checkAIAssignment();
            }, (error) => console.error("Error fetching room presence:", error));

            // 3. ãƒ«ãƒ¼ãƒ å†…æ‹›å¾…ãƒ­ãƒ¼ãƒ«ä¸€è¦§ (currentRoomInvitedRoles)
            roomInvitesListener = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'rooms', roomId, 'invited_roles'), (snapshot) => {
                currentRoomInvitedRoles = {};
                snapshot.forEach(doc => {
                    currentRoomInvitedRoles[doc.id] = doc.data();
                });
                window.renderActiveRoles();
                window.renderRoleManagementUI();
                window.checkAIAssignment();
            }, (error) => console.error("Error fetching room invites:", error));

            // 4. ãƒãƒ£ãƒƒãƒˆãƒ­ã‚° (currentRoomLogs)
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'rooms', roomId, 'chat_logs'), orderBy('timestamp', 'desc'), limit(50));
            let isFirstLoad = true;
            chatLogsListener = onSnapshot(q, (snapshot) => {
                currentRoomLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).reverse();
                window.renderChatLogs(currentRoomLogs);
                window.clearSummaryCache(currentRoomLogs[currentRoomLogs.length - 1]?.id);

                if (isFirstLoad) {
                    currentRoomLogs.forEach(log => { if (log.text) playedLogIds.add(log.id); });
                    isFirstLoad = false;
                }

                if (isAutoTTS_Enabled && document.visibilityState === 'visible') {
                    const newLogs = currentRoomLogs.filter(log =>
                        log.text && !playedLogIds.has(log.id) && !(log.makerId === currentUser.uid && !log.isAIGenerated)
                    );
                    newLogs.forEach(log => { window.playTTS(log.senderId, log.text, log.id); });
                }

                // â˜… v6: ãƒ­ã‚°ãŒè¿½åŠ ã•ã‚ŒãŸã‚‰ã€å¸¸ã«AIå¿œç­”ãƒã‚§ãƒƒã‚¯ã‚’ãƒˆãƒªã‚¬ãƒ¼
                window.checkAIAssignment();

                // ä»¥å‰ã®ãƒ­ã‚¸ãƒƒã‚¯ (å‰Šé™¤)
                // const lastLog = currentRoomLogs[currentRoomLogs.length - 1];
                // if (lastLog && !lastLog.isAIGenerated && lastLog.makerId === currentUser.uid) {
                //     window.checkAIAssignment(lastLog.text);
                // }
            }, (error) => console.error("Error fetching chat logs:", error));

            // 5. å®šæœŸå®Ÿè¡Œã‚¿ã‚¹ã‚¯ (è¨˜æ†¶æ›´æ–° / è‡ªç™ºçš„ç™ºè¨€)
            lastMemoryUpdateTime = 0; // åˆå›ã¯ã™ãæ›´æ–°ã‚’è©¦ã¿ã‚‹
            // â˜… v12: åˆå›ãƒã‚§ãƒƒã‚¯æ™‚åˆ»ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«è¨­å®š (3~30ç§’)
            nextSpontaneousCheckTime = Date.now() + (Math.random() * (30000 - 3000) + 3000);
            lastChatLogIdForMemory = null;
            mainIntervalTimer = setInterval(() => window.runPeriodicTasks(roomId), 10 * 1000); // 10ç§’é–“éš”ã§ã‚¿ã‚¹ã‚¯ãƒã‚§ãƒƒã‚¯
        };


        // === å®šæœŸå®Ÿè¡Œã‚¿ã‚¹ã‚¯ (v12: æ–°è¦ãƒ»ãƒªãƒ•ã‚¡ã‚¯ã‚¿) ===
        window.runPeriodicTasks = async (roomId) => {
            // â˜… v22: ãƒ­ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯ã‚’ä¸¡æ–¹ã®ãƒ•ãƒ©ã‚°ã«å¯¾å¿œ
            if (isUpdatingMemory || isAIPosting_Response || isAIPosting_Spontaneous || !currentRoomId || roomId !== currentRoomId) {
                console.log("Periodic tasks skipped (busy or not in room).");
                return;
            }

            const now = Date.now();

            // 1. è¨˜æ†¶ã®è‡ªå‹•æ›´æ–° (10åˆ†ã”ã¨)
            const memoryUpdateInterval = 10 * 60 * 1000; // 10åˆ†
            if (now - lastMemoryUpdateTime > memoryUpdateInterval) {
                isUpdatingMemory = true;
                console.log("Periodic task: Starting automatic memory update...");
                try {
                    await window.updateAllRoleMemories(roomId);
                    lastMemoryUpdateTime = now;
                    console.log("Periodic task: Memory update complete.");
                } catch (error) {
                    console.error("Periodic memory update failed:", error);
                } finally {
                    isUpdatingMemory = false;
                }
            }

            // 2. AIã®è‡ªç™ºçš„ç™ºè¨€ (ãƒˆã‚°ãƒ«ON & æ™‚é–“çµŒé)
            if (isSpontaneousSpeech_Enabled && now > nextSpontaneousCheckTime) {
                console.log("Periodic task: Checking for spontaneous speech...");
                // checkAIAssignment ãŒ isAIPosting ã®ãƒ­ãƒƒã‚¯ã‚’å–å¾—ã™ã‚‹ãŸã‚ã€
                // ã“ã“ã§ã¯ç›´æ¥å‘¼ã³å‡ºã•ãšã€checkSpontaneousSpeech ã‚’ä»‹ã—ã¦
                // AIãƒ­ãƒƒã‚¯ï¼ˆisAIPosting_Spontaneousï¼‰ã‚’å–å¾—ã•ã›ã‚‹
                await window.checkSpontaneousSpeech(roomId);

                // æ¬¡ã®ãƒã‚§ãƒƒã‚¯æ™‚åˆ»ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«è¨­å®š (30ç§’ã‹ã‚‰5åˆ†å¾Œ)
                nextSpontaneousCheckTime = now + (Math.random() * (300000 - 30000) + 30000);
                console.log(`Periodic task: Next spontaneous speech check at ${new Date(nextSpontaneousCheckTime).toLocaleTimeString()}`);
            }
        };

        window.updateAllRoleMemories = async (roomId) => {
            if (!roomId) return;

            // ã“ã®ãƒ«ãƒ¼ãƒ ã«æ‹›å¾…ã•ã‚Œã¦ã„ã‚‹ã€è£½ä½œè€…ãŒã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã®ãƒ­ãƒ¼ãƒ«ã®ã¿ã‚’å¯¾è±¡
            const targetRoles = roles.filter(role =>
                currentRoomInvitedRoles[role.id] && usersOnline[role.makerId]
            );

            if (targetRoles.length === 0) {
                console.log("Memory update: No active roles to update.");
                return;
            }

            // ç›´è¿‘ã®ãƒ­ã‚°ã‚’å–å¾—
            const logsRef = collection(db, 'artifacts', appId, 'public', 'data', 'rooms', roomId, 'chat_logs');
            const q = query(logsRef, orderBy('timestamp', 'desc'), limit(10));
            const snapshot = await getDocs(q);
            const chatHistory = snapshot.docs.map(doc => doc.data()).reverse();

            if (chatHistory.length === 0) {
                console.log("Memory update: No recent chat logs.");
                return;
            }

            // æœ€å¾Œã«æ›´æ–°ã—ãŸãƒ­ã‚°IDä»¥é™ã®ãƒ­ã‚°ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            // â˜… v19 ä¿®æ­£: chatHistoryãŒç©ºã§ãªã„ã“ã¨ã‚’ç¢ºèªã—ã¦ã‹ã‚‰IDã‚’å–å¾—
            const lastLogId = chatHistory.length > 0 ? snapshot.docs[0].id : null; // æœ€æ–°ã®ãƒ­ã‚°ID
            if (!lastLogId || lastLogId === lastChatLogIdForMemory) {
                console.log("Memory update: No new logs since last update.");
                return;
            }

            const historyText = chatHistory.map(log => `${log.senderName}: ${log.text}`).join('\n');
            const memoryPrompt = `ä»¥ä¸‹ã®ä¼šè©±å±¥æ­´ã‚’èª­ã¿ã€ãƒ­ãƒ¼ãƒ«ãŒè¦šãˆã¦ãŠãã¹ãé‡è¦ãªæƒ…å ±ï¼ˆé–¢ä¿‚æ€§ã€å¥½ããªã‚‚ã®ã€å½¹å‰²ãªã©ï¼‰ã‚’ç°¡æ½”ãªç®‡æ¡æ›¸ãã®ã€Œè¨˜æ†¶ã€ã¨ã—ã¦æ—¥æœ¬èªã§è¦ç´„ã—ã¦ãã ã•ã„ã€‚:\n\n${historyText}`;

            let newMemory = "";
            try {
                const summaryResponse = await window.callGeminiAPI(null, [{ role: 'user', parts: [{ text: memoryPrompt }] }]);
                newMemory = summaryResponse.text.trim();
            } catch (e) {
                console.error("Memory update: Failed to generate summary:", e);
                return;
            }

            if (!newMemory) {
                console.log("Memory update: Generated memory was empty.");
                return;
            }

            // å¯¾è±¡ãƒ­ãƒ¼ãƒ«ã®è¨˜æ†¶ã‚’ä¸€æ‹¬æ›´æ–°
            try {
                const batch = writeBatch(db);
                for (const role of targetRoles) {
                    const roleRef = doc(db, 'artifacts', appId, 'public', 'data', 'roles', role.id);
                    batch.update(roleRef, { memory: newMemory });
                }
                await batch.commit();
                lastChatLogIdForMemory = lastLogId; // æ›´æ–°ãŒæˆåŠŸã—ãŸã®ã§ã€æœ€æ–°ã®ãƒ­ã‚°IDã‚’è¨˜éŒ²
                console.log(`Memory update: Updated memory for ${targetRoles.length} roles.`);
            } catch (e) {
                console.error("Memory update: Batch update failed:", e);
            }
        };

        window.checkSpontaneousSpeech = async (roomId) => {
            // â˜… v22: è‡ªå‹•ç™ºè©±ç”¨ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ­ãƒƒã‚¯ã‚’ä½¿ç”¨
            if (isAIPosting_Spontaneous || !currentRoomId || roomId !== currentRoomId) return;

            // â˜… v22: ã‚°ãƒ­ãƒ¼ãƒãƒ«AIãƒ­ãƒƒã‚¯ (è‡ªå‹•ç™ºè©±ç”¨)
            const aiStateRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId, 'state', 'aiState_Spontaneous'); // â˜… v22 å¤‰æ›´
            let canProceed = false;
            try {
                await runTransaction(db, async (transaction) => {
                    const aiStateDoc = await transaction.get(aiStateRef);
                    const stateData = aiStateDoc.data();
                    const now = Date.now();
                    const lockTimeout = 30 * 1000; // 30ç§’
                    const isLocked = stateData?.isPosting && stateData.timestamp && (now - stateData.timestamp.toMillis() < lockTimeout);
                    if (isLocked) {
                        console.log("Spontaneous speech skipped: Global Spontaneous AI lock is active."); // â˜… v22 å¤‰æ›´
                        canProceed = false;
                    } else {
                        console.log("Spontaneous speech: Acquired global Spontaneous AI lock."); // â˜… v22 å¤‰æ›´
                        transaction.set(aiStateRef, { isPosting: true, timestamp: serverTimestamp() });
                        canProceed = true;
                    }
                });
            } catch (error) {
                // â˜… v24: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç«¶åˆã¯æœŸå¾…ã•ã‚Œã‚‹å¤±æ•—ã€‚ãƒ­ã‚°ã‚’ç°¡ç´ åŒ–ã—ã€ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡ã‚’ç¶­æŒã€‚
                console.log("Spontaneous speech Lock Transaction failed (concurrency or timeout). Reason:", error.message || error);
                canProceed = false;
            }

            if (!canProceed) return;

            isAIPosting_Spontaneous = true; // â˜… v22: è‡ªå‹•ç™ºè©±ç”¨ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ­ãƒƒã‚¯
            let didRespond = false;

            try {
                // ãƒ­ã‚°ã‚’å–å¾—ã—ã¦ã€æœ€å¾Œã®ç™ºè¨€ã‹ã‚‰æ™‚é–“ãŒçµŒã£ã¦ã„ã‚‹ã‹ç¢ºèª
                const logsRef = collection(db, 'artifacts', appId, 'public', 'data', 'rooms', roomId, 'chat_logs');
                // â˜… v22: é€£ç¶šç™ºè¨€ãƒã‚§ãƒƒã‚¯ã®ãŸã‚ limit(3)
                const q = query(logsRef, orderBy('timestamp', 'desc'), limit(3));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    console.log("Spontaneous speech: No logs, skipping.");
                    return; // ãƒ­ã‚°ãŒãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
                }

                const logs = snapshot.docs.map(doc => doc.data());
                const lastLog = logs[0];

                // â˜… v22: 3å›é€£ç¶šç™ºè¨€ãƒã‚§ãƒƒã‚¯ (v21ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’æµç”¨)
                if (logs.length >= 3 &&
                    lastLog.isAIGenerated && logs[1].isAIGenerated && logs[2].isAIGenerated &&
                    lastLog.senderId === logs[1].senderId &&
                    lastLog.senderId === logs[2].senderId) {
                    console.log(`Spontaneous speech skipped: Same AI role (${lastLog.senderName}) responded 3 times consecutively.`);
                    return;
                }

                // â˜… v22: ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                // if (lastLog.isSystemLog) {
                //     console.log("Spontaneous speech skipped: Last log was a system message.");
                //     return;
                // }

                const lastLogTime = lastLog.timestamp?.toMillis() || 0;
                const silenceDuration = Date.now() - lastLogTime;

                // æœ€å¾Œã®ç™ºè¨€ã‹ã‚‰3ç§’ä»¥ä¸ŠçµŒéã—ã¦ã„ã‚‹ã‹
                if (silenceDuration < 3 * 1000) {
                    console.log(`Spontaneous speech: Skipped, not enough silence (${Math.round(silenceDuration / 1000)}s).`);
                    return;
                }

                // å¿œç­”è³‡æ ¼ã®ã‚ã‚‹AIï¼ˆæ‹›å¾…æ¸ˆã¿ã€AIæ“ä½œä¸­ã€è£½ä½œè€…ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼‰
                const selectedRoleIdsInThisRoom = Object.values(currentRoomPresence).map(p => p.selectedRole);
                let eligibleRoles = roles.filter(role => {
                    const isInvited = currentRoomInvitedRoles[role.id];
                    const isNotLastSpeaker = role.id !== lastLog.senderId; // è‡ªåˆ†ãŒæœ€å¾Œã§ãªã„
                    const isNotSelected = !selectedRoleIdsInThisRoom.includes(role.id);
                    // â˜… v19 ä¿®æ­£: è£½ä½œè€…ãŒã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚è‡ªç™ºçš„ç™ºè¨€ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ (v14ã®ä¿®æ­£æ¼ã‚Œ)
                    // const isMakerOnline = usersOnline[role.makerId]; // è£½ä½œè€…ãŒã‚ªãƒ³ãƒ©ã‚¤ãƒ³
                    return isInvited && isNotLastSpeaker && isNotSelected; // && isMakerOnline;
                });

                if (eligibleRoles.length === 0) {
                    console.log("Spontaneous speech: No eligible roles to speak.");
                    return;
                }

                // èª°ãŒè©±ã™ã‹ãƒ©ãƒ³ãƒ€ãƒ ã«1äººé¸ã¶
                const targetRole = eligibleRoles[Math.floor(Math.random() * eligibleRoles.length)];

                // ç›´è¿‘10ä»¶ã®ãƒ­ã‚°ã‚’å–å¾—ï¼ˆgenerateRoleResponseã®ãŸã‚ï¼‰
                const qLogs = query(logsRef, orderBy('timestamp', 'desc'), limit(10)); // ã“ã‚Œã¯åˆ¥ã‚¯ã‚¨ãƒª
                const logsSnapshot = await getDocs(qLogs);
                const chatHistory = logsSnapshot.docs.map(doc => doc.data()).reverse();

                console.log(`Spontaneous speech: Generating response for ${targetRole.name}...`);

                // generateRoleResponse ã‚’å‘¼ã³å‡ºã™
                // â€» generateRoleResponse ã¯å†…éƒ¨ã§ isAIPosting ã‚’ false ã«ã™ã‚‹ãŒã€
                // cleanupAIAssignment ã‚’å‘¼ã¶ã®ã¯ã“ã®é–¢æ•°ã® finally ãƒ–ãƒ­ãƒƒã‚¯
                await window.generateRoleResponse(targetRole, chatHistory, lastLog);
                didRespond = true;

            } catch (error) {
                console.error("Error during spontaneous speech:", error);
            } finally {
                // â˜… v22: å¿œç­”ãŒã‚ã£ãŸå ´åˆã¯ cleanupSpontaneousSpeech ã‚’å‘¼ã¶
                window.cleanupSpontaneousSpeech(didRespond); // â˜… v22 å¤‰æ›´
            }
        };

        // â˜… v22: æ–°è¨­ (è‡ªå‹•ç™ºè©±ç”¨ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—)
        window.cleanupSpontaneousSpeech = async (didRespond = false) => {
            // â˜… v22: è‡ªå‹•ç™ºè©±ç”¨ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ­ãƒƒã‚¯ã‚’ãƒã‚§ãƒƒã‚¯
            if (!isAIPosting_Spontaneous) {
                // æ—¢ã« cleanup æ¸ˆã¿ã€ã¾ãŸã¯ãƒ­ãƒƒã‚¯å–å¾—ã«å¤±æ•—ã—ã¦ã„ãŸå ´åˆ
                return;
            }

            isAIPosting_Spontaneous = false; // â˜… v22: è‡ªå‹•ç™ºè©±ç”¨ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ãƒ©ã‚°ã‚’è§£é™¤

            if (currentRoomId) {
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ­ãƒƒã‚¯ã‚’è§£é™¤
                try {
                    // â˜… v22: è‡ªå‹•ç™ºè©±ç”¨ã®ãƒ­ãƒƒã‚¯
                    const aiStateRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId, 'state', 'aiState_Spontaneous');
                    await setDoc(aiStateRef, { isPosting: false }, { merge: true });
                    console.log("AI Spontaneous: Released global Spontaneous AI lock.");

                    // â˜… v22: è‡ªå‹•ç™ºè©±ã®å ´åˆã€ãƒ­ã‚°è¿½åŠ  -> onSnapshot -> checkAIAssignment (å¿œç­”) ãŒ
                    // è‡ªå‹•çš„ã«ãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã® setTimeout (å¿œç­”ãƒã‚§ãƒƒã‚¯) ã¯ä¸è¦ã€‚

                } catch (error) {
                    console.error("Failed to release Spontaneous AI lock:", error);
                }
            }
        };


        // === UI / Chat Logic Functions ===
        // â˜… ä¿®æ­£: AIå¿œç­”ãƒ—ãƒ­ã‚»ã‚¹ã‹ã‚‰ã®å‘¼ã³å‡ºã—ã‚’å‰Šé™¤ã—ãŸãŸã‚ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯UIæ“ä½œï¼ˆãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãªã©ï¼‰ã®ãƒ­ãƒƒã‚¯ã«é™å®š
        window.toggleUI = (disable, message = 'å‡¦ç†ä¸­...') => {
            const form = document.getElementById('chat-form-elements');
            const messageBar = document.getElementById('system-message-bar');
            if (form) { Array.from(form.elements).forEach(el => el.disabled = disable); }

            // â˜… v3: å·¦ã‚«ãƒ©ãƒ ã¨ãƒ«ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ä¸¡æ–¹ã‚’å¯¾è±¡
            const leftColumnButtons = document.querySelectorAll('#left-column button, #left-column input');
            leftColumnButtons.forEach(btn => btn.disabled = disable);
            const roomListButtons = document.querySelectorAll('#room-list-modal button, #room-list-modal input');
            roomListButtons.forEach(btn => btn.disabled = disable);

            if (disable) {
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ¼ã‚’è¡¨ç¤º
                if (messageBar) {
                    messageBar.textContent = message;
                    messageBar.classList.remove('hidden', 'text-green-600');
                    messageBar.classList.add('text-red-600');
                }
            } else {
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ¼ã‚’éè¡¨ç¤º
                if (messageBar) {
                    messageBar.classList.add('hidden');
                }
                // â˜… v23: system_user é¸æŠä¸­ã‚‚ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’è¨±å¯
                if (currentRoomId || document.getElementById('speaker-select').value === 'system_user') {
                    try {
                        const isModalOpen = !document.getElementById('role-editor-modal').classList.contains('hidden')
                            || !document.getElementById('delete-confirm-modal').classList.contains('hidden')
                            || !document.getElementById('summary-modal').classList.contains('hidden')
                            || !document.getElementById('name-editor-modal').classList.contains('hidden')
                            || !document.getElementById('speaker-selector-modal').classList.contains('hidden')
                            || !document.getElementById('help-modal').classList.contains('hidden')
                            || !document.getElementById('system-help-modal').classList.contains('hidden') // â˜… v23: è¿½åŠ 
                            || !document.getElementById('welcome-guide-modal').classList.contains('hidden') // â˜… v23: è¿½åŠ 
                            || !document.getElementById('room-list-modal').classList.contains('hidden');
                        const chatInput = document.getElementById('chat-input');
                        if (!isModalOpen && chatInput && !chatInput.disabled) {
                            setTimeout(() => chatInput.focus(), 0);
                        }
                    } catch (e) { console.warn("Focus logic failed:", e); }
                }
            }
        };

        // æ„Ÿæƒ…åˆ†æ (å¤‰æ›´ãªã—)
        window.analyzeHumanEmotion = async (message) => {
            if (!message || message.trim().length === 0) {
                return DEFAULT_EMOTION;
            }
            try {
                const emotionKeys = Object.keys(EMOTIONS).join(', ');
                const systemPrompt = `ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™ºè¨€ã‚’åˆ†æã—ã€æœ€ã‚‚ãµã•ã‚ã—ã„æ„Ÿæƒ…ã‚’ ${emotionKeys} ã®ã„ãšã‚Œã‹ä¸€ã¤ã ã‘ã§è¿”ç­”ã—ã¦ãã ã•ã„ã€‚`;
                const contents = [{ role: 'user', parts: [{ text: message }] }];
                // callGeminiAPI(systemInstruction = null, contents, shouldExtractJson = false)
                const response = await window.callGeminiAPI(systemPrompt, contents, false);
                let emotionKey = response.text.trim().toLowerCase();

                // APIã®å¿œç­”ãŒã‚­ãƒ¼ãã®ã‚‚ã®ã§ãªã„å ´åˆï¼ˆä¾‹: "Emotion: happy"ï¼‰ã‚‚è€ƒæ…®
                if (!EMOTIONS[emotionKey]) {
                    for (const key of Object.keys(EMOTIONS)) {
                        if (emotionKey.includes(key)) {
                            emotionKey = key;
                            break;
                        }
                    }
                    // ãã‚Œã§ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                    if (!EMOTIONS[emotionKey]) {
                        emotionKey = DEFAULT_EMOTION;
                    }
                }
                return emotionKey;
            } catch (error) {
                console.error("Emotion analysis failed:", error);
                return DEFAULT_EMOTION;
            }
        };

        // æ—¢å­˜ã® addNewLogToFirestore é–¢æ•° (ã“ã‚Œã¯å¤‰æ›´ãªã—)
        window.addNewLogToFirestore = async (newLogData) => {
            if (!currentRoomId) { console.error("addNewLogToFirestore: currentRoomId is not set."); return null; }
            const logsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId, 'chat_logs');

            if (newLogData.isSystemLog) {
                try {
                    const docRef = await addDoc(logsCollectionRef, newLogData);
                    return docRef.id;
                } catch (e) {
                    console.error("Error adding system log directly:", e);
                    return null;
                }
            }

            let newLogId = null;
            const statsRef = doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'chatCounter');
            await runTransaction(db, async (transaction) => {
                const statsDoc = await transaction.get(statsRef);
                const newCount = (statsDoc.data()?.count || 0) + 1;
                transaction.set(statsRef, { count: newCount }, { merge: true });
                const newLogRef = doc(logsCollectionRef);
                newLogId = newLogRef.id;
                transaction.set(newLogRef, newLogData);
            });
            return newLogId;
        };

        // â˜…â˜…â˜… Electroné€£æºç”¨ è¿½åŠ  â˜…â˜…â˜…
        /**
         * @description Discordã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°ã¨ã—ã¦Firestoreã«æ›¸ãè¾¼ã‚€
         * @param {string} author - Discordã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å
         * @param {string} content - Discordã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹
         */
        window.addDiscordLogToFirestore = async (author, content) => {
            if (!currentRoomId || !currentUser) return;

            // Firestoreã«ä¿å­˜ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ
            const text = `[Discord: ${author}] ${content}`;

            // addNewLogToFirestore ã‚’ä½¿ã£ã¦ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°ã¨ã—ã¦æŠ•ç¨¿
            await window.addNewLogToFirestore({
                senderId: 'system_discord', // Discordç”¨ã®ç‰¹åˆ¥ãªID
                senderName: 'Discord',
                text: text,
                isRole: false,
                makerId: 'system', // ã‚·ã‚¹ãƒ†ãƒ ãŒä½œæˆ
                isAIGenerated: false,
                isSystemLog: true, // â˜… ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°ã¨ã—ã¦æ‰±ã†
                systemType: 'discord_message', // æ–°ã—ã„ã‚¿ã‚¤ãƒ—
                emotion: 'standard',
                timestamp: serverTimestamp()
            });
            // (onSnapshotãŒç™ºç«ã—ã€è‡ªå‹•çš„ã«ãƒãƒ£ãƒƒãƒˆæ¬„ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã¯ãš)
        };
        // â˜…â˜…â˜… ã“ã“ã¾ã§ â˜…â˜…â˜…

        // (æ—¢å­˜ã® submitMessage é–¢æ•°ã‚’ã“ã‚Œã§ç½®ãæ›ãˆ)
        window.submitMessage = async (e) => {
            e.preventDefault(); //
            const input = document.getElementById('chat-input'); //
            const message = input.value.trim(); //
            const speakerSelect = document.getElementById('speaker-select'); //
            const senderId = speakerSelect.value; //

            if (!currentUser) return; //

            if ((!message && !attachedImage.base64) || !senderId) { //
                window.displayTemporaryMessage("ç™ºè¨€ã™ã‚‹ãƒ­ãƒ¼ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return;
            }

            if (senderId === 'system_user') { //
                if (message) {
                    input.value = ''; //
                    await window.triggerSystemHelp(message); //
                }
                return;
            }

            // --- ä»¥ä¸‹ã€é€šå¸¸ã®ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°æŠ•ç¨¿ (ãƒ«ãƒ¼ãƒ å…¥å®¤å¿…é ˆ) ---
            if (!currentRoomId) { //
                window.displayTemporaryMessage("ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã«å…¥å®¤ã—ã¦ãã ã•ã„ã€‚"); return;
            }

            const role = roles.find(r => r.id === senderId); //
            if (!role) {
                window.displayTemporaryMessage("é¸æŠã•ã‚ŒãŸãƒ­ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"); return;
            }
            if (!currentRoomInvitedRoles[role.id]) { //
                window.displayTemporaryMessage(`ã€Œ${role.name}ã€ã¯ã“ã®ãƒ«ãƒ¼ãƒ ã«å‚åŠ ï¼ˆæ‹›å¾…ï¼‰ã—ã¦ã„ã¾ã›ã‚“ã€‚`); return;
            }
            const senderName = role.name; //
            window.toggleUI(true, 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ä¸­...'); //
            try {
                const analyzedEmotion = await window.analyzeHumanEmotion(message); //
                const newLog = {
                    senderId: senderId, senderName: senderName, text: message,
                    attachedImageBase64: attachedImage.base64 || null, //
                    attachedImageMimeType: attachedImage.mimeType || null, //
                    isRole: true, makerId: currentUser.uid, isAIGenerated: false,
                    emotion: analyzedEmotion, timestamp: serverTimestamp()
                };
                await window.addNewLogToFirestore(newLog); //

                // â˜…â˜…â˜… Electroné€£æºç”¨ è¿½åŠ  â˜…â˜…â˜…
                // (Firestoreã¸ã®ä¿å­˜ãŒæˆåŠŸã—ãŸå¾Œã€Electronãƒ›ã‚¹ãƒˆç’°å¢ƒãªã‚‰Discordã«ã‚‚é€ä¿¡)
                if (isElectronHost && window.electronHostBridge && window.electronHostBridge.sendToDiscord) {
                    // â˜… é‡è¦: ã“ã® 'role' ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¯ã€Discordé€ä¿¡ã«å¿…è¦ãª
                    // 'avatarUrls: { standard: "http://..." }' ã®ã‚ˆã†ãª
                    // Webã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªURLãŒå«ã¾ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
                    // (Yumemiruã®ãƒ­ãƒ¼ãƒ«å®šç¾©ã«ã“ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã™ã‚‹å‰æã§ã™)
                    window.electronHostBridge.sendToDiscord(
                        role, // ãƒ­ãƒ¼ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ (avatarUrlsã‚’å«ã‚€ã¨ä»®å®š)
                        message, // ãƒ†ã‚­ã‚¹ãƒˆ
                        analyzedEmotion // æ„Ÿæƒ…
                    );
                }
                // â˜…â˜…â˜… ã“ã“ã¾ã§ â˜…â˜…â˜…

                input.value = ''; //
                window.clearImageAttachment(); //
            } catch (error) {
                console.error("Error submitting message:", error);
                window.displayTemporaryMessage("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message);
            } finally {
                window.toggleUI(false); //
            }
        };

        // â˜… v23: AIæ©Ÿèƒ½è§£èª¬ã®å‘¼ã³å‡ºã—
        window.triggerSystemHelp = async (question) => {
            if (!question) return;
            window.toggleUI(true, 'AIãŒæ©Ÿèƒ½è§£èª¬ã‚’ç”Ÿæˆä¸­...');
            try {
                // callGeminiAPI(systemInstruction = null, contents, shouldExtractJson = false)
                const response = await window.callGeminiAPI(
                    SYSTEM_MANUAL_PROMPT,
                    [{ role: 'user', parts: [{ text: question }] }],
                    false
                );
                window.showSystemHelpModal(response.text);
            } catch (error) {
                console.error("System Help API Error:", error);
                window.showSystemHelpModal(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
            } finally {
                window.toggleUI(false);
            }
        };


        // â˜… v7: æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã«ã¯ãªã£ã¦ã„ãªã‹ã£ãŸãŒã€å‘¼ã³å‡ºã•ã‚Œã¦ã„ãŸãŸã‚å®šç¾©ã‚’ä¿®æ­£ãƒ»è¿½åŠ 
        // â˜… v15: ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ­ãƒƒã‚¯è§£é™¤å‡¦ç†ã‚’è¿½åŠ 
        window.cleanupAIAssignment = async (didRespond = false) => { // â˜… v17: å¿œç­”ãƒ•ãƒ©ã‚°å¼•æ•°ã‚’è¿½åŠ 
            // â˜… v22: å¿œç­”ç™ºè©±ç”¨ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ­ãƒƒã‚¯ã‚’ãƒã‚§ãƒƒã‚¯
            if (!isAIPosting_Response) {
                // æ—¢ã« cleanup æ¸ˆã¿ã€ã¾ãŸã¯ãƒ­ãƒƒã‚¯å–å¾—ã«å¤±æ•—ã—ã¦ã„ãŸå ´åˆ
                return;
            }

            isAIPosting_Response = false; // â˜… v22: å¿œç­”ç™ºè©±ç”¨ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ãƒ©ã‚°ã‚’è§£é™¤

            if (currentRoomId) {
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ­ãƒƒã‚¯ã‚’è§£é™¤
                try {
                    // â˜… v22: å¿œç­”ç™ºè©±ç”¨ã®ãƒ­ãƒƒã‚¯
                    const aiStateRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId, 'state', 'aiState_Response'); // â˜… v22 å¤‰æ›´
                    // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã¯æ›´æ–°ã›ãšã€isPostingãƒ•ãƒ©ã‚°ã®ã¿ã‚’å€’ã™
                    await setDoc(aiStateRef, { isPosting: false }, { merge: true });
                    console.log("AI Assignment: Released global Response AI lock."); // â˜… v22 å¤‰æ›´

                    // â˜… v17: ã‚‚ã—AIãŒå¿œç­”ã—ã¦ã„ãŸã‚‰ã€ãƒ­ãƒƒã‚¯è§£é™¤å¾Œã«ï¼ˆé…å»¶ã•ã›ã¦ï¼‰å†ãƒã‚§ãƒƒã‚¯ã‚’ãƒˆãƒªã‚¬ãƒ¼
                    // ã“ã‚Œã«ã‚ˆã‚Šã€AIã®æŒ‡åå¿œç­”ãŒé€£é–ã™ã‚‹
                    if (didRespond) {
                        console.log("AI Assignment: Triggering post-response check (1s delay)...");
                        // ãƒ­ã‚°ãŒDBã«åæ˜ ã•ã‚Œã€onSnapshotãŒï¼ˆãƒ­ãƒƒã‚¯ã«ã‚ˆã£ã¦ï¼‰ã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸå ´åˆã«å‚™ãˆã¦
                        // 1ç§’å¾Œã«æ‰‹å‹•ã§å†ãƒã‚§ãƒƒã‚¯ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹
                        setTimeout(window.checkAIAssignment, 1000);
                    }

                } catch (error) {
                    console.error("Failed to release AI lock:", error);
                }
            }
            // AIå¿œç­”å‡¦ç†ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®UIãƒ­ãƒƒã‚¯ã‚’ä¼´ã‚ãªã„ãŸã‚ã€ã“ã“ã§ã¯UIã®ã‚¢ãƒ³ãƒ­ãƒƒã‚¯å‡¦ç†ã¯è¡Œã„ã¾ã›ã‚“ã€‚
        };

        // â˜… v3: AIå¿œç­”ãƒã‚§ãƒƒã‚¯ (roomIdå¯¾å¿œ)
        window.checkAIAssignment = async (latestText = null) => { // latestTextå¼•æ•°ã¯ã‚‚ã†ä¸è¦
            // â˜… v22: å¿œç­”ç™ºè©±ç”¨ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ­ãƒƒã‚¯ã‚’ãƒã‚§ãƒƒã‚¯
            if (isAIPosting_Response || !currentRoomId) return; // â˜… v15: ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ãƒ©ã‚°ãƒã‚§ãƒƒã‚¯ (ã“ã®ã‚¿ãƒ–ãŒå‡¦ç†ä¸­ãªã‚‰å³æ™‚ãƒªã‚¿ãƒ¼ãƒ³)

            // â˜… v15: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ«ãƒ¼ãƒ ã«å­˜åœ¨ã—ãªããªã£ãŸã‚‰AIå¿œç­”ã‚’åœæ­¢ã™ã‚‹
            // â˜… v14: isMakerOnlineãƒã‚§ãƒƒã‚¯ã‚’å‰Šé™¤ã—ãŸãŸã‚ã€ã“ã®ãƒã‚§ãƒƒã‚¯ã‚’ã€Œèª°ã‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ«ãƒ¼ãƒ ã«ã„ã‚‹ã‹ã€ã«å¤‰æ›´
            const isAnyoneInRoom = Object.values(currentRoomPresence).length > 0;
            if (!isAnyoneInRoom) {
                console.log("AI Assignment skipped: No users in this room.");
                return;
            }

            // â˜… v22: ã‚°ãƒ­ãƒ¼ãƒãƒ«AIãƒ­ãƒƒã‚¯ (å¿œç­”ç™ºè©±ç”¨)
            // è¤‡æ•°ã®ã‚¿ãƒ–ãŒé–‹ã‹ã‚Œã¦ã„ã‚‹å ´åˆã€AIå¿œç­”å‡¦ç†ãŒé‡è¤‡ç™ºç«ã™ã‚‹ã®ã‚’é˜²ã
            const aiStateRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId, 'state', 'aiState_Response'); // â˜… v22 å¤‰æ›´
            let canProceed = false;
            try {
                await runTransaction(db, async (transaction) => {
                    const aiStateDoc = await transaction.get(aiStateRef);
                    const stateData = aiStateDoc.data();
                    const now = Date.now();
                    const lockTimeout = 30 * 1000; // 30ç§’

                    // ãƒ­ãƒƒã‚¯ãŒæœ‰åŠ¹ã‹ï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“å†…ã‹ï¼‰
                    const isLocked = stateData?.isPosting && stateData.timestamp && (now - stateData.timestamp.toMillis() < lockTimeout);

                    if (isLocked) {
                        // ä»–ã®ã‚¿ãƒ–ãŒå‡¦ç†ä¸­ï¼ˆã¾ãŸã¯ãƒ­ãƒƒã‚¯ãŒæ®‹ã£ã¦ã„ã‚‹ï¼‰
                        console.log("AI Assignment skipped: Global Response AI lock is active."); // â˜… v22 å¤‰æ›´
                        canProceed = false;
                    } else {
                        // ãƒ­ãƒƒã‚¯ã‚’å–å¾—
                        console.log("AI Assignment: Acquired global Response AI lock."); // â˜… v22 å¤‰æ›´
                        transaction.set(aiStateRef, { isPosting: true, timestamp: serverTimestamp() });
                        canProceed = true;
                    }
                });
            } catch (error) {
                // â˜… v24: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç«¶åˆã¯æœŸå¾…ã•ã‚Œã‚‹å¤±æ•—ã€‚ãƒ­ã‚°ã‚’ç°¡ç´ åŒ–ã—ã€ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡ã‚’ç¶­æŒã€‚
                console.log("AI Lock Transaction failed (concurrency or timeout), skipping assignment. Reason:", error.message || error);
                canProceed = false; // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¤±æ•—æ™‚ã¯å®Ÿè¡Œã—ãªã„
            }

            if (!canProceed) {
                return; // ãƒ­ãƒƒã‚¯å–å¾—ã«å¤±æ•—ã—ãŸã‚‰å‡¦ç†ã‚’çµ‚äº†
            }

            // â˜… v22: å¿œç­”ç™ºè©±ç”¨ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ­ãƒƒã‚¯ã‚’ç«‹ã¦ã‚‹
            isAIPosting_Response = true;

            // â˜… v17: å¿œç­”ç”Ÿæˆã‚¿ã‚¹ã‚¯ã‚’æ ¼ç´ã™ã‚‹é…åˆ— (try ã®å¤–ã§å®£è¨€)
            let responseTasks = [];

            // --- æ—¢å­˜ã®å‡¦ç†ï¼ˆãƒ­ãƒƒã‚¯å–å¾—å¾Œã«å®Ÿè¡Œï¼‰ ---
            const logsRef = collection(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId, 'chat_logs');
            const q = query(logsRef, orderBy('timestamp', 'desc'), limit(10));

            try {
                const snapshot = await getDocs(q);
                const logs = snapshot.docs.map(doc => doc.data());
                if (logs.length === 0) {
                    /* ä½•ã‚‚ã›ãš finally ã§ cleanup */
                    // â˜… v15: ãƒ­ã‚°ãŒãªã„å ´åˆã§ã‚‚ã€finallyã§ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
                    return;
                }

                const lastLog = logs[0];
                const chatHistory = logs.reverse();

                // â˜… v9 ä¿®æ­£: ç›´å‰2ä»¶ã®ãƒ­ã‚°ãŒAIã§ã€ã‹ã¤åŒã˜ãƒ­ãƒ¼ãƒ«ã ã£ãŸå ´åˆã€å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
                // â˜… v21 ä¿®æ­£: 2å›é€£ç¶š -> 3å›é€£ç¶š ã«ç·©å’Œ (é€šå¸¸å¿œç­”ã¨è‡ªç™ºçš„ç™ºè¨€ã®ç«¶åˆå›é¿ã®ãŸã‚)
                if (logs.length >= 3 &&
                    lastLog.isAIGenerated && logs[1].isAIGenerated && logs[2].isAIGenerated &&
                    lastLog.senderId === logs[1].senderId &&
                    lastLog.senderId === logs[2].senderId) {
                    console.log(`AI Assignment skipped: Same AI role (${lastLog.senderName}) responded 3 times consecutively.`);
                    // â˜… v15: ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹å ´åˆã§ã‚‚ã€finallyã§ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
                    return;
                }

                // â˜… v12: ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°ã®å ´åˆã¯AIå¿œç­”ã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ãªã„
                if (lastLog.isSystemLog) {
                    console.log("AI Assignment skipped: Last log was a system message.");
                    // â˜… v15: ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹å ´åˆã§ã‚‚ã€finallyã§ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
                    return;
                }

                // â˜… v7: æŒ‡åå¿œç­”ãƒ­ã‚¸ãƒƒã‚¯ (åå‰ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°OK)
                let mentionedRoleIds = []; // â˜… è¤‡æ•°ã®IDã‚’æ ¼ç´ã™ã‚‹é…åˆ—ã«å¤‰æ›´
                const lastText = lastLog.text || "";

                // æ‹›å¾…ã•ã‚Œã¦ã„ã‚‹å…¨ãƒ­ãƒ¼ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
                const invitedRoleIds = Object.keys(currentRoomInvitedRoles);

                for (const roleId of invitedRoleIds) {
                    const role = roles.find(r => r.id === roleId);
                    // ãƒ­ãƒ¼ãƒ«å®šç¾©ãŒè¦‹ã¤ã‹ã‚Šã€ãã®åå‰ãŒãƒ†ã‚­ã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹
                    if (role && role.name && lastText.includes(role.name)) {
                        mentionedRoleIds.push(roleId); // â˜… é…åˆ—ã«è¿½åŠ 
                    }
                }
                if (mentionedRoleIds.length > 0) {
                    console.log(`Mention detected for Role IDs: ${mentionedRoleIds.join(', ')}`);
                }

                // â˜… v8: AIã®é€£é–å¿œç­”ã‚’åœæ­¢ã™ã‚‹ï¼ˆæŒ‡åãŒãªã„å ´åˆã®ã¿ï¼‰
                if (mentionedRoleIds.length === 0 && logs.length >= 2 && lastLog.isAIGenerated && logs[1].isAIGenerated) {
                    console.log("AI Assignment skipped: AI response chain limit (2) reached (No mention).");
                    /* ä½•ã‚‚ã›ãš finally ã§ cleanup */
                    // â˜… v15: ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹å ´åˆã§ã‚‚ã€finallyã§ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
                    return;
                }

                const selectedRoleIdsInThisRoom = Object.values(currentRoomPresence).map(p => p.selectedRole);

                if (mentionedRoleIds.length > 0) {
                    // --- ãƒ‘ã‚¿ãƒ¼ãƒ³A: æŒ‡åå¿œç­” (AI/äººé–“å•ã‚ãšãƒˆãƒªã‚¬ãƒ¼) ---

                    for (const mentionedRoleId of mentionedRoleIds) {
                        const targetRole = roles.find(r => r.id === mentionedRoleId);

                        if (targetRole) {
                            const isNotLastSpeaker = targetRole.id !== lastLog.senderId;
                            const isNotSelected = !selectedRoleIdsInThisRoom.includes(targetRole.id);
                            // â˜… v14 ä¿®æ­£: isMakerOnline ã®ãƒã‚§ãƒƒã‚¯ã‚’å‰Šé™¤ã—ã€è£½ä½œè€…ãŒã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã®AIã§ã‚‚æŒ‡åå¿œç­”ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

                            // æŒ‡åã•ã‚ŒãŸãƒ­ãƒ¼ãƒ«ãŒAIæ“ä½œä¸­ï¼ˆèª°ã«ã‚‚é¸æŠã•ã‚Œã¦ã„ãªã„ï¼‰ã§ã€
                            // ã‹ã¤ç™ºè¨€è€…è‡ªèº«ã§ãªã„å ´åˆ
                            if (isNotLastSpeaker && isNotSelected) { // â˜… v14 ä¿®æ­£: isMakerOnline ã‚’å‰Šé™¤
                                // â˜… v17: ã‚¿ã‚¹ã‚¯ã‚’é…åˆ—ã«è¿½åŠ  (await ã—ãªã„)
                                console.log(`Queueing mention response for ${targetRole.name}`);
                                responseTasks.push(window.generateRoleResponse(targetRole, chatHistory, lastLog));
                            } else {
                                if (!isNotSelected) {
                                    console.log(`Mentioned role ${targetRole.name} is operated by human, AI skip.`);
                                }
                                else if (!isNotLastSpeaker) {
                                    console.log(`Mentioned role ${targetRole.name} is the last speaker, AI skip.`);
                                }
                            }
                        } else {
                            console.log(`Mentioned role ID ${mentionedRoleId} not found in global roles list.`);
                        }
                    }

                    // â˜… v17: ãƒ‘ã‚¿ãƒ¼ãƒ³Aã§ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Œã°ã€ãƒ‘ã‚¿ãƒ¼ãƒ³Bã¯å®Ÿè¡Œã—ãªã„
                    // (await ã¯ try ãƒ–ãƒ­ãƒƒã‚¯ã®æœ€å¾Œã§è¡Œã†)


                } else if (!lastLog.isAIGenerated) {
                    // --- ãƒ‘ã‚¿ãƒ¼ãƒ³B: é€šå¸¸å¿œç­”ï¼ˆæŒ‡åãªã—ã€AIç™ºè¨€ã§ãªã„å ´åˆã®ã¿ï¼‰ ---

                    // â˜… ä¿®æ­£: å¿œç­”è³‡æ ¼ã®ã‚ã‚‹AIã‚’å…¬å¹³ã«é¸ã¶ãƒ­ã‚¸ãƒƒã‚¯
                    let eligibleRoles = roles.filter(role => {
                        const isInvited = currentRoomInvitedRoles[role.id];
                        const isNotLastSpeaker = role.id !== lastLog.senderId;
                        const isNotSelected = !selectedRoleIdsInThisRoom.includes(role.id);
                        // â˜… v14 ä¿®æ­£: isMakerOnline ã®ãƒã‚§ãƒƒã‚¯ã‚’å‰Šé™¤ã—ã€è£½ä½œè€…ãŒã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã®AIã§ã‚‚é€šå¸¸å¿œç­”ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
                        return isInvited && isNotLastSpeaker && isNotSelected; // â˜… v14 ä¿®æ­£: isMakerOnline ã‚’å‰Šé™¤
                    });

                    if (eligibleRoles.length > 0) {
                        // ç™ºè¨€å›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
                        const roleChatCounts = {};
                        eligibleRoles.forEach(role => roleChatCounts[role.id] = 0);

                        // ç›´è¿‘ã®ä¼šè©±ãƒ­ã‚°10ä»¶ï¼ˆchatHistoryï¼‰ã‚’é¡ã‚Šã€ç™ºè¨€æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                        chatHistory.slice(-10).forEach(log => {
                            if (roleChatCounts.hasOwnProperty(log.senderId)) {
                                roleChatCounts[log.senderId]++;
                            }
                        });

                        // ç™ºè¨€æ•°ãŒå°‘ãªã„é †ã€IDã®è¾æ›¸é †ã§ã‚½ãƒ¼ãƒˆ (å®‰å®šã—ãŸã‚½ãƒ¼ãƒˆã®ãŸã‚)
                        eligibleRoles.sort((a, b) => {
                            const countA = roleChatCounts[a.id] || 0;
                            const countB = roleChatCounts[b.id] || 0;

                            if (countA !== countB) {
                                return countA - countB; // ç™ºè¨€ãŒå°‘ãªã„ã‚‚ã®ã‚’å„ªå…ˆ
                            }
                            return a.id.localeCompare(b.id); // åŒæ•°ã®å ´åˆã¯IDã§ã‚½ãƒ¼ãƒˆï¼ˆå…¬å¹³æ€§ã‚’ä¿ã¤ãŸã‚ï¼‰
                        });

                        // æœ€å¤§3äººã¾ã§å¿œç­”ã•ã›ã‚‹
                        const rolesToRespond = eligibleRoles.slice(0, 3);

                        console.log(`Generating balanced responses for ${rolesToRespond.length} roles: ${rolesToRespond.map(r => r.name).join(', ')}`);

                        // â˜… v17: ã‚¿ã‚¹ã‚¯ã‚’é…åˆ—ã«è¿½åŠ  (await ã—ãªã„)
                        for (const targetRole of rolesToRespond) {
                            responseTasks.push(window.generateRoleResponse(targetRole, chatHistory, lastLog));
                        }
                    }
                }

                // â˜… v17: ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°ã•ã‚ŒãŸå…¨ã¦ã®ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œ
                if (responseTasks.length > 0) {
                    await Promise.all(responseTasks);
                }

            } catch (error) {
                console.error("Error during sequential AI posting:", error);
            } finally {
                // â˜… v17: cleanupAIAssignment ã§ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã€å¿œç­”ãŒã‚ã£ãŸå ´åˆã¯å†ãƒã‚§ãƒƒã‚¯ã‚’ãƒˆãƒªã‚¬ãƒ¼
                window.cleanupAIAssignment(responseTasks.length > 0);
            }
        };

        // (æ—¢å­˜ã® generateRoleResponse é–¢æ•°ã‚’ã“ã‚Œã§ç½®ãæ›ãˆ)
        window.generateRoleResponse = async (role, chatHistory, lastLog) => {
            if (!currentRoomId) return; //

            // â˜… 1. é€£æºAIãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            const linkedAiId = role.linkedAiId; // (Firestoreã‹ã‚‰èª­ã¿è¾¼ã‚“ã  'role' ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã“ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚‹ã¨ä»®å®š)

            // â˜… 2. Electronãƒ›ã‚¹ãƒˆç’°å¢ƒã§ã€ã‹ã¤é€£æºAIãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ
            if (isElectronHost && linkedAiId && window.electronHostBridge && window.electronHostBridge.requestAIResponse) {
                console.log(`Yumemiru: Electron AI (${linkedAiId}) ã«å¿œç­”ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¾ã™ã€‚`);

                try {
                    // â˜… 3. Electronç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰
                    const commonInstruction = "ã‚ãªãŸã¯ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ãƒãƒ£ãƒƒãƒˆã«å‚åŠ ã—ã¦ã„ã‚‹AIã§ã™ã€‚äººé–“ã®å‚åŠ è€…ã¨è‡ªç„¶ãªä¼šè©±ã‚’ç¶šã‘ã¦ãã ã•ã„ã€‚ç‰¹åˆ¥ãªã‚ªãƒ¼ãƒ€ãƒ¼ï¼ˆè¦ç´„ã‚„é•·æ–‡ã®æŒ‡ç¤ºãªã©ï¼‰ãŒãªã„é™ã‚Šã€ç™ºè¨€ã¯1ã€œ3æ–‡ç¨‹åº¦ã®ç°¡æ½”ãªã‚‚ã®ã«ã—ã¦ãã ã•ã„ã€‚"; //
                    const systemPrompt = role.systemPrompt + "\n\nã‚ãªãŸã®è¨˜æ†¶:\n" + (role.memory || "ç‰¹ã«ã‚ã‚Šã¾ã›ã‚“ã€‚") + "\n\n" + commonInstruction; //

                    // (ä¼šè©±å±¥æ­´ã®æ§‹ç¯‰)
                    const historyText = chatHistory.map(log => `${log.senderName}: ${log.text}`).join('\n');

                    // (content_ai.js ãŒæœŸå¾…ã™ã‚‹å½¢å¼ã«åˆã‚ã›ã‚‹)
                    const electronPrompt = [
                        `ã€ã‚ãªãŸã®ãƒ­ãƒ¼ãƒ«è©³ç´°ã€‘\n${role.systemPrompt}`,
                        `ã€ã‚ãªãŸã®è¨˜æ†¶ã€‘\n${role.memory || "ç‰¹ã«ã‚ã‚Šã¾ã›ã‚“ã€‚"}`,
                        "== ã“ã‚Œã¾ã§ã®ä¼šè©±å±¥æ­´ ==",
                        historyText,
                        "== ä¼šè©±ã¯ã“ã“ã¾ã§ ==",
                        "ã€ã‚·ã‚¹ãƒ†ãƒ ã‚ˆã‚Šã€‘\næ„Ÿæƒ…ã‚¿ã‚°[normal|happy|sad|curiosity]ã‹ã‚‰ã²ã¨ã¤ã‚’å¿…ãšæ–‡é ­ã«ã¤ã‘ã¦ãã ã•ã„ã€‚"
                    ].join('\n\n');


                    // â˜… 4. Electronã«AIå¿œç­”ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                    const aiResponseText = await window.electronHostBridge.requestAIResponse(
                        linkedAiId,
                        electronPrompt
                    );

                    // â˜… 5. å¿œç­”ã‹ã‚‰æ„Ÿæƒ…ã¨ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º (Electronå´ãŒ [happy] ã‚¿ã‚°ã‚’ä»˜ã‘ã‚‹å‰æ)
                    const tagRegex = /^\[?(normal|happy|sad|curiosity)\]?\s*/i;
                    let emotion = 'normal';
                    let text = aiResponseText.trim();
                    const tagMatch = text.match(tagRegex);

                    if (tagMatch) {
                        emotion = tagMatch[1].toLowerCase();
                        text = text.substring(tagMatch[0].length).trimStart();
                    } else {
                        // ã‚¿ã‚°ãŒãªã‹ã£ãŸå ´åˆ (AIãƒ¯ãƒ¼ã‚«ãƒ¼ã®ã‚¨ãƒ©ãƒ¼)
                        console.warn(`Electron AI (${linkedAiId}) ã‹ã‚‰æ„Ÿæƒ…ã‚¿ã‚°ã®ãªã„å¿œç­”: ${text.slice(0, 50)}`);
                        text = aiResponseText.trim(); // ãã®ã¾ã¾ä½¿ç”¨
                    }

                    // â˜… 6. é‡è¤‡ç™ºè¨€ãƒã‚§ãƒƒã‚¯
                    const lastRoomLog = currentRoomLogs.length > 0 ? currentRoomLogs[currentRoomLogs.length - 1] : null; //
                    if (lastRoomLog && lastRoomLog.senderId === role.id && lastRoomLog.text === text) { //
                        console.warn(`Duplicate speech detected for role ${role.name} ("${text}"). Skipping log.`);
                        return; // ãƒ­ã‚°ã«è¿½åŠ ã›ãšã«çµ‚äº†
                    }

                    // â˜… 7. Firestoreã«ãƒ­ã‚°ã‚’è¿½åŠ 
                    const newLog = {
                        senderId: role.id, senderName: role.name, text: text,
                        isRole: true, makerId: role.id, isAIGenerated: true,
                        emotion: emotion, timestamp: serverTimestamp()
                    };
                    await window.addNewLogToFirestore(newLog); //

                    // â˜… 8. Discordã«ã‚‚é€ä¿¡
                    if (isElectronHost && window.electronHostBridge) {
                        // (ã“ã“ã§ã‚‚ avatarUrls ãŒãƒ­ãƒ¼ãƒ«å®šç¾©ã«ã‚ã‚‹å‰æ)
                        window.electronHostBridge.sendToDiscord(role, text, emotion);
                    }

                } catch (error) {
                    console.error(`Yumemiru: Electron AI (${linkedAiId}) ã®å¿œç­”ç”Ÿæˆã‚¨ãƒ©ãƒ¼:`, error);
                    // (ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’Yumemiruã«è¡¨ç¤º)
                    await window.addNewLogToFirestore({
                        senderId: 'system', senderName: 'ã‚·ã‚¹ãƒ†ãƒ ',
                        text: `ãƒ­ãƒ¼ãƒ«ã€Œ${role.name}ã€ãŒElectron AI(${linkedAiId})ã‹ã‚‰ã®å¿œç­”å–å¾—ã«å¤±æ•—: ${error.message}`,
                        isRole: false, makerId: 'system', isAIGenerated: false,
                        isSystemLog: true, systemType: 'error', emotion: 'standard', timestamp: serverTimestamp()
                    });
                }

                // â˜… 9. Electronç’°å¢ƒã§ãªã„ã€ã¾ãŸã¯é€£æºAIãŒæœªè¨­å®šã®å ´åˆ (å…ƒã®Gemini APIãƒ­ã‚¸ãƒƒã‚¯)
            } else {
                console.log(`Yumemiru: Standalone AI (Gemini API) ã§å¿œç­”ã—ã¾ã™ (Electroné€£æºãªã—)ã€‚`);
                try {
                    const commonInstruction = "ã‚ãªãŸã¯ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ãƒãƒ£ãƒƒãƒˆã«å‚åŠ ã—ã¦ã„ã‚‹AIã§ã™ã€‚äººé–“ã®å‚åŠ è€…ã¨è‡ªç„¶ãªä¼šè©±ã‚’ç¶šã‘ã¦ãã ã•ã„ã€‚ç‰¹åˆ¥ãªã‚ªãƒ¼ãƒ€ãƒ¼ï¼ˆè¦ç´„ã‚„é•·æ–‡ã®æŒ‡ç¤ºãªã©ï¼‰ãŒãªã„é™ã‚Šã€ç™ºè¨€ã¯1ã€œ3æ–‡ç¨‹åº¦ã®ç°¡æ½”ãªã‚‚ã®ã«ã—ã¦ãã ã•ã„ã€‚"; //
                    const systemPrompt = role.systemPrompt + "\n\nã‚ãªãŸã®è¨˜æ†¶:\n" + (role.memory || "ç‰¹ã«ã‚ã‚Šã¾ã›ã‚“ã€‚") + "\n\n" + commonInstruction; //
                    const conversationParts = chatHistory.map(log => ({ //
                        role: log.isAIGenerated ? "model" : "user",
                        parts: [{ text: `${log.senderName}: ${log.text}` }]
                    }));
                    const lastHumanLog = conversationParts.pop(); //
                    const parts = lastHumanLog.parts; //
                    if (lastLog.attachedImageBase64 && lastLog.attachedImageMimeType) { //
                        if (!lastLog.text) { parts[0].text = `${lastLog.senderName} ãŒç”»åƒã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ã“ã®ç”»åƒã«ã¤ã„ã¦ã®æ„Ÿæƒ³ã‚„åå¿œã‚’è¿”ã—ã¦ãã ã•ã„ã€‚`; } //
                        else { parts[0].text = `${lastLog.senderName}: ${lastLog.text} (ã“ã®ç™ºè¨€ã«ã¯ä»¥ä¸‹ã®ç”»åƒãŒæ·»ä»˜ã•ã‚Œã¦ã„ã¾ã™ã€‚ç”»åƒã‚‚è¸ã¾ãˆã¦å¿œç­”ã—ã¦ãã ã•ã„ã€‚)`; } //
                        parts.push({ inlineData: { mimeType: lastLog.attachedImageMimeType, data: lastLog.attachedImageBase64 } }); //
                    }
                    conversationParts.push({ role: "user", parts: parts }); //
                    const response = await window.callGeminiAPI(systemPrompt, conversationParts, true); //
                    const { text, emotion } = response;

                    const lastRoomLog = currentRoomLogs.length > 0 ? currentRoomLogs[currentRoomLogs.length - 1] : null; //
                    if (lastRoomLog && lastRoomLog.senderId === role.id && lastRoomLog.text === text) { //
                        console.warn(`Duplicate speech detected for role ${role.name} ("${text}"). Skipping log.`);
                        return;
                    }

                    const newLog = {
                        senderId: role.id, senderName: role.name, text: text,
                        isRole: true, makerId: role.id, isAIGenerated: true,
                        emotion: emotion, timestamp: serverTimestamp()
                    };
                    await window.addNewLogToFirestore(newLog); //
                } catch (error) {
                    console.error(`Error generating spontaneous speech for ${role.name}:`, error);
                }
            }
        };

        // === ã‚«ãƒ©ãƒ¼ãƒ˜ãƒ«ãƒ‘ãƒ¼ (å¤‰æ›´ãªã—) ===
        const hexToHsl = (hex) => {
            hex = hex.replace('#', '');
            const r = parseInt(hex.substring(0, 2), 16) / 255;
            const g = parseInt(hex.substring(2, 4), 16) / 255;
            const b = parseInt(hex.substring(4, 6), 16) / 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            if (max === min) { h = s = 0; }
            else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return { h: Math.round(h * 360), s: Math.round(s * 100), l: Math.round(l * 100) };
        };
        const hslToHex = (h, s, l) => {
            s /= 100; l /= 100;
            const k = n => (n + h / 30) % 12;
            const a = s * Math.min(l, 1 - l);
            const f = n => l - a * Math.max(-1, Math.min(k(n) - 3, Math.min(9 - k(n), 1)));
            return "#" + [0, 8, 4].map(n => Math.round(f(n) * 255).toString(16).padStart(2, '0')).join('');
        };
        const getContrastColor = (hslString) => {
            if (!hslString || !hslString.includes('hsl')) return '#000000';
            try {
                const match = hslString.match(/(\d+)\s*,\s*(\d+)%\s*,\s*(\d+)%|\((\d+)\s+(\d+)%\s+(\d+)%\)/);
                let l;
                if (match) { l = parseInt(match[3] || match[6], 10); } else { l = 50; }
                return l > 65 ? '#000000' : '#FFFFFF';
            } catch (e) { return '#000000'; }
        };
        const getRandomHSL = () => {
            const h = Math.floor(Math.random() * 360);
            const s = Math.floor(Math.random() * 20) + 70;
            const l = Math.floor(Math.random() * 20) + 50;
            return `hsl(${h}, ${s}%, ${l}%)`;
        };

        // === UI Rendering (Chat) ===
        window.createMessageHTML = (log) => {
            // â˜… v12: ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            if (log.isSystemLog) {
                return `
                    <div class="flex w-full justify-center my-2">
                        <div class="text-xs text-gray-500 bg-gray-200 py-1 px-3 rounded-full shadow-sm">
                            ${window.escapeHTML(log.text)}
                        </div>
                    </div>
                `;
            }

            const isRole = log.isRole;
            const isAIResponse = log.isAIGenerated;
            const isHumanPost = isRole && (log.makerId === currentUser?.uid);
            const alignmentClass = isHumanPost ? 'justify-end' : 'justify-start';
            let bubbleStyle = '';
            let textStyle = '';
            let bubbleClasses = 'p-3 rounded-xl shadow-md break-words text-left relative';
            let ttsButtonClasses = 'ml-2 text-sm float-right';
            let roleNameColor = 'text-gray-700';
            if (isHumanPost) {
                bubbleClasses += ' chat-bubble-human';
                bubbleStyle = 'background-color: #3b82f6; color: #ffffff; --bubble-color: #3b82f6;';
                ttsButtonClasses += ' text-blue-200 hover:text-white';
                roleNameColor = 'text-blue-700 text-right';
            } else {
                bubbleClasses += ' chat-bubble-ai';
                const role = roles.find(r => r.id === log.senderId);
                let themeColor = role?.themeColor || 'hsl(200, 80%, 60%)';
                if (themeColor === '#ffffff' || themeColor === 'hsl(0, 0%, 100%)') {
                    themeColor = role?.randomFallbackHSL;
                    if (!themeColor) {
                        themeColor = getRandomHSL();
                        if (role) role.randomFallbackHSL = themeColor;
                    }
                }
                const contrastColor = getContrastColor(themeColor);
                bubbleStyle = `background-color: ${themeColor}; color: ${contrastColor}; --bubble-color: ${themeColor};`;
                textStyle = `color: ${contrastColor};`;
                ttsButtonClasses += ` hover:opacity-70`;
                roleNameColor = 'text-gray-700 text-left';
            }
            const role = roles.find(r => r.id === log.senderId);
            const emotion = log.emotion || DEFAULT_EMOTION;
            let avatarHtml = '';

            if (role) {
                const emotionKey = emotion.charAt(0).toUpperCase() + emotion.slice(1);

                // â˜… ä¿®æ­£: URLã‚’å„ªå…ˆã—ã€Base64ã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                const avatarURL = role[`avatar${emotionKey}URL`] || role.avatarStandardURL;
                const avatarBase64 = role[`avatar${emotionKey}Base64`] || role.avatarStandardBase64;
                const mimeType = role.avatarMimeType;

                if (avatarURL) {
                    avatarHtml = `<div class="w-24 h-24 rounded-full overflow-hidden flex-shrink-0 shadow-md"> <img src="${avatarURL}" alt="${log.senderName}ã®è¡¨æƒ…" class="w-full h-full object-cover"> </div>`;
                } else if (avatarBase64 && mimeType) {
                    // (å¤ã„ãƒ‡ãƒ¼ã‚¿ã®ãŸã‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯)
                    avatarHtml = `<div class="w-24 h-24 rounded-full overflow-hidden flex-shrink-0 shadow-md"> <img src="data:${mimeType};base64,${avatarBase64}" alt="${log.senderName}ã®è¡¨æƒ…" class="w-full h-full object-cover"> </div>`;
                }
            }
            if (!avatarHtml) {
                avatarHtml = `<div class="w-24 h-24 rounded-full bg-gray-400 flex items-center justify-center text-2xl font-bold text-white flex-shrink-0 shadow-md">${log.senderName.charAt(0)}</div>`;
            }

            let attachmentHtml = '';
            if (log.attachedImageBase64 && log.attachedImageMimeType) {
                // â˜… ä¿®æ­£: log.attachedImageMimeType ã¯ handleImageAttachment ã¾ãŸã¯ importSettings ã§
                //         'image/png' ã«å›ºå®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’å‰æã¨ã™ã‚‹ã€‚
                //         (ãŸã ã—ã€å¿µã®ç‚ºMimeTypeã‚’ãã®ã¾ã¾ä½¿ç”¨ã—ã¾ã™)
                attachmentHtml = `
                <div class="mt-2 rounded-lg overflow-hidden border ${isHumanPost ? 'border-blue-300' : 'border-gray-400'}">
                    <img src="data:${log.attachedImageMimeType};base64,${log.attachedImageBase64}" alt="æ·»ä»˜ç”»åƒ" class="max-w-xs max-h-48 object-contain cursor-pointer" onclick="window.showImageModal(this.src)">
                </div>
            `;
            }

            const ttsOnclick = log.text ? `window.playTTS(${JSON.stringify(log.senderId)}, ${JSON.stringify(log.text)}, ${JSON.stringify(log.id)})` : '';
            // â˜… ä¿®æ­£: TTSãƒœã‚¿ãƒ³ã®è¡¨ç¤ºæ¡ä»¶ã‚’ã€Œäººé–“ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰ãŒAIã‚’ä»‹ã•ãšã«ç™ºè¨€ã—ãŸãƒ­ã‚°ã§ã¯ãªã„ã€ã«ç·©å’Œ
            // isHumanPostãŒfalseã§ã‚ã‚Œã°ã€ä»–è€…ã®ç™ºè¨€ã€ã¾ãŸã¯AIã®è‡ªå‹•ç™ºè¨€ã€‚ã©ã¡ã‚‰ã‚‚å†ç”Ÿå¯èƒ½ã¨ã™ã¹ãã€‚
            const showTtsButton = log.text && !isHumanPost;

            const messageHtml = `
                <div class="flex w-full mb-3 ${alignmentClass} items-start space-x-2">
                    ${!isHumanPost ? avatarHtml : ''}
                    <div class="max-w-xs sm:max-w-md flex flex-col">
                        <div class="text-xs font-semibold mb-0.5 ${roleNameColor}">
                            ${log.senderName}
                        </div>
                        <div class="${bubbleClasses}" style="${bubbleStyle}">
                            ${log.text ? window.escapeHTML(log.text) : (log.attachedImageBase64 ? ' ' : '(ç™ºè¨€ãªã—)')}
                            ${showTtsButton ? `<button onclick='${ttsOnclick}' class="${ttsButtonClasses}" style="${textStyle}">ğŸ”Š</button>` : ''}
                            ${attachmentHtml}
                        </div>
                    </div>
                    ${isHumanPost ? avatarHtml : ''}
                </div>
            `;
            return messageHtml;
        };
        window.renderChatLogs = (logs) => {
            const logContainer = document.getElementById('dialog-log');
            logContainer.innerHTML = logs.map(window.createMessageHTML).join('') || '<p class="text-center text-gray-500">ã¾ã ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            logContainer.scrollTop = logContainer.scrollHeight;
        };
        window.renderSpeakerDropdown = () => {
            const hiddenSelect = document.getElementById('speaker-select');
            const iconPreview = document.getElementById('speaker-icon-preview');
            if (!currentUser || !hiddenSelect) return;
            const myRoles = roles.filter(r => r.makerId === currentUser.uid);

            // â˜… v23: ä»®æƒ³ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«
            const systemRole = {
                id: 'system_user',
                name: 'ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ« (AIãƒ˜ãƒ«ãƒ—)',
            };

            // â˜… v9: ãƒ­ãƒ¼ãƒ«é¸æŠã®æ°¸ç¶šåŒ–ãƒ­ã‚¸ãƒƒã‚¯ã‚’å¼·åŒ–
            let finalRoleToSelect = null;
            let dbId = null;
            let lsId = null;

            // 1. DBã‹ã‚‰ç¾åœ¨ã®é¸æŠãƒ­ãƒ¼ãƒ«IDã‚’å–å¾— (ãƒ«ãƒ¼ãƒ å…¥å®¤æ™‚ã«æ›´æ–°ã•ã‚Œã‚‹å¯èƒ½æ€§ã‚ã‚Š)
            if (currentRoomId && currentRoomPresence[currentUser.uid]) {
                dbId = currentRoomPresence[currentUser.uid].selectedRole;
            }
            // 2. LocalStorageã‹ã‚‰æœ€å¾Œã«é¸æŠã—ãŸãƒ­ãƒ¼ãƒ«IDã‚’å–å¾— (initializeFirebaseã§DBã‹ã‚‰è¨­å®šã•ã‚Œã¦ã„ã‚‹ã¯ãš)
            try {
                lsId = localStorage.getItem(LAST_SPEAKER_KEY);
            } catch (e) { /* ignore */ }

            // 3. æ¡ç”¨ã™ã‚‹ãƒ­ãƒ¼ãƒ«IDã‚’æ±ºå®š
            // 3a. LocalStorageã«æœ‰åŠ¹ãªIDãŒã‚ã‚Œã°ãã‚Œã‚’å„ªå…ˆ (DBã‹ã‚‰ã®èª­ã¿è¾¼ã¿çµæœ or ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç›´å‰ã«é¸ã‚“ã å€¤)
            // â˜… v23: system_user ã¾ãŸã¯ è‡ªåˆ†ã®AIãƒ­ãƒ¼ãƒ«
            if (lsId && (lsId === 'system_user' || roles.find(r => r.id === lsId && r.makerId === currentUser.uid))) {
                finalRoleToSelect = lsId;
            }
            // 3b. LocalStorageãŒãªã‘ã‚Œã°ã€DBã®IDã‚’è©¦ã™ (ä»–ã®ç«¯æœ«ã§é¸æŠã•ã‚ŒãŸå€¤)
            else if (dbId) {
                finalRoleToSelect = dbId;
            }
            // 3c. å…¨ã¦å¤±æ•—ã—ãŸã‚‰ã€system_user ã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            else {
                finalRoleToSelect = 'system_user';
            }

            // â˜… v9: ã“ã“ã¾ã§

            const chatInput = document.getElementById('chat-input');
            const submitButton = document.querySelector('#chat-form-elements button[type="submit"]');

            // â˜… v23: ãƒ­ãƒ¼ãƒ«ãŒãªãã¦ã‚‚ system_user ãŒã‚ã‚‹ãŸã‚ã€ãƒ­ã‚¸ãƒƒã‚¯ã‚’å¤‰æ›´
            if (myRoles.length === 0 && finalRoleToSelect !== 'system_user') {
                // è‡ªåˆ†ã®ãƒ­ãƒ¼ãƒ«ãŒ0ä»¶ã§ã€é¸æŠä¸­ãªã®ãŒ system_user ã§ã‚‚ãªã„ï¼ˆã‚ã‚Šãˆãªã„ãŒå¿µã®ç‚ºï¼‰
                finalRoleToSelect = 'system_user';
            }

            hiddenSelect.value = finalRoleToSelect;
            window.updateSpeakerIcon(finalRoleToSelect);

            if (chatInput) chatInput.disabled = false;
            if (submitButton) submitButton.disabled = false;

            if (finalRoleToSelect === 'system_user') {
                if (chatInput) chatInput.placeholder = 'AIã¸ã®è³ªå•ï¼ˆæ©Ÿèƒ½è§£èª¬ï¼‰ã‚’å…¥åŠ›...';
            } else if (!currentRoomId) {
                if (chatInput) chatInput.placeholder = 'ãƒ«ãƒ¼ãƒ ã«å…¥å®¤ã—ã¦ãã ã•ã„ã€‚';
                if (chatInput) chatInput.disabled = true;
                if (submitButton) submitButton.disabled = true;
            } else {
                if (chatInput) chatInput.placeholder = 'ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...';
            }
        };
        window.updateSpeakerIcon = (roleId) => {
            // â˜… v23: ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«ã®å‡¦ç†
            if (roleId === 'system_user') {
                const iconPreview = document.getElementById('speaker-icon-preview');
                iconPreview.innerHTML = `<span class="text-xl font-bold">â“</span>`;
                return;
            }

            const role = roles.find(r => r.id === roleId);
            const iconPreview = document.getElementById('speaker-icon-preview');
            if (!role) {
                iconPreview.innerHTML = '<span class="text-gray-500">?</span>'; return;
            }
            const avatarURL = role.avatarStandardURL; // â˜… v6.10 ä¿®æ­£
            const mimeType = role.avatarMimeType || 'image/png';
            if (avatarURL) { // â˜… v6.10 ä¿®æ­£
                iconPreview.innerHTML = `<img src="${avatarURL}" class="w-full h-full object-cover rounded-full">`;
            } else {
                iconPreview.innerHTML = `<span class="text-sm font-bold">${role.name.charAt(0)}</span>`;
            }
        };
        window.openSpeakerSelector = () => {
            const modal = document.getElementById('speaker-selector-modal');
            const content = document.getElementById('speaker-selector-content');
            const myRoles = roles.filter(r => r.makerId === currentUser.uid);

            // â˜… v23: ä»®æƒ³ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«
            const systemRole = {
                id: 'system_user',
                name: 'ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ« (AIãƒ˜ãƒ«ãƒ—)',
                avatarStandardBase64: null, // ã‚¢ãƒã‚¿ãƒ¼ãªã—
            };

            // â˜… v23: è‡ªåˆ†ã®ãƒ­ãƒ¼ãƒ«ã®å‰ã«ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«ã‚’è¿½åŠ 
            const allSelectableRoles = [systemRole, ...myRoles];

            if (allSelectableRoles.length === 0) { // (åŸºæœ¬ã‚ã‚Šãˆãªã„)
                content.innerHTML = '<p class="col-span-4 text-center text-gray-500 py-8">é¸æŠå¯èƒ½ãªãƒ­ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            } else {
                content.innerHTML = allSelectableRoles.map(role => {
                    const avatarURL = role.avatarStandardURL;
                    const avatarBase64 = role.avatarStandardBase64; // (v6.10 ã«ã¯ãªã„ãŒã€client.html ã«ã¯æ®‹ã™)
                    const mimeType = role.avatarMimeType || 'image/png';
                    const isSelected = document.getElementById('speaker-select').value === role.id;

                    let avatarHtml = ''; // â˜… ä¿®æ­£: avatarHtml ã‚’ã“ã“ã§å®£è¨€

                    if (role.id === 'system_user') {
                        avatarHtml = `<div class="w-full h-full flex items-center justify-center text-3xl font-bold">â“</div>`;
                    } else if (avatarURL) {
                        // â˜… ä¿®æ­£: iconPreview.innerHTML ã§ã¯ãªã avatarHtml ã«ä»£å…¥
                        avatarHtml = `<img src="${avatarURL}" class="w-full h-full object-cover">`;
                    } else if (avatarBase64) {
                        // â˜… ä¿®æ­£: iconPreview.innerHTML ã§ã¯ãªã avatarHtml ã«ä»£å…¥
                        avatarHtml = `<img src="data:${mimeType};base64,${avatarBase64}" class="w-full h-full object-cover">`;
                    } else {
                        avatarHtml = `<div class="w-full h-full flex items-center justify-center text-xl font-bold">${role.name.charAt(0)}</div>`;
                    }

                    return `
                        <button type="button" onclick="window.selectSpeaker('${role.id}')" 
                            class="flex flex-col items-center p-2 rounded-lg hover:bg-gray-100 transition ${isSelected ? 'bg-indigo-100 ring-2 ring-indigo-500' : ''}">
                            <div class="w-16 h-16 rounded-full overflow-hidden mb-1 ${isSelected ? 'ring-2 ring-indigo-600' : 'bg-gray-300'}">
                                ${avatarHtml}
                            </div>
                            <span class="text-xs text-center truncate w-full">${window.escapeHTML(role.name)}</span>
                        </button>
                    `;
                }).join('');
            }
            modal.classList.remove('hidden');
        };
        window.selectSpeaker = (roleId) => {
            const hiddenSelect = document.getElementById('speaker-select');
            hiddenSelect.value = roleId;
            window.updateSpeakerIcon(roleId);
            window.updateSelectedRole(roleId);
            // â˜… v4: é¸æŠã—ãŸãƒ­ãƒ¼ãƒ«ã‚’LocalStorageã«ä¿å­˜
            try {
                localStorage.setItem(LAST_SPEAKER_KEY, roleId);
            } catch (e) { console.warn("LocalStorage write failed for speaker key."); }
            window.closeSpeakerSelector();
            window.renderSpeakerDropdown(); // â˜… v23: system_user é¸æŠæ™‚ã®Placeholderæ›´æ–°ã®ãŸã‚
        };
        window.closeSpeakerSelector = (event) => {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('speaker-selector-modal');
            modal.classList.add('hidden');
        };

        // === UI Rendering - Role Management ===

        // â˜… v12: ãƒ­ãƒ¼ãƒ«æ‹›å¾… (ãƒ«ãƒ¼ãƒ å†…) ã¨ãƒ­ã‚°æŠ•ç¨¿
        window.toggleRoleInvite = async (roleId) => {
            const role = roles.find(r => r.id === roleId);
            if (!role || !currentRoomId) {
                window.displayTemporaryMessage("ãƒ«ãƒ¼ãƒ ã«å…¥å®¤ã—ã¦ã‹ã‚‰æ‹›å¾…ã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            const isInvited = currentRoomInvitedRoles[roleId];
            const inviteRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId, 'invited_roles', roleId);
            try {
                if (isInvited) {
                    await deleteDoc(inviteRef);
                    // ãƒ­ãƒ¼ãƒ«é€€å‡ºãƒ­ã‚°
                    await window.addNewLogToFirestore({
                        senderId: 'system', senderName: 'ã‚·ã‚¹ãƒ†ãƒ ', text: `ãƒ­ãƒ¼ãƒ«ã€Œ${role.name}ã€ã®æ‹›å¾…ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸã€‚`,
                        isRole: false, makerId: currentUser.uid, isAIGenerated: false,
                        isSystemLog: true, systemType: 'role_leave', emotion: 'standard', timestamp: serverTimestamp()
                    });
                } else {
                    if (!usersOnline[role.makerId]) {
                        window.displayTemporaryMessage(`ãƒ­ãƒ¼ãƒ« ${role.name} ã®è£½ä½œè€…ãŒã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã®ãŸã‚æ‹›å¾…ã§ãã¾ã›ã‚“ã€‚`);
                        return;
                    }
                    await setDoc(inviteRef, { roleId: role.id, name: role.name, invitedAt: serverTimestamp() });
                    // ãƒ­ãƒ¼ãƒ«å‚åŠ ãƒ­ã‚°
                    await window.addNewLogToFirestore({
                        senderId: 'system', senderName: 'ã‚·ã‚¹ãƒ†ãƒ ', text: `ãƒ­ãƒ¼ãƒ«ã€Œ${role.name}ã€ãŒæ‹›å¾…ã•ã‚Œã¾ã—ãŸã€‚`,
                        isRole: false, makerId: currentUser.uid, isAIGenerated: false,
                        isSystemLog: true, systemType: 'role_join', emotion: 'standard', timestamp: serverTimestamp()
                    });
                }
            } catch (error) {
                console.error("Error toggling role invite status:", error);
            }
        };

        // â˜… v3: ãƒ­ãƒ¼ãƒ«ç®¡ç†UI (ãƒ«ãƒ¼ãƒ ãƒ»ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š)
        window.renderRoleManagementUI = () => {
            const container = document.getElementById('role-list-container');
            if (!container) return; // â˜… ä¿®æ­£
            if (!currentUser) {
                container.innerHTML = '<p class="text-center text-gray-500 p-4">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãƒ­ãƒ¼ãƒ«ã‚’ç®¡ç†ã—ã¾ã—ã‚‡ã†ã€‚</p>';
                return;
            }
            const makerId = currentUser.uid;
            container.innerHTML = roles.map(role => {
                const isMaker = role.makerId === makerId;
                const isOnline = usersOnline[role.makerId];
                const statusColor = isOnline ? 'bg-green-500' : 'bg-red-500';

                // â˜… v3: æ‹›å¾…ãƒœã‚¿ãƒ³ã®åˆ¶å¾¡
                let inviteButtonHtml = '';
                if (currentRoomId) {
                    const isInvited = currentRoomInvitedRoles[role.id];
                    const activeClass = isInvited ? 'bg-purple-600 hover:bg-purple-700' : 'bg-gray-400 hover:bg-gray-500';
                    inviteButtonHtml = `
                        <button onclick="window.toggleRoleInvite('${role.id}')" 
                                class="flex-grow px-3 py-1 text-sm font-semibold text-white rounded-lg transition ${activeClass}"
                                ${!isOnline && !isInvited ? 'disabled title="è£½ä½œè€…ãŒã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã®ãŸã‚æ‹›å¾…ä¸å¯"' : ''}>
                            ${isInvited ? 'æ‹›å¾…ä¸­ (ON)' : 'æ‹›å¾… (OFF)'}
                        </button>
                    `;
                } else {
                    inviteButtonHtml = `
                        <button class="flex-grow px-3 py-1 text-sm font-semibold text-white rounded-lg bg-gray-300 cursor-not-allowed" disabled title="ãƒ«ãƒ¼ãƒ ã«å…¥å®¤ã—ã¦æ‹›å¾…">
                            æ‹›å¾… (OFF)
                        </button>
                    `;
                }

                return `
                    <div class="p-3 mb-2 bg-white rounded-lg shadow-md border border-gray-200">
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-gray-800">${window.escapeHTML(role.name)}</h3>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs font-medium text-gray-500">è£½ä½œè€…: ${window.escapeHTML(role.makerDisplayName || 'ä¸æ˜')}</span>
                                <div class="w-3 h-3 rounded-full ${statusColor}" title="${isOnline ? 'è£½ä½œè€…ã‚ªãƒ³ãƒ©ã‚¤ãƒ³' : 'è£½ä½œè€…ã‚ªãƒ•ãƒ©ã‚¤ãƒ³'}"></div>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mt-1 truncate">${window.escapeHTML(role.systemPrompt.substring(0, 80))}...</p>
                        <div class="mt-3 flex justify-between space-x-2">
                            ${isMaker ? `
                                <button onclick="window.openRoleEditor('${role.id}')" class="px-3 py-1 text-sm font-medium bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition">ç·¨é›†</button>
                                <button onclick="window.showDeleteConfirm('${role.id}', '${window.escapeHTML(role.name)}')" class="px-3 py-1 text-sm font-medium bg-red-500 text-white rounded-lg hover:bg-red-600 transition">å‰Šé™¤</button>
                            ` : `<button class="px-3 py-1 text-sm font-medium bg-gray-300 text-gray-600 rounded-lg cursor-not-allowed">ç·¨é›†ä¸å¯</button>`}
                            ${inviteButtonHtml}
                        </div>
                    </div>
                `;
            }).join('') || '<p class="text-center text-gray-500 p-4">ã¾ã ãƒ­ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œè‡ªåˆ†ã®åˆ†èº«ã‚’ä½œæˆã€ã—ã¾ã—ã‚‡ã†ã€‚</p>';
        };

        // â˜… v3: æ‹›å¾…ãƒ­ãƒ¼ãƒ«ä¸€è¦§ (ãƒ«ãƒ¼ãƒ å†…ãƒ˜ãƒƒãƒ€ãƒ¼)
        window.renderActiveRoles = () => {
            const container = document.getElementById('active-roles-container');
            if (!container || !currentUser || !currentRoomId) {
                if (container) container.innerHTML = '<p class="text-xs text-gray-500 p-2">ãƒ«ãƒ¼ãƒ ã«å…¥å®¤ã—ã¦ã„ã¾ã›ã‚“ã€‚</p>';
                return;
            }
            const activeRoleElements = Object.keys(currentRoomInvitedRoles).map(roleId => {
                const role = roles.find(r => r.id === roleId);
                if (!role) return '';
                const isOnline = usersOnline[role.makerId];
                const statusColor = isOnline ? 'bg-green-500' : 'bg-red-500';
                const tooltip = isOnline ? 'è£½ä½œè€…ã‚ªãƒ³ãƒ©ã‚¤ãƒ³' : 'è£½ä½œè€…ã‚ªãƒ•ãƒ©ã‚¤ãƒ³';
                const iconSource = role.avatarStandardURL;
                return `
                    <div class="flex items-center space-x-1 p-1 bg-white rounded-full shadow-sm border border-gray-300">
                        ${iconSource ? `<img src="${iconSource}" class="w-6 h-6 rounded-full object-cover flex-shrink-0" alt="${role.name}">` : `<div class="w-6 h-6 rounded-full bg-gray-500 text-white text-xs flex items-center justify-center flex-shrink-0">${role.name.charAt(0)}</div>`}
                        <span class="text-xs font-medium text-gray-700 truncate max-w-[80px]">${window.escapeHTML(role.name)}</span>
                        <div class="w-2 h-2 rounded-full ${statusColor}" title="${tooltip}"></div>
                    </div>
                `;
            }).join('');
            container.innerHTML = activeRoleElements || '<p class="text-xs text-gray-500 p-2">ã“ã®ãƒ«ãƒ¼ãƒ ã«ãƒ­ãƒ¼ãƒ«ãŒæ‹›å¾…ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>';
        };

        // (æ—¢å­˜ã® openRoleEditor é–¢æ•°ã‚’ã“ã‚Œã§ç½®ãæ›ãˆ)
        window.openRoleEditor = (roleId = null) => {
            if (!currentUser) { //
                window.displayTemporaryMessage("ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");
                return;
            }
            const modal = document.getElementById('role-editor-modal'); //
            const content = document.getElementById('role-editor-content'); //
            const hslToHexPicker = (hsl) => { //
                if (!hsl || !hsl.includes('hsl')) return '#ffffff';
                try {
                    const match = hsl.match(/(\d+)\s*,\s*(\d+)%\s*,\s*(\d+)%|\((\d+)\s+(\d+)%\s+(\d+)%\)/); //
                    if (!match) return '#ffffff';
                    const h = parseInt(match[1] || match[4], 10);
                    const s = parseInt(match[2] || match[5], 10);
                    const l = parseInt(match[3] || match[6], 10);
                    return hslToHex(h, s, l); //
                } catch (e) { return '#ffffff'; }
            };
            let role = {
                id: null, name: '', systemPrompt: '', memory: '',
                ttsVoice: TTS_VOICES[0].name, themeColor: getRandomHSL(),
                // â˜… ä¿®æ­£: Base64 -> URL/StoragePath (Base64ã‚‚æ®‹ã™)
                avatarStandardURL: '', avatarStandardStoragePath: '', avatarStandardBase64: '',
                avatarHappyURL: '', avatarHappyStoragePath: '', avatarHappyBase64: '',
                avatarSadURL: '', avatarSadStoragePath: '', avatarSadBase64: '',
                avatarCuriosityURL: '', avatarCuriosityStoragePath: '', avatarCuriosityBase64: '',
                avatarMimeType: 'image/png', isActive: false
            };
            let isNew = true;
            if (roleId) {
                const existingRole = roles.find(r => r.id === roleId); //
                if (existingRole) {
                    role = { ...role };
                    Object.assign(role, existingRole); //
                    isNew = false;
                    if (role.makerId !== currentUser.uid) { //
                        window.displayTemporaryMessage("ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã—ãŸãƒ­ãƒ¼ãƒ«ã¯ç·¨é›†ã§ãã¾ã›ã‚“ã€‚");
                        return;
                    }
                }
            }
            const themeColorHex = hslToHexPicker(role.themeColor); //
            const ttsOptions = TTS_VOICES.map(voice => //
                `<option value="${voice.name}" ${voice.name === role.ttsVoice ? 'selected' : ''}>${voice.name} (${voice.description})</option>`
            ).join('');
            const emotions = ['Standard', 'Happy', 'Sad', 'Curiosity'];
            const avatarInputs = emotions.map(emotion => {
                const urlKey = `avatar${emotion}URL`;
                const pathKey = `avatar${emotion}StoragePath`;
                const base64Key = `avatar${emotion}Base64`; // â˜… Base64ã‚­ãƒ¼ã‚‚æ®‹ã™

                const currentURL = role[urlKey] || '';
                const currentPath = role[pathKey] || '';
                const currentBase64 = role[base64Key] || ''; // â˜… Base64ã‚‚èª­ã¿è¾¼ã‚€

                // â˜… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ­ã‚¸ãƒƒã‚¯: URLå„ªå…ˆã€ãªã‘ã‚Œã°Base64
                const displaySrc = currentURL ? currentURL : (currentBase64 ? `data:${role.avatarMimeType || 'image/png'};base64,${currentBase64}` : '');

                return `
                    <div class="col-span-1 border p-3 rounded-lg bg-gray-50">
                        <label class="block text-sm font-medium text-gray-700 mb-2">${EMOTIONS[emotion.toLowerCase()]?.label || emotion} ã‚¢ãƒã‚¿ãƒ¼</label>
                        <div class="mb-2 h-16 flex items-center justify-center border-b pb-2">
                            <img id="avatar-preview-${emotion}" src="${displaySrc}" class="w-16 h-16 rounded-full object-cover shadow ${displaySrc ? '' : 'hidden'}" alt="${emotion} avatar">
                            <div id="placeholder-preview-${emotion}" class="w-16 h-16 rounded-full bg-gray-300 flex items-center justify-center text-xs ${displaySrc ? 'hidden' : ''}">æœªè¨­å®š</div>
                        </div>
                        <input type="file" id="file-${emotion}" accept="image/*, image/svg+xml" class="hidden" onchange="window.handleLocalFileChange(this, '${emotion}')">
                        <button type="button" onclick="document.getElementById('file-${emotion}').click()" class="w-full mt-2 text-xs py-1.5 bg-indigo-500 text-white rounded hover:bg-indigo-600 transition">ç”»åƒã‚’é¸æŠ</button>
                        <button type="button" onclick="window.clearAvatar('${emotion}')" class="w-full mt-1 text-xs py-1 bg-red-500 text-white rounded hover:bg-red-600 transition">ã‚¯ãƒªã‚¢</button>
                        
                        <input type="hidden" id="${urlKey}" name="${urlKey}" value="${currentURL}">
                        <input type="hidden" id="${pathKey}" name="${pathKey}" value="${currentPath}">
                        <input type="hidden" id="${base64Key}" name="${base64Key}" value="${currentBase64}">
                    </div>
                `;
            }).join('');

            // â˜…â˜…â˜… Electroné€£æºç”¨ è¿½åŠ  â˜…â˜…â˜…
            // 1. AIãƒªã‚¹ãƒˆã‹ã‚‰ <option> HTMLã‚’ç”Ÿæˆ
            let aiOptions = '<option value="">(é€£æºãªã— / ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆAI)</option>';
            if (electronAIList.length > 0) {
                aiOptions += electronAIList.map(ai =>
                    `<option value="${ai.id}">${ai.name} (${ai.id})</option>`
                ).join('');
            } else if (isElectronHost) {
                aiOptions = '<option value="" disabled>(Electron AIãŒæœªè¨­å®šã§ã™)</option>';
            } else {
                aiOptions = '<option value="" disabled>(Electronãƒ›ã‚¹ãƒˆç’°å¢ƒã§ã¯ã‚ã‚Šã¾ã›ã‚“)</option>';
            }

            // 2. æ—¢å­˜ã®ãƒ­ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ (role) ã‹ã‚‰é€£æºAI IDã‚’å–å¾—
            const currentLinkedAi = role.linkedAiId || "";
            // (aiOptions ã®ä¸­ã§ã€currentLinkedAi ã¨ä¸€è‡´ã™ã‚‹ <option> ã« 'selected' ã‚’è¿½åŠ )
            aiOptions = aiOptions.replace(`value="${currentLinkedAi}"`, `value="${currentLinkedAi}" selected`);
            // â˜…â˜…â˜… ã“ã“ã¾ã§ â˜…â˜…â˜…

            content.innerHTML = `
                <h2 class="text-2xl font-bold text-indigo-700 mb-4">${isNew ? 'æ–°è¦ãƒ­ãƒ¼ãƒ«ä½œæˆ' : 'ãƒ­ãƒ¼ãƒ«ç·¨é›†'}</h2>
                <form id="role-form" onsubmit="window.saveRole(event)">
                    <input type="hidden" id="roleId" value="${role.id || ''}">
                    <div class="mb-4">
                        <label for="name" class="block text-sm font-medium text-gray-700">ãƒ­ãƒ¼ãƒ«å</label>
                        <input type="text" id="name" name="name" value="${window.escapeHTML(role.name)}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                    <div class="mb-4">
                        <label for="themeColor" class="block text-sm font-medium text-gray-700">ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ï¼ˆAIç™ºè¨€æ™‚ã®ãƒãƒ–ãƒ«è‰²ï¼‰</label>
                        <input type="color" id="themeColor" name="themeColor" value="${themeColorHex}" class="mt-1 block rounded-md border-gray-300 shadow-sm border h-10 w-20 p-1">
                        <p class="text-xs text-gray-500 mt-1">â€»ãƒ©ãƒ³ãƒ€ãƒ è‰²(HSL)ã®å ´åˆã€ãƒ”ãƒƒã‚«ãƒ¼ã¯ç™½ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                    </div>
                    <div class="mb-4">
                        <label for="ttsVoice" class="block text-sm font-medium text-gray-700">TTSãƒœã‚¤ã‚¹</label>
                        <div class="flex items-center space-x-2">
                            <select id="ttsVoice" name="ttsVoice" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                                ${ttsOptions}
                            </select>
                            <button type="button" id="tts-sample-button" onclick="window.playTTSSample()" class="mt-1 px-3 py-2 text-sm font-medium bg-cyan-500 text-white rounded-lg hover:bg-cyan-600 transition">ğŸ”Š ã‚µãƒ³ãƒ—ãƒ«å†ç”Ÿ</button>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="def-linked-ai" class="block text-sm font-medium text-gray-700">é€£æºå¤–éƒ¨AI (Electron)</label>
                        <select id="def-linked-ai" name="linkedAiId" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" ${!isElectronHost ? 'disabled' : ''}>
                            ${aiOptions}
                        </select>
                        <p class="text-xs text-gray-500 mt-1">
                            ãƒ›ã‚¹ãƒˆãŒElectronã‚¢ãƒ—ãƒªã§èµ·å‹•ã—ã¦ã„ã‚‹å ´åˆã€ã“ã“ã§é¸æŠã—ãŸAIãŒå¿œç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
                            (Electronå´ã§ã‚¹ãƒ­ãƒƒãƒˆã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™)
                        </p>
                    </div>
                    <div class="mb-4">
                        <label for="systemPrompt" class="block text-sm font-medium text-gray-700">System Prompt (äººæ ¼å®šç¾©)</label>
                        <textarea id="systemPrompt" name="systemPrompt" rows="4" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">${window.escapeHTML(role.systemPrompt)}</textarea>
                    </div>
                    <div class="mb-4 flex items-center justify-between">
                        <button type="button" onclick="window.callPromptProposalAPI('${role.id || ''}')" class="px-4 py-2 text-sm font-semibold bg-green-500 text-white rounded-lg hover:bg-green-600 transition shadow-md">
                            âœ¨ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã‚’AIã«ä»»ã›ã‚‹ (Standardã‚’ç”Ÿæˆã—å·®åˆ†ç·¨é›†)
                        </button>
                        <span id="proposal-status" class="text-sm text-gray-600 ml-4"></span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2 mt-6">ã‚¢ãƒã‚¿ãƒ¼ç”»åƒ (æ„Ÿæƒ…åˆ¥)</h3>
                    <div class="grid grid-cols-4 gap-4 mb-4">
                        ${avatarInputs}
                    </div>
                    <input type="hidden" id="avatarMimeType" name="avatarMimeType" value="${role.avatarMimeType || 'image/png'}">
                    <div class="mb-6 border-t pt-4">
                        <div class="flex justify-between items-center mb-2">
                             <label for="memory" class="block text-sm font-medium text-gray-700">è¨˜æ†¶ (Memory)</label>
                             <button type="button" onclick="window.updateRoleMemory('${role.id || ''}')" class="px-3 py-1 text-xs font-semibold bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition shadow-sm" ${!currentRoomId ? 'disabled title="ãƒ«ãƒ¼ãƒ ã«å…¥å®¤ã—ã¦ãã ã•ã„"' : ''}>
                                âœ¨ è¨˜æ†¶ã‚’æ‰‹å‹•æ›´æ–° (ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ )
                            </button>
                        </div>
                        <textarea id="memory" name="memory" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">${window.escapeHTML(role.memory || '')}</textarea>
                        <p class="text-xs text-gray-500 mt-1">â€»è¨˜æ†¶ã¯åˆ¶ä½œè€…ãŒå…¥å®¤ä¸­ã®ãƒ«ãƒ¼ãƒ ã§10åˆ†ãŠãã«è‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã™ã€‚</p>
                    </div>
                    <div class="flex justify-end space-x-3 border-t pt-4">
                        <button type="button" onclick="window.closeRoleEditor()" class="px-4 py-2 text-sm font-medium bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button type="submit" class="px-4 py-2 text-sm font-semibold bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">${isNew ? 'ä½œæˆ' : 'æ›´æ–°'}</button>
                    </div>
                </form>
            `;
            modal.classList.remove('hidden'); //
        };

        window.closeRoleEditor = (event) => {
            if (!event || event.target.id === 'role-editor-modal') {
                document.getElementById('role-editor-modal').classList.add('hidden');
            }
        };
        window.createMyTemplateRole = async () => {
            if (!currentUser) {
                window.displayTemporaryMessage("ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚"); return;
            }
            window.toggleUI(true, 'åˆ†èº«ã‚’ä½œæˆä¸­...');
            try {
                const rolesRef = collection(db, 'artifacts', appId, 'public', 'data', 'roles');
                const q = query(rolesRef, where("makerId", "==", currentUser.uid), where("isTemplate", "==", true));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    window.displayTemporaryMessage(`ã€Œ${currentUserName}ã€ã®åˆ†èº«ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚`);
                    window.toggleUI(false); return;
                }
                const defaultVoice = TTS_VOICES.find(v => v.name === 'Kore') || TTS_VOICES[0];
                const templateColor = getRandomHSL();
                const templateRole = {
                    name: currentUserName,
                    systemPrompt: `${currentUserName}ã¨ã—ã¦ã€ã‚ãªãŸã®ç™ºè¨€ã‚’ãã®ã¾ã¾ãƒãƒ£ãƒƒãƒˆã«åæ˜ ã—ã¾ã™ã€‚ç‰¹åˆ¥ãªäººæ ¼ã¯è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚`,
                    memory: "", ttsVoice: defaultVoice.name, themeColor: templateColor,
                    avatarMimeType: "image/png", avatarStandardBase64: "", avatarHappyBase64: "", avatarSadBase64: "", avatarCuriosityBase64: "",
                    makerId: currentUser.uid, makerDisplayName: currentUserName,
                    isActive: false, isTemplate: true
                };
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'roles'), templateRole);
                window.displayTemporaryMessage(`ã€Œ${currentUserName}ã€ã®åˆ†èº«ã‚’ä½œæˆã—ã¾ã—ãŸï¼`);
                window.toggleLeftColumn();
            } catch (error) {
                console.error("Error creating template role:", error);
            } finally {
                window.toggleUI(false);
            }
        };
        window.clearAvatar = async (emotion) => {
            const urlKey = `avatar${emotion}URL`;
            const pathKey = `avatar${emotion}StoragePath`;
            const base64Key = `avatar${emotion}Base64`; // â˜…
            const previewId = `avatar-preview-${emotion}`;
            const placeholderId = `placeholder-preview-${emotion}`;

            const storagePath = document.getElementById(pathKey).value;
            if (storagePath) {
                // Storageã‹ã‚‰å¤ã„ç”»åƒã‚’éåŒæœŸã§å‰Šé™¤
                await window.deleteAvatarFromStorage(storagePath).catch(e => console.warn("Old avatar deletion failed:", e));
            }

            document.getElementById(urlKey).value = '';
            document.getElementById(pathKey).value = '';
            document.getElementById(base64Key).value = ''; // â˜… Base64ã‚‚ã‚¯ãƒªã‚¢

            const preview = document.getElementById(previewId);
            if (preview) { preview.src = ''; preview.classList.add('hidden'); }
            const placeholder = document.getElementById(placeholderId);
            if (placeholder) { placeholder.classList.remove('hidden'); }
        };
        window.handleLocalFileChange = async (fileInput, emotion) => {
            const file = fileInput.files[0];
            const urlKey = `avatar${emotion}URL`;
            const pathKey = `avatar${emotion}StoragePath`;
            const base64Key = `avatar${emotion}Base64`; // â˜…
            const previewId = `avatar-preview-${emotion}`;
            const placeholderId = `placeholder-preview-${emotion}`;
            if (!file) return;

            // â˜… v6.1: å¤ã„ç”»åƒãŒã‚ã‚Œã°Storageã‹ã‚‰å‰Šé™¤
            const oldStoragePath = document.getElementById(pathKey).value;
            if (oldStoragePath) {
                await window.deleteAvatarFromStorage(oldStoragePath).catch(e => console.warn("Old avatar deletion failed:", e));
            }

            window.toggleUI(true, 'ã‚¢ãƒã‚¿ãƒ¼ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...');
            try {
                // â˜… v6.1: Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (ã•ã£ãè¿½åŠ ã—ãŸé–¢æ•°)
                const { url, path, mimeType } = await window.uploadAvatarToStorage(file);

                document.getElementById(urlKey).value = url;
                document.getElementById(pathKey).value = path;
                document.getElementById(base64Key).value = ''; // â˜… Base64ã¯ã‚¯ãƒªã‚¢
                document.getElementById('avatarMimeType').value = mimeType; // MimeTypeã‚’æ›´æ–°

                const preview = document.getElementById(previewId);
                const placeholder = document.getElementById(placeholderId);
                if (preview) { preview.src = url; preview.classList.remove('hidden'); }
                if (placeholder) { placeholder.classList.add('hidden'); }

            } catch (error) {
                console.error("Local file handling error (Storage Upload):", error);
                window.displayTemporaryMessage("ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
                fileInput.value = '';
                document.getElementById(urlKey).value = '';
                document.getElementById(pathKey).value = '';
                document.getElementById(base64Key).value = ''; // â˜… ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚Base64ã‚¯ãƒªã‚¢
            } finally {
                window.toggleUI(false);
            }
        };


        // (æ—¢å­˜ã® saveRole é–¢æ•°ã‚’ã“ã‚Œã§ç½®ãæ›ãˆ)
        window.saveRole = async (e) => {
            e.preventDefault();
            const form = document.getElementById('role-form');
            const roleId = form.roleId.value;
            const themeColorHex = form.themeColor.value;
            const themeColorHSL = hexToHsl(themeColorHex);
            const themeColor = `hsl(${themeColorHSL.h}, ${themeColorHSL.s}%, ${themeColorHSL.l}%)`;

            // â˜… Base64ã‚’Blobã«å¤‰æ›ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ (saveRoleå†…ã«è¿½åŠ )
            const base64ToBlob = (base64, mimeType) => {
                try {
                    const byteCharacters = atob(base64);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    return new Blob([byteArray], { type: mimeType });
                } catch (e) { console.error("Base64 to Blob conversion failed:", e); return null; }
            };

            window.toggleUI(true, 'ãƒ­ãƒ¼ãƒ«ã‚’ä¿å­˜ä¸­ (ã‚¢ãƒã‚¿ãƒ¼ã‚’å‡¦ç†ä¸­)...'); // â˜… ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¤‰æ›´

            const roleData = {
                name: form.name.value,
                systemPrompt: form.systemPrompt.value,
                ttsVoice: form.ttsVoice.value,
                themeColor: themeColor,
                memory: form.memory.value, // (client.html ã® memory ã‚’ç¶­æŒ)
                avatarMimeType: form.avatarMimeType.value || 'image/png',
                linkedAiId: form['def-linked-ai'] ? form['def-linked-ai'].value : "",
                makerId: currentUser.uid,
                makerDisplayName: currentUserName,
                isTemplate: false
            };

            // â˜… ã‚¢ãƒã‚¿ãƒ¼å‡¦ç† (L2542 ã‚ãŸã‚Š)
            const emotions = ['Standard', 'Happy', 'Sad', 'Curiosity'];
            for (const emotion of emotions) {
                const urlKey = `avatar${emotion}URL`;
                const pathKey = `avatar${emotion}StoragePath`;
                const base64Key = `avatar${emotion}Base64`;

                let url = form[urlKey].value;
                let path = form[pathKey].value;
                const base64 = form[base64Key].value;
                let mimeType = roleData.avatarMimeType; // (ãƒ•ã‚©ãƒ¼ãƒ ã®MimeTypeã‚’å–å¾—)

                // 1. URLã‚‚Base64ã‚‚ãªã„ (ã‚¯ãƒªã‚¢ã•ã‚ŒãŸ)
                if (!url && !base64) {
                    roleData[urlKey] = '';
                    roleData[pathKey] = '';
                    // (å¤ã„ãƒ‘ã‚¹ãŒã‚ã‚Œã°å‰Šé™¤)
                    if (roleId) {
                        const oldRole = roles.find(r => r.id === roleId);
                        const oldPath = oldRole ? oldRole[pathKey] : null;
                        if (oldPath) await window.deleteAvatarFromStorage(oldPath);
                    }
                    continue;
                }

                // 2. Base64ãŒã‚ã‚Šã€URLãŒãªã„ (AIææ¡ˆ or å¤ã„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ)
                if (base64 && !url) {
                    window.displayTemporaryMessage(`ã‚¢ãƒã‚¿ãƒ¼(${emotion})ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...`);

                    // AIææ¡ˆAPI (Imagen) ã¯ 'image/png' ã‚’è¿”ã™
                    if (base64Key === 'avatarStandardBase64') mimeType = IMAGEN_MIME_TYPE;

                    const blob = base64ToBlob(base64, mimeType);
                    if (blob) {
                        try {
                            // â˜… uploadAvatarToStorage ã¯ãƒªã‚µã‚¤ã‚ºã‚‚è¡Œã†
                            const { url: newUrl, path: newPath, mimeType: newMime } = await window.uploadAvatarToStorage(
                                new File([blob], `${emotion.toLowerCase()}_avatar.png`, { type: mimeType })
                            );
                            roleData[urlKey] = newUrl;
                            roleData[pathKey] = newPath;
                            roleData.avatarMimeType = newMime; // MimeTypeã‚’æ›´æ–°
                        } catch (uploadError) {
                            console.error(`Failed to upload generated avatar ${emotion}:`, uploadError);
                            roleData[urlKey] = ''; // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—
                            roleData[pathKey] = '';
                        }
                    }
                }
                // 3. URLãŒã‚ã‚‹ (å¤‰æ›´ãªã— or ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã§æ›´æ–°æ¸ˆã¿)
                else if (url) {
                    roleData[urlKey] = url;
                    roleData[pathKey] = path;
                }
            }

            // (L2567) å¿…é ˆãƒã‚§ãƒƒã‚¯
            if (!roleData.name || !roleData.systemPrompt) {
                window.displayTemporaryMessage("ãƒ­ãƒ¼ãƒ«åã¨System Promptã¯å¿…é ˆã§ã™ã€‚");
                window.toggleUI(false); // â˜… UIãƒ­ãƒƒã‚¯è§£é™¤
                return;
            }

            // (L2571) Firestore ã¸ã®ä¿å­˜
            try {
                if (roleId) {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roles', roleId), roleData, { merge: true });
                } else {
                    roleData.isActive = false;
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'roles'), roleData);
                }
                window.displayTemporaryMessage("ãƒ­ãƒ¼ãƒ«ãŒæ­£å¸¸ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸï¼");
                window.closeRoleEditor();
            } catch (error) {
                console.error("Error saving role:", error);
            } finally {
                window.toggleUI(false);
            }
        };

        window.showDeleteConfirm = (roleId, roleName) => {
            const modal = document.getElementById('delete-confirm-modal');
            const content = document.getElementById('delete-confirm-content');
            content.innerHTML = `
                <h3 class="text-xl font-bold text-red-700 mb-4">ãƒ­ãƒ¼ãƒ«å‰Šé™¤ã®ç¢ºèª</h3>
                <p class="text-gray-700 mb-6">æœ¬å½“ã«ãƒ­ãƒ¼ãƒ«ã€Œ<strong class="font-bold">${roleName}</strong>ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ<br>ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚</p>
                <div class="flex justify-end space-x-3">
                    <button onclick="window.closeDeleteConfirm()" class="px-4 py-2 text-sm font-medium bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button onclick="window.deleteRole('${roleId}')" class="px-4 py-2 text-sm font-semibold bg-red-600 text-white rounded-lg hover:bg-red-700 transition">å‰Šé™¤ã™ã‚‹</button>
                </div>
            `;
            modal.classList.remove('hidden');
        };
        window.closeDeleteConfirm = () => {
            document.getElementById('delete-confirm-modal').classList.add('hidden');
        };

        // â˜… v7: ãƒ«ãƒ¼ãƒ å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«
        window.showDeleteRoomConfirm = (roomId, roomName) => {
            const modal = document.getElementById('delete-confirm-modal'); // åŒã˜ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’æµç”¨
            const content = document.getElementById('delete-confirm-content');
            // roomName ãŒã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚Œã¦ ' ãŒ &#x27; ã«ãªã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€å…ƒã«æˆ»ã™
            const unescapedRoomName = roomName.replace(/&#x27;/g, "'").replace(/&quot;/g, '"').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&');

            content.innerHTML = `
                <h3 class="text-xl font-bold text-red-700 mb-4">ãƒ«ãƒ¼ãƒ å‰Šé™¤ã®ç¢ºèª</h3>
                <p class="text-gray-700 mb-6">æœ¬å½“ã«ãƒ«ãƒ¼ãƒ ã€Œ<strong class="font-bold">${window.escapeHTML(unescapedRoomName)}</strong>ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ<br>ã“ã®ãƒ«ãƒ¼ãƒ ã®ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã¯ã™ã¹ã¦å¤±ã‚ã‚Œã€å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚</p>
                <div class="flex justify-end space-x-3">
                    <button onclick="window.closeDeleteConfirm()" class="px-4 py-2 text-sm font-medium bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button onclick="window.deleteRoom('${roomId}')" class="px-4 py-2 text-sm font-semibold bg-red-600 text-white rounded-lg hover:bg-red-700 transition">å‰Šé™¤ã™ã‚‹</button>
                </div>
            `;
            modal.classList.remove('hidden');
        };

        // â˜… v3: ãƒ­ãƒ¼ãƒ«å‰Šé™¤ (ãƒãƒƒãƒå‡¦ç†ä¿®æ­£)
        window.deleteRole = async (roleId) => {
            window.closeDeleteConfirm();
            window.toggleUI(true, 'ãƒ­ãƒ¼ãƒ«ã‚’å‰Šé™¤ä¸­...');
            try {
                // â˜… v7 ä¿®æ­£: Storageå‰Šé™¤ãƒ­ã‚¸ãƒƒã‚¯ã‚’æœ‰åŠ¹åŒ–
                const role = roles.find(r => r.id === roleId);
                if (role) {
                    const paths = [
                        role.avatarStandardStoragePath, role.avatarHappyStoragePath,
                        role.avatarSadStoragePath, role.avatarCuriosityStoragePath
                    ];
                    for (const path of paths) {
                        if (path) await window.deleteAvatarFromStorage(path);
                    }
                }
                const batch = writeBatch(db);
                // â˜… v6.9 ä¿®æ­£: doc() ã‚’ç›´æ¥ä½¿ç”¨
                // const roleRef = getGlobalRolesRef(roleId); // â˜… v6.9
                const roleRef = doc(db, 'artifacts', appId, 'public', 'data', 'roles', roleId); // â˜… ä¿®æ­£: v3ã®ãƒ‘ã‚¹ç›´æŒ‡å®š
                batch.delete(roleRef);
                if (rooms.length > 0) {
                    // â˜… v6.9 ä¿®æ­£: collection() ã‚’ç›´æ¥ä½¿ç”¨
                    // const roomsSnapshot = await getDocs(getGlobalRoomsRef()); // â˜… v6.9
                    const roomsSnapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'rooms')); // â˜… ä¿®æ­£: v3ã®ãƒ‘ã‚¹ç›´æŒ‡å®š
                    roomsSnapshot.forEach(roomDoc => {
                        // â˜… v6.9 ä¿®æ­£: doc() ã‚’ç›´æ¥ä½¿ç”¨
                        // const inviteRef = getRoomSubCollectionRef(roomDoc.id, 'invited_roles', roleId); // â˜… v6.9
                        const inviteRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', roomDoc.id, 'invited_roles', roleId); // â˜… ä¿®æ­£: v3ã®ãƒ‘ã‚¹ç›´æŒ‡å®š
                        batch.delete(inviteRef);
                    });
                }
                await batch.commit();
                window.displayTemporaryMessage("ãƒ­ãƒ¼ãƒ«ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚");
            } catch (error) {
                console.error("Error deleting role:", error);
                window.displayTemporaryMessage("ãƒ­ãƒ¼ãƒ«ã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message);
            } finally {
                window.toggleUI(false);
            }
        };

        // APIå‘¼ã³å‡ºã— (å¤‰æ›´ãªã—)
        window.callFlashImageAPI = async (prompt, base64Data, mimeType, instruction) => {
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt + `. Instruction: ${instruction}` }, { inlineData: { mimeType: mimeType, data: base64Data } }] }],
                generationConfig: { responseModalities: ['IMAGE'] },
            };
            const response = await window.apiCall(FLASH_IMAGE_API_URL, payload);
            const candidate = response?.candidates?.[0];
            if (candidate?.finishReason === "NO_IMAGE") { throw new Error("Image editing failed (NO_IMAGE response)."); }
            const imagePart = candidate?.content?.parts?.find(p => p.inlineData);
            const base64Image = imagePart?.inlineData?.data;
            if (!base64Image) { throw new Error("Image editing data is missing from API response."); }
            // â˜… v13: Image generation APIs always return PNG base64, so it needs to be resized to maintain consistency.
            return await resizeBase64ImageAsPng(base64Image, 'image/png', 256, 256);
        };
        window.callImagenAPI = async (prompt) => {
            const payload = { instances: [{ prompt: prompt, image_size: "512x512" }], parameters: { "sampleCount": 1 } };
            const response = await window.apiCall(IMAGEN_API_URL, payload);
            const base64Data = response.predictions?.[0]?.bytesBase64Encoded;
            if (!base64Data) { throw new Error("Image generation data is missing from API response."); }
            // â˜… v13: Image generation APIs always return PNG base64, so it needs to be resized to maintain consistency.
            return await resizeBase64ImageAsPng(base64Data, IMAGEN_MIME_TYPE, 256, 256);
        };
        window.callPromptProposalAPI = async (roleId) => {
            if (!currentUser) { window.displayTemporaryMessage("ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚"); return; }
            const form = document.getElementById('role-form');
            const roleName = form.name.value.trim();
            const proposalStatus = document.getElementById('proposal-status');
            const selectedVoiceName = form.ttsVoice.value;
            const voiceInfo = TTS_VOICES.find(v => v.name === selectedVoiceName) || TTS_VOICES[0];
            const genderPrompt = voiceInfo.gender === 'male' ? 'a single boy, man' : 'a single girl, woman';
            if (!roleName) { window.displayTemporaryMessage("ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆææ¡ˆã¨ã‚¢ãƒã‚¿ãƒ¼ç”Ÿæˆã«ã¯ã€ãƒ­ãƒ¼ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
            window.toggleUI(true, 'AIãŒãƒ­ãƒ¼ãƒ«è¨­å®šã‚’è€ƒæ¡ˆä¸­...');
            let normalGenerated = false;
            try {
                const currentSystemPrompt = form.systemPrompt.value.trim();
                if (!currentSystemPrompt) {
                    proposalStatus.textContent = 'åˆæœŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè€ƒæ¡ˆä¸­...';
                    const proposalPrompt = `ãƒ­ãƒ¼ãƒ«å: ${roleName}ã€‚ã“ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«ãµã•ã‚ã—ã„ã€å…·ä½“çš„ã§è©³ç´°ãªSystem Promptï¼ˆäººæ ¼ã€å£èª¿ã€ç›®æ¨™ã€æ€§åˆ¥ï¼‰ã‚’æ—¥æœ¬èªã§200æ–‡å­—ç¨‹åº¦ã§ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚ã“ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®æ€§åˆ¥ã¯ ${voiceInfo.gender} ã§ã™ã€‚`;
                    const systemPrompt = await window.callGeminiAPI(null, [{ role: 'user', parts: [{ text: proposalPrompt }] }]);
                    form.systemPrompt.value = systemPrompt.text.trim();
                } else { proposalStatus.textContent = 'System Promptã¯å…¥åŠ›æ¸ˆã¿ã€‚'; }
                const standardBase64Key = 'avatarStandardBase64';
                let standardBase64 = form[standardBase64Key].value;
                if (!standardBase64) {
                    proposalStatus.textContent = 'Standardã‚¢ãƒã‚¿ãƒ¼ã‚’ç”Ÿæˆä¸­...';
                    const imagePrompt = `chat avatar icon, headshot, simple background, full face, close up, Japanese anime style, simple clothes, ${genderPrompt}, ${roleName}, standard expression`;
                    standardBase64 = await window.callImagenAPI(imagePrompt);
                    form.avatarStandardBase64.value = standardBase64;
                    document.getElementById('avatar-preview-Standard').src = `data:${IMAGEN_MIME_TYPE};base64,${standardBase64}`;
                    document.getElementById('avatar-preview-Standard').classList.remove('hidden');
                    document.getElementById('placeholder-preview-Standard').classList.add('hidden');
                    document.getElementById('avatarMimeType').value = IMAGEN_MIME_TYPE;
                    normalGenerated = true;
                } else { proposalStatus.textContent = 'Standardã‚¢ãƒã‚¿ãƒ¼ã¯å…¥åŠ›æ¸ˆã¿ã€‚'; }
                if (!form.avatarStandardBase64.value) {
                    proposalStatus.textContent = 'ã‚¨ãƒ©ãƒ¼: Standardã‚¢ãƒã‚¿ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
                    window.toggleUI(false); return;
                }
                const emotionsToGenerate = ['Happy', 'Sad', 'Curiosity'];
                const imagePromptBase = `chat avatar icon, headshot, simple background, full face, close up, Japanese anime style, simple clothes, ${genderPrompt}, ${roleName}`;
                for (const emotion of emotionsToGenerate) {
                    const base64Key = `avatar${emotion}Base64`;
                    if (!form[base64Key].value) {
                        proposalStatus.textContent = `${emotion}ã‚¢ãƒã‚¿ãƒ¼ã‚’ç·¨é›†ãƒ»ç”Ÿæˆä¸­...`;
                        let instruction = '';
                        if (emotion === 'Happy') instruction = "Change the face to a happy expression, smiling.";
                        if (emotion === 'Sad') instruction = "Change the face to a sad expression, with slightly drooping eyes and mouth.";
                        if (emotion === 'Curiosity') instruction = "Change the face to a curious expression, with one eyebrow raised and slightly open mouth.";
                        // â˜… v13: Flash Image APIã¯PNGã‚’è¿”ã™ãŸã‚ã€mimeTypeã¯image/pngã‚’æ¸¡ã™
                        const editedBase64 = await window.callFlashImageAPI(imagePromptBase, form.avatarStandardBase64.value, IMAGEN_MIME_TYPE, instruction);
                        form[base64Key].value = editedBase64;
                        document.getElementById(`avatar-preview-${emotion}`).src = `data:${IMAGEN_MIME_TYPE};base64,${editedBase64}`;
                        document.getElementById(`avatar-preview-${emotion}`).classList.remove('hidden');
                        document.getElementById(`placeholder-preview-${emotion}`).classList.add('hidden');
                    } else { proposalStatus.textContent = `${emotion}ã‚¢ãƒã‚¿ãƒ¼ã¯å…¥åŠ›æ¸ˆã¿ã€‚`; }
                }
                proposalStatus.textContent = 'ææ¡ˆã¨ã‚¢ãƒã‚¿ãƒ¼ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼';
                window.displayTemporaryMessage('AIã«ã‚ˆã‚‹ãƒ­ãƒ¼ãƒ«ã®ææ¡ˆã¨ã‚¢ãƒã‚¿ãƒ¼ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼');
            } catch (error) {
                console.error("Proposal API Error:", error);
                proposalStatus.textContent = `ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${error.message}`;
            } finally {
                window.toggleUI(false);
            }
        };

        // â˜… v3: è¨˜æ†¶ã®æ‰‹å‹•æ›´æ–° (roomIdå¯¾å¿œ)
        window.updateRoleMemory = async (roleId) => {
            if (!roleId) {
                window.displayTemporaryMessage("ãƒ­ãƒ¼ãƒ«ã‚’ä¸€åº¦ä¿å­˜ã—ã¦ã‹ã‚‰ã€è¨˜æ†¶ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚"); return;
            }
            if (!currentRoomId) {
                window.displayTemporaryMessage("è¨˜æ†¶ã‚’æ›´æ–°ã™ã‚‹ã«ã¯ã€ã„ãšã‚Œã‹ã®ãƒ«ãƒ¼ãƒ ã«å…¥å®¤ã—ã¦ãã ã•ã„ã€‚"); return;
            }
            window.toggleUI(true, 'è¨˜æ†¶ã‚’æ‰‹å‹•æ›´æ–°ä¸­...');
            try {
                const logsRef = collection(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId, 'chat_logs');
                const q = query(logsRef, orderBy('timestamp', 'desc'), limit(10));
                const snapshot = await getDocs(q);
                const chatHistory = snapshot.docs.map(doc => doc.data()).reverse();
                if (chatHistory.length === 0) {
                    window.displayTemporaryMessage("ç›´è¿‘ã®ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ãŒãªã„ãŸã‚ã€è¨˜æ†¶ã¯æ›´æ–°ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
                    window.toggleUI(false); return;
                }
                const historyText = chatHistory.map(log => `${log.senderName}: ${log.text}`).join('\n');
                const memoryPrompt = `ä»¥ä¸‹ã®ä¼šè©±å±¥æ­´ã‚’èª­ã¿ã€ãƒ­ãƒ¼ãƒ«ãŒè¦šãˆã¦ãŠãã¹ãé‡è¦ãªæƒ…å ±ï¼ˆé–¢ä¿‚æ€§ã€å¥½ããªã‚‚ã®ã€å½¹å‰²ãªã©ï¼‰ã‚’ç°¡æ½”ãªç®‡æ¡æ›¸ãã®ã€Œè¨˜æ†¶ã€ã¨ã—ã¦æ—¥æœ¬èªã§è¦ç´„ã—ã¦ãã ã•ã„ã€‚:\n\n${historyText}`; // â˜… v12: æ—¥æœ¬èªä¿®æ­£
                const summaryResponse = await window.callGeminiAPI(null, [{ role: 'user', parts: [{ text: memoryPrompt }] }]);
                const newMemory = summaryResponse.text.trim();
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roles', roleId), { memory: newMemory });
                document.getElementById('memory').value = newMemory;
                window.displayTemporaryMessage(`ã“ã®ãƒ­ãƒ¼ãƒ«ã®è¨˜æ†¶ãŒ(ãƒ«ãƒ¼ãƒ ${currentRoomName}ã®ãƒ­ã‚°ã‚’å…ƒã«)æ‰‹å‹•æ›´æ–°ã•ã‚Œã¾ã—ãŸï¼`);
            } catch (error) {
                console.error("Memory update error:", error);
                window.displayTemporaryMessage("è¨˜æ†¶ã®æ‰‹å‹•æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
            } finally {
                window.toggleUI(false);
            }
        };

        // === ã‚µãƒãƒªãƒ¼ (v3: roomIdå¯¾å¿œ) ===
        let summaryCache = { id: null, text: null };
        window.clearSummaryCache = (lastLogId) => {
            if (summaryCache.id !== lastLogId) {
                summaryCache = { id: null, text: null };
            }
        };
        window.getConversationSummary = async () => {
            if (!currentUser || !currentRoomId) {
                window.displayTemporaryMessage("è¦ç´„ã™ã‚‹ãƒ«ãƒ¼ãƒ ã«å…¥å®¤ã—ã¦ãã ã•ã„ã€‚"); return;
            }
            if (summaryCache.text) { window.showSummaryModal(summaryCache.text); return; }
            window.toggleUI(true, 'ä¼šè©±ã®è¦ç´„ã‚’ç”Ÿæˆä¸­...');
            try {
                const logsRef = collection(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId, 'chat_logs');
                const q = query(logsRef, orderBy('timestamp', 'desc'), limit(20));
                const snapshot = await getDocs(q);
                const chatHistory = snapshot.docs.map(doc => doc.data()).reverse();
                if (chatHistory.length === 0) {
                    window.displayTemporaryMessage("ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                    window.toggleUI(false); return;
                }
                const historyText = chatHistory.map(log => `${log.senderName}: ${log.text}`).join('\n');
                const summaryPrompt = `ä»¥ä¸‹ã®ä¼šè©±å±¥æ­´ã‚’èª­ã¿ã€ã€Œã“ã‚Œã¾ã§ã®ã‚ã‚‰ã™ã˜ã€ã¨ã—ã¦ã€é‡è¦ãªå‡ºæ¥äº‹ã‚„ä¼šè©±ã®æµã‚Œã‚’æ—¥æœ¬èªã®ç®‡æ¡æ›¸ãã§ç°¡æ½”ã«è¦ç´„ã—ã¦ãã ã•ã„ã€‚:\n\n${historyText}`;
                const summaryResponse = await window.callGeminiAPI(null, [{ role: 'user', parts: [{ text: summaryPrompt }] }]);
                const summaryText = summaryResponse.text.trim();
                summaryCache.id = chatHistory[chatHistory.length - 1]?.id || 'summary';
                summaryCache.text = summaryText;
                window.showSummaryModal(summaryText);
            } catch (error) {
                console.error("Summary generation error:", error);
                window.displayTemporaryMessage("è¦ç´„ã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
            } finally {
                window.toggleUI(false);
            }
        };
        window.showSummaryModal = (summaryText) => {
            const modal = document.getElementById('summary-modal');
            const content = document.getElementById('summary-content');
            // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®ç°¡æ˜“ãƒ‘ãƒ¼ã‚¹ (å¤ªå­—ã€ãƒªã‚¹ãƒˆ)
            let htmlText = window.escapeHTML(summaryText)
                .replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold">$1</strong>') // **Bold**
                .replace(/^- (.*$)/gm, '<li class="ml-4 list-disc">$1</li>') // - List
                .replace(/^(#+) (.*$)/gm, (match, hashes, title) => { // Headers
                    const level = Math.min(hashes.length + 2, 6); // H1 -> H3, H2 -> H4
                    return `<h${level} class="font-semibold text-gray-800 mt-3 mb-1">${title}</h${level}>`;
                })
                .replace(/\n/g, '<br>') // Newlines
                .replace(/<br><li/g, '<li') // Fix list spacing
                .replace(/<\/li><br>/g, '</li>');

            content.innerHTML = `
                <h3 class="text-xl font-bold text-indigo-700 mb-4">âœ¨ ã“ã‚Œã¾ã§ã®ã‚ã‚‰ã™ã˜</h3>
                <div class="text-gray-700 mb-6 prose prose-sm max-w-none">${htmlText}</div>
                <div class="flex justify-end">
                    <button onclick="window.closeSummaryModal()" class="px-4 py-2 text-sm font-medium bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">é–‰ã˜ã‚‹</button>
                </div>
            `;
            modal.classList.remove('hidden');
        };
        window.closeSummaryModal = (event) => {
            if (!event || event.target.id === 'summary-modal') {
                document.getElementById('summary-modal').classList.add('hidden');
            }
        };

        // â˜… v23: ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«
        window.showSystemHelpModal = (rawText) => {
            const modal = document.getElementById('system-help-modal');
            const content = document.getElementById('system-help-content');
            // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®ç°¡æ˜“ãƒ‘ãƒ¼ã‚¹ (å¤ªå­—ã€ãƒªã‚¹ãƒˆ)
            let htmlText = window.escapeHTML(rawText)
                .replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold">$1</strong>') // **Bold**
                .replace(/^- (.*$)/gm, '<li class="ml-4 list-disc">$1</li>') // - List
                .replace(/^(#+) (.*$)/gm, (match, hashes, title) => { // Headers
                    const level = Math.min(hashes.length + 2, 6); // H1 -> H3, H2 -> H4
                    return `<h${level} class="font-semibold text-gray-800 mt-3 mb-1">${title}</h${level}>`;
                })
                .replace(/\n/g, '<br>') // Newlines
                .replace(/<br><li/g, '<li') // Fix list spacing
                .replace(/<\/li><br>/g, '</li>');

            content.innerHTML = `
                <h3 class="text-xl font-bold text-indigo-700 mb-4">ğŸ’¡ AIã«ã‚ˆã‚‹æ©Ÿèƒ½è§£èª¬</h3>
                <div class="text-gray-700 mb-6 prose prose-sm max-w-none">${htmlText}</div>
                <div class="flex justify-end">
                    <button onclick="window.closeSystemHelpModal()" class="px-4 py-2 text-sm font-medium bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">é–‰ã˜ã‚‹</button>
                </div>
            `;
            modal.classList.remove('hidden');
        };
        window.closeSystemHelpModal = (event) => {
            if (!event || event.target.id === 'system-help-modal') {
                document.getElementById('system-help-modal').classList.add('hidden');
            }
        };


        // ãƒ¢ãƒ¼ãƒ€ãƒ« (å¤‰æ›´ãªã—)
        window.showImageModal = (src) => {
            const modal = document.getElementById('image-modal');
            const img = document.getElementById('image-modal-img');
            img.src = src;
            modal.classList.remove('hidden');
        };
        window.closeImageModal = (event) => {
            if (event.target.id === 'image-modal') {
                document.getElementById('image-modal').classList.add('hidden');
                document.getElementById('image-modal-img').src = '';
            }
        };
        window.showHelpModal = () => {
            document.getElementById('help-modal').classList.remove('hidden');
        };
        window.closeHelpModal = (event) => {
            if (!event || event.target.id === 'help-modal') {
                document.getElementById('help-modal').classList.add('hidden');
            }
        };

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ (å¤‰æ›´ãªã—)
        window.displayTemporaryMessage = (message) => {
            const bar = document.getElementById('system-message-bar');
            if (!bar) return; // â˜… ä¿®æ­£
            bar.textContent = message;
            bar.classList.remove('hidden', 'text-red-600');
            bar.classList.add('text-green-600');
            setTimeout(() => bar.classList.add('hidden'), 5000);
        };
        window.escapeHTML = (str) => {
            if (typeof str !== 'string') return '';
            return str.replace(/[&<>"']/g, function (m) {
                return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#x27;' }[m];
            });
        };
        window.apiCall = async (url, payload) => {
            const maxRetries = 5;
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`API attempt ${attempt + 1} failed: HTTP status ${response.status}`, errorText);
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    if (attempt < maxRetries - 1) {
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw error;
                    }
                }
            }
            throw new Error("Failed to get response after multiple retries.");
        };
        window.callGeminiAPI = async (systemInstruction = null, contents, shouldExtractJson = false) => {
            const payload = {
                contents: contents,
                generationConfig: shouldExtractJson ? {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "emotion": { "type": "STRING", "description": "standard, happy, sad, or curiosity ã®ã„ãšã‚Œã‹" },
                            "text": { "type": "STRING", "description": "ãƒ­ãƒ¼ãƒ«ã¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å¿œç­”ï¼ˆæ—¥æœ¬èªï¼‰" }
                        }, "propertyOrdering": ["emotion", "text"]
                    }
                } : {},
                systemInstruction: systemInstruction ? { parts: [{ text: systemInstruction }] } : undefined,
            };
            const response = await window.apiCall(GEMINI_API_URL, payload);
            const candidate = response.candidates?.[0];
            const text = candidate?.content?.parts?.[0]?.text;

            if (!text) throw new Error("API response text is missing.");

            if (shouldExtractJson) {
                try {
                    const jsonObject = JSON.parse(text);

                    // â˜… v9: emotion ãŒå­˜åœ¨ã—ãªã„å ´åˆã§ã‚‚ã€text ãŒã‚ã‚Œã°ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã™ã‚‹
                    const emotion = (jsonObject.emotion && EMOTIONS[jsonObject.emotion.toLowerCase()]) ? jsonObject.emotion.toLowerCase() : DEFAULT_EMOTION;

                    // â˜… v9: text ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    if (typeof jsonObject.text !== 'string') {
                        console.warn("Parsed JSON response is missing 'text' field:", jsonObject);
                        // text ãŒãªã„å ´åˆã€å…ƒã® text å…¨ä½“ï¼ˆJSONæ–‡å­—åˆ—ï¼‰ã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ä½¿ã†
                        return { text: text.trim(), emotion: emotion };
                    }

                    return { text: jsonObject.text.trim(), emotion: emotion };

                } catch (e) {
                    // â˜… v9: JSONãƒ‘ãƒ¼ã‚¹è‡ªä½“ã«å¤±æ•—ã—ãŸå ´åˆï¼ˆAPIãŒJSONã§ã¯ãªã„ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿”ã—ãŸå ´åˆï¼‰
                    console.error("Failed to parse JSON response string:", text, e);
                    return { text: text.trim(), emotion: DEFAULT_EMOTION };
                }
            }
            return { text: text.trim() };
        };
        window.appendLoadingLog = (isImage = false, isEditing = false, customText = null) => {
            const logElement = document.getElementById('dialog-log');
            let text = customText || 'å‡¦ç†ä¸­...';
            const messageClass = 'bg-yellow-100 text-gray-800';
            const loadingHTML = `
                <div id="current-loading" class="flex w-full justify-start items-center mb-3">
                    <div class="w-24 h-24 rounded-full bg-gray-400 flex items-center justify-center text-2xl font-bold text-white flex-shrink-0 shadow-md"> AI </div>
                    <div class="max-w-xs sm:max-w-md flex flex-col ml-2">
                        <div class="text-xs font-semibold mb-0.5 text-gray-700 text-left"> ã‚·ã‚¹ãƒ†ãƒ  </div>
                        <div class="p-3 rounded-xl shadow-md ${messageClass} break-words text-left flex items-center space-x-2">
                            <span class="text-sm">${text}</span>
                            <div class="flex space-x-1">
                                <span class="loading-dot w-2 h-2 bg-yellow-500 rounded-full"></span>
                                <span class="loading-dot w-2 h-2 bg-yellow-500 rounded-full"></span>
                                <span class="loading-dot w-2 h-2 bg-yellow-500 rounded-full"></span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            const existingLoading = document.getElementById('current-loading');
            if (existingLoading) { existingLoading.remove(); }
            logElement.innerHTML += loadingHTML;
            logElement.scrollTop = logElement.scrollHeight;
        };
        window.hideLoading = () => {
            const loading = document.getElementById('current-loading');
            if (loading) { loading.remove(); }
        };

        // â˜… v3: å·¦ã‚«ãƒ©ãƒ é–‹é–‰ (ãƒ«ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯)
        window.toggleLeftColumn = () => {
            if (!document.getElementById('room-list-modal').classList.contains('hidden')) {
                window.displayTemporaryMessage("ãƒ«ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦ã‹ã‚‰æ“ä½œã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            const leftCol = document.getElementById('left-column');
            const overlay = document.getElementById('left-column-overlay');
            const isOpen = leftCol.classList.contains('translate-x-0');
            if (isOpen) {
                leftCol.classList.remove('translate-x-0');
                leftCol.classList.add('-translate-x-full');
                overlay.classList.add('hidden', 'opacity-0');
                overlay.classList.remove('opacity-50');
            } else {
                leftCol.classList.remove('-translate-x-full');
                leftCol.classList.add('translate-x-0');
                overlay.classList.remove('hidden', 'opacity-0');
                overlay.classList.add('opacity-50');
            }
        };

        // â˜… v23: ã‚¦ã‚§ãƒ«ã‚«ãƒ ã‚¬ã‚¤ãƒ‰ (ãƒ¢ãƒ¼ãƒ€ãƒ«ã«å¤‰æ›´)
        window.showWelcomeMessageIfNew = () => {
            if (!currentUser) return;
            try {
                if (localStorage.getItem(WELCOME_GUIDE_KEY)) { return; }
            } catch (e) { console.warn("LocalStorage access failed."); return; }

            // â˜… v23: æ–°ã—ã„ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            const modal = document.getElementById('welcome-guide-modal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        };
        // â˜… v23: æ–°ã—ã„ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        window.closeWelcomeGuideModal = (event) => {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('welcome-guide-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
            try {
                localStorage.setItem(WELCOME_GUIDE_KEY, 'true');
            } catch (e) { console.warn("LocalStorage write failed."); }
        };
        // ãƒˆã‚°ãƒ« (å¤‰æ›´ãªã—)
        window.toggleSpontaneousSpeech = () => {
            isSpontaneousSpeech_Enabled = !isSpontaneousSpeech_Enabled;
            const button = document.getElementById('spontaneous-speech-toggle-button');
            const iconOff = document.getElementById('spontaneous-speech-icon-off');
            if (isSpontaneousSpeech_Enabled) {
                button.classList.remove('text-gray-400'); button.classList.add('text-indigo-600');
                button.title = "AIã®è‡ªç™ºçš„ç™ºè¨€ (ç¾åœ¨ON)"; iconOff.classList.add('hidden');
                window.displayTemporaryMessage("AIã®è‡ªç™ºçš„ç™ºè¨€ãŒONã«ãªã‚Šã¾ã—ãŸã€‚");
                // â˜… v12: ONã«ãªã£ãŸã‚‰ã€æ¬¡ã®ãƒã‚§ãƒƒã‚¯æ™‚åˆ»ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«è¨­å®š
                nextSpontaneousCheckTime = Date.now() + (Math.random() * (30000 - 3000) + 3000);
            } else {
                button.classList.remove('text-indigo-600'); button.classList.add('text-gray-400');
                button.title = "AIã®è‡ªç™ºçš„ç™ºè¨€ (ç¾åœ¨OFF)"; iconOff.classList.remove('hidden');
                window.displayTemporaryMessage("AIã®è‡ªç™ºçš„ç™ºè¨€ãŒOFFã«ãªã‚Šã¾ã—ãŸã€‚");
            }
        };
        window.toggleAutoTTS = () => {
            isAutoTTS_Enabled = !isAutoTTS_Enabled;
            const button = document.getElementById('tts-toggle-button');
            const iconOff = document.getElementById('tts-icon-off');
            if (isAutoTTS_Enabled) {
                button.classList.remove('text-gray-400'); button.classList.add('text-indigo-600');
                button.title = "AIã®å¿œç­”ã‚’è‡ªå‹•å†ç”Ÿã™ã‚‹ (ç¾åœ¨ON)"; iconOff.classList.add('hidden');
                window.displayTemporaryMessage("TTSè‡ªå‹•å†ç”ŸãŒONã«ãªã‚Šã¾ã—ãŸã€‚");
            } else {
                button.classList.remove('text-indigo-600'); button.classList.add('text-gray-400');
                button.title = "AIã®å¿œç­”ã‚’è‡ªå‹•å†ç”Ÿã™ã‚‹ (ç¾åœ¨OFF)"; iconOff.classList.remove('hidden');
                window.displayTemporaryMessage("TTSè‡ªå‹•å†ç”ŸãŒOFFã«ãªã‚Šã¾ã—ãŸã€‚");
            }
        };
        // å…¥åŠ› (å¤‰æ›´ãªã—)
        window.handleChatInputKeyDown = (event) => {
            if (event.key === 'Enter') {
                if (event.shiftKey) {
                    const inputElement = event.target;
                    const start = inputElement.selectionStart;
                    const end = inputElement.selectionEnd;
                    const value = inputElement.value;
                    inputElement.value = value.substring(0, start) + "\n" + value.substring(end);
                    inputElement.selectionStart = inputElement.selectionEnd = start + 1;
                    event.preventDefault();
                } else {
                    event.preventDefault();
                    const form = document.getElementById('chat-form-elements');
                    if (form) {
                        if (typeof form.requestSubmit === 'function') {
                            form.requestSubmit();
                        } else {
                            form.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
                        }
                    }
                }
            }
        };
        // ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ (å¤‰æ›´ãªã—ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§å‹•ä½œ)
        window.exportSettings = async () => {
            if (!currentUser) { window.displayTemporaryMessage("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ã«ã¯ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚"); return; }
            window.toggleUI(true, 'è¨­å®šã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸­...');
            try {
                const userName = currentUserName;
                const myRoles = roles.filter(r => r.makerId === currentUser.uid);
                const exportData = {
                    version: 1, exportedAt: new Date().toISOString(), userName: userName,
                    roles: myRoles.map(role => {
                        const { id, makerId, makerDisplayName, isActive, ...roleData } = role;
                        return roleData;
                    })
                };
                const jsonString = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const dateStr = new Date().toISOString().split('T')[0].replace(/-/g, '');
                a.download = `yumemiru_settings_${dateStr}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                URL.revokeObjectURL(url);
                window.displayTemporaryMessage("è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚");
            } catch (error) {
                console.error("Error exporting settings:", error);
                window.displayTemporaryMessage("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
            } finally {
                window.toggleUI(false);
            }
        };
        window.handleImportFile = (fileInput) => {
            const file = fileInput.files[0];
            if (!file) { return; }
            if (file.type !== 'application/json') {
                window.displayTemporaryMessage("ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚.jsonãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
                fileInput.value = ''; return;
            }
            window.toggleUI(true, 'è¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­... (ã‚¢ãƒã‚¿ãƒ¼ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...)');

            // â˜… Base64ã‹ã‚‰Blobã¸ã®å¤‰æ›ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
            const base64ToBlob = (base64, mimeType) => {
                try {
                    const byteCharacters = atob(base64);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    return new Blob([byteArray], { type: mimeType });
                } catch (e) {
                    console.error("Base64 to Blob conversion failed:", e);
                    return null;
                }
            };

            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const jsonString = event.target.result;
                    const importData = JSON.parse(jsonString);
                    if (!importData || importData.version !== 1 || !Array.isArray(importData.roles)) {
                        throw new Error("ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒç„¡åŠ¹ã‹ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒç•°ãªã‚Šã¾ã™ã€‚");
                    }
                    const batch = writeBatch(db);
                    const rolesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'roles');

                    // ... (ãƒ¦ãƒ¼ã‚¶ãƒ¼åå¤‰æ›´ãƒ­ã‚¸ãƒƒã‚¯ã¯ client.html (L2984) ã¨åŒã˜) ...
                    let newName = currentUserName;
                    if (importData.userName && importData.userName !== "RoleMakerCanvas" && importData.userName !== currentUserName) {
                        newName = importData.userName;
                        const presenceRef = doc(db, 'artifacts', appId, 'public', 'data', 'presence', currentUser.uid);
                        batch.set(presenceRef, { displayName: newName }, { merge: true });
                        const rolesRef = collection(db, 'artifacts', appId, 'public', 'data', 'roles');
                        const q = query(rolesRef, where("makerId", "==", currentUser.uid));
                        const querySnapshot = await getDocs(q);
                        querySnapshot.forEach((doc) => { batch.update(doc.ref, { makerDisplayName: newName }); });
                    }

                    // â˜… yumemiru.html (L2442) ã®ã‚¢ãƒã‚¿ãƒ¼ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯
                    const processedRoles = await Promise.all(importData.roles.map(async (roleData) => {
                        const mimeType = roleData.avatarMimeType || 'image/png';

                        for (const emotion of ['Standard', 'Happy', 'Sad', 'Curiosity']) {
                            const base64Key = `avatar${emotion}Base64`;
                            // â˜… æ—¢å­˜ã®URLãŒã‚ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ— (Base64ã¯å¤ã„ãƒ‡ãƒ¼ã‚¿å½¢å¼)
                            if (roleData[`avatar${emotion}URL`]) continue;

                            if (roleData[base64Key] && roleData[base64Key].length > 100) {
                                try {
                                    const blob = base64ToBlob(roleData[base64Key], mimeType);
                                    if (!blob) throw new Error("Base64 to Blob failed");

                                    // (getStorageAvatarRef ã¯ L391 ã§è¿½åŠ æ¸ˆã¿)
                                    const fileName = `${emotion.toLowerCase()}_${Date.now()}.png`;
                                    const storageRef = getStorageAvatarRef(fileName);
                                    const snapshot = await uploadBytes(storageRef, blob, { contentType: mimeType });
                                    const downloadURL = await getDownloadURL(snapshot.ref);

                                    roleData[`avatar${emotion}URL`] = downloadURL;
                                    roleData[`avatar${emotion}StoragePath`] = snapshot.ref.fullPath;
                                    delete roleData[base64Key];
                                } catch (uploadError) {
                                    console.error(`Failed to upload imported avatar for ${roleData.name} (${emotion}):`, uploadError);
                                    delete roleData[base64Key];
                                }
                            } else {
                                delete roleData[base64Key];
                            }
                        }

                        // ... (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®šãƒ­ã‚¸ãƒƒã‚¯)

                        if (typeof roleData.isTemplate === 'undefined') { roleData.isTemplate = false; }
                        if (!roleData.ttsVoice) { roleData.ttsVoice = TTS_VOICES[0].name; }
                        if (!roleData.themeColor) { roleData.themeColor = getRandomHSL(); }
                        if (!roleData.avatarMimeType) roleData.avatarMimeType = 'image/png';

                        // â˜… client.html ã¯ 'linkedAiId' ã‚’ä½¿ç”¨
                        if (!roleData.linkedAiId) {
                            roleData.linkedAiId = ""; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ (é€£æºãªã—)
                        }

                        return roleData;
                    })); // â˜… Promise.all ã“ã“ã¾ã§

                    // (L3036) ãƒãƒƒãƒã¸ã®è¿½åŠ 
                    processedRoles.forEach(roleData => {
                        const newRole = {
                            ...roleData,
                            makerId: currentUser.uid,
                            makerDisplayName: newName,
                            isActive: false,
                        };
                        const newDocRef = doc(rolesCollectionRef);
                        batch.set(newDocRef, newRole);
                    });

                    await batch.commit();

                    // ... (æ®‹ã‚Šã®ãƒ­ã‚¸ãƒƒã‚¯ã¯ client.html (L3051) ã¨åŒã˜) ...
                    if (newName !== currentUserName) {
                        currentUserName = newName;
                        window.updateHeaderUserName(newName);
                    }
                    window.displayTemporaryMessage(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†: ${importData.roles.length}ä»¶ã®ãƒ­ãƒ¼ãƒ«ãŒè¿½åŠ /æ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚`);
                } catch (error) {
                    console.error("Error importing settings:", error);
                    window.displayTemporaryMessage("ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
                } finally {
                    fileInput.value = '';
                    window.toggleUI(false);
                }
            }; // â˜… reader.onload ã“ã“ã¾ã§
            reader.readAsText(file);
        };

        // === ãƒ«ãƒ¼ãƒ ç®¡ç† (v3: ãƒ¢ãƒ¼ãƒ€ãƒ«å†…) ===
        window.renderRoomList = () => {
            const container = document.getElementById('room-list-container');
            if (!container) return;
            if (!currentUser) {
                container.innerHTML = '<p class="text-center text-gray-500 p-4">ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ãƒ«ãƒ¼ãƒ ã«å‚åŠ ã§ãã¾ã™ã€‚</p>';
                return;
            }
            container.innerHTML = rooms.map(room => {
                const roomName = room.name || 'ç„¡é¡Œã®ãƒ«ãƒ¼ãƒ ';
                const roomDesc = room.description || 'èª¬æ˜ãŒã‚ã‚Šã¾ã›ã‚“';
                const isCurrent = room.id === currentRoomId;
                return `
                    <div class="p-4 mb-3 bg-white rounded-lg shadow-md border ${isCurrent ? 'border-indigo-500 ring-2 ring-indigo-300' : 'border-gray-200'} hover:shadow-lg transition">
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-lg ${isCurrent ? 'text-indigo-700' : 'text-gray-800'}">${window.escapeHTML(roomName)}</h3>
                            ${isCurrent ? '<span class="text-xs font-bold text-white bg-indigo-500 px-2 py-0.5 rounded-full">å…¥å®¤ä¸­</span>' : ''}
                        </div>
                        <p class="text-sm text-gray-600 mt-1 mb-2 truncate">${window.escapeHTML(roomDesc)}</p>
                        
                        <!-- â˜… v4: ãƒ«ãƒ¼ãƒ å†…ã®è¦–è¦šåŒ–ç”¨DIV -->
                        <div id="room-visuals-${room.id}" class="flex flex-wrap gap-1 mt-2 min-h-[28px]">
                            <span class="text-xs text-gray-400">å‚åŠ è€…...</span>
                        </div>

                        <div class="flex justify-between space-x-2 mt-4">
                            <button onclick="window.enterRoom('${room.id}', '${window.escapeHTML(roomName)}')" class="flex-grow px-4 py-2 text-sm font-semibold bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition" ${isCurrent ? 'disabled' : ''}>
                                ${isCurrent ? 'å…¥å®¤ä¸­' : 'å…¥å®¤ã™ã‚‹'}
                            </button>
                            ${(room.makerId === currentUser.uid) ? `
                                <button onclick="window.showDeleteRoomConfirm('${room.id}', '${window.escapeHTML(roomName)}')" class="px-4 py-2 text-sm font-medium bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
                                    å‰Šé™¤
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('') || '<p class="text-center text-gray-500 p-4">ã¾ã ãƒ«ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä½œæˆã—ã¾ã—ã‚‡ã†ï¼</p>';

            // â˜… v4: ãƒ«ãƒ¼ãƒ ä¸€è¦§ã®è¦–è¦šåŒ–æƒ…å ±ã‚’éåŒæœŸã§å–å¾—
            for (const room of rooms) {
                window.fetchRoomVisuals(room.id);
            }
        };

        // â˜… v4: ãƒ«ãƒ¼ãƒ ä¸€è¦§ã®è¦–è¦šåŒ–æƒ…å ±ã‚’å–å¾—ã™ã‚‹é–¢æ•°
        window.fetchRoomVisuals = async (roomId) => {
            const targetDiv = document.getElementById(`room-visuals-${roomId}`);
            if (!targetDiv) return;

            try {
                const presenceCol = collection(db, 'artifacts', appId, 'public', 'data', 'rooms', roomId, 'presence');
                const invitesCol = collection(db, 'artifacts', appId, 'public', 'data', 'rooms', roomId, 'invited_roles');

                const [presenceSnap, invitesSnap] = await Promise.all([
                    getDocs(query(presenceCol, limit(10))), // 10äººã¾ã§è¡¨ç¤º
                    getDocs(query(invitesCol, limit(10)))  // 10ãƒ­ãƒ¼ãƒ«ã¾ã§è¡¨ç¤º
                ]);

                const presentUserIds = presenceSnap.docs.map(d => d.id);
                const invitedRoleIds = invitesSnap.docs.map(d => d.id);

                // 1. å‚åŠ ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ (ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã®ã¿)
                const usersInRoom = presentUserIds.filter(uid => usersOnline[uid]);
                const userIconsHtml = usersInRoom.map(uid => {
                    const user = usersOnline[uid];
                    const displayName = user.displayName || 'ã‚²ã‚¹ãƒˆ';
                    return `<div class="w-6 h-6 rounded-full bg-gray-600 text-white text-xs flex items-center justify-center flex-shrink-0 border-2 border-white" title="ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${window.escapeHTML(displayName)}">${window.escapeHTML(displayName.charAt(0))}</div>`;
                    // 
                }).join('');

                // 2. æ‹›å¾…ä¸­ã®ãƒ­ãƒ¼ãƒ«
                const rolesInRoom = invitedRoleIds.map(rid => roles.find(r => r.id === rid)).filter(Boolean);
                const roleIconsHtml = rolesInRoom.map(role => {
                    const iconSource = role.avatarStandardURL;
                    const title = `ãƒ­ãƒ¼ãƒ«: ${window.escapeHTML(role.name)} (è£½ä½œè€…: ${window.escapeHTML(role.makerDisplayName)})`;
                    if (iconSource) {
                        return `<img src="${iconSource}" class="w-6 h-6 rounded-full object-cover flex-shrink-0 border-2 border-white" alt="${role.name}" title="${title}">`;
                    } else {
                        return `<div class="w-6 h-6 rounded-full bg-indigo-300 text-indigo-800 text-xs flex items-center justify-center flex-shrink-0 border-2 border-white" title="${title}">${window.escapeHTML(role.name.charAt(0))}</div>`;
                    }
                }).join('');

                if (!userIconsHtml && !roleIconsHtml) {
                    targetDiv.innerHTML = `<span class="text-xs text-gray-400">å‚åŠ è€…ãªã—</span>`;
                } else {
                    targetDiv.innerHTML = userIconsHtml + roleIconsHtml;
                }

            } catch (error) {
                console.warn(`Failed to fetch room visuals for ${roomId}:`, error);
                targetDiv.innerHTML = `<span class="text-xs text-red-400">æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼</span>`;
            }
        };


        window.createNewRoom = async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            const input = document.getElementById('new-room-name');
            const descInput = document.getElementById('new-room-desc');
            const roomName = input.value.trim();
            const roomDesc = descInput.value.trim();
            if (!roomName) { window.displayTemporaryMessage("ãƒ«ãƒ¼ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
            window.toggleUI(true, 'ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆä¸­...');
            try {
                const newRoom = { name: roomName, description: roomDesc, makerId: currentUser.uid, createdAt: serverTimestamp() };
                const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'rooms'), newRoom);
                input.value = '';
                descInput.value = '';
                // â˜… v3: ä½œæˆã—ãŸã‚‰ã™ãå…¥å®¤ã™ã‚‹
                await window.enterRoom(docRef.id, roomName);
            } catch (error) {
                console.error("Error creating room:", error);
                window.displayTemporaryMessage("ãƒ«ãƒ¼ãƒ ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
            } finally {
                window.toggleUI(false);
            }
        };

        window.deleteRoom = async (roomId, roomName) => { // roomName ã¯ã‚‚ã†ä¸è¦ã ãŒã€äº’æ›æ€§ã®ãŸã‚ã«æ®‹ã™
            if (!currentUser) return;

            // â˜… v7: confirm() ã‚’å‰Šé™¤ã—ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ç›´æ¥å‘¼ã°ã‚Œã‚‹ã‚ˆã†ã«å¤‰æ›´
            // const confirmed = confirm(...);
            // if (!confirmed) return;
            window.closeDeleteConfirm(); // â˜… v7: å¿µã®ãŸã‚ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹

            window.toggleUI(true, 'ãƒ«ãƒ¼ãƒ ã‚’å‰Šé™¤ä¸­...');
            try {
                // â€» ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®å‰Šé™¤ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã¯å›°é›£ãªãŸã‚ã€ãƒ«ãƒ¼ãƒ æœ¬ä½“ã®ã¿å‰Šé™¤
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', roomId));
                // â˜… v3: ã‚‚ã—å‰Šé™¤ã—ãŸãƒ«ãƒ¼ãƒ ã«å…¥å®¤ä¸­ã ã£ãŸã‚‰ã€é€€å®¤ã•ã›ã‚‹
                if (currentRoomId === roomId) {
                    await window.exitRoom();
                    try { localStorage.removeItem(LAST_ROOM_KEY); } catch (e) { }

                    // â˜… v10 ä¿®æ­£: DBã‹ã‚‰ã‚‚ãƒ«ãƒ¼ãƒ è¨­å®šã‚’ã‚¯ãƒªã‚¢
                    if (currentUser) {
                        const userPrefRef = getUserPreferenceRef(currentUser.uid);
                        if (userPrefRef) {
                            await setDoc(userPrefRef, { lastRoomId: null, lastRoomName: null }, { merge: true }).catch(e => console.warn("Failed to clear DB room preference:", e));
                        }
                    }

                    window.openRoomModal(); // é€€å®¤ã—ãŸã®ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
                }
                window.displayTemporaryMessage("ãƒ«ãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
            } catch (error) {
                console.error("Error deleting room:", error);
                window.displayTemporaryMessage("ãƒ«ãƒ¼ãƒ ã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message);
            } finally {
                window.toggleUI(false);
            }
        };

        // === Initialize App ===
        window.addEventListener('load', () => {
            document.getElementById('auth-overlay').classList.remove('hidden');
            window.initializeFirebase();
            document.getElementById('left-column-overlay').addEventListener('click', window.toggleLeftColumn);
            // â˜… v4: iOS audio unlock: èªè¨¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ã‚¯ãƒªãƒƒã‚¯ã‚’ãƒˆãƒªã‚¬ãƒ¼ã«ã™ã‚‹
            document.getElementById('auth-overlay').addEventListener('click', window.getAudioContext, { once: true });
        });

        // ãƒ‡ãƒãƒƒã‚°
        console.log("Yumemiru v3 script parsed successfully.");
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Yusei+Magic&family=Inter:wght@400;600;700&display=swap');

        html,
        body {
            height: 100%;
            padding: 0;
            margin: 0;
            overscroll-behavior: none;
            overflow: hidden;
            background-color: #f3f4f6;
        }

        /* â˜… v3: app-container -> app-shell */
        #app-shell {
            height: 100vh;
            width: 100%;
            max-width: 1024px;
            margin-left: auto;
            margin-right: auto;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        .title-font {
            font-family: 'Yusei Magic', sans-serif;
        }

        /* â˜… ä¿®æ­£: Yusei+Magic -> Yusei Magic */
        /* â˜… v3: chat-room-view ã¯v1ã® app-container ã¨åŒã˜ */
        #chat-room-view {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* â˜… v3: ãƒ«ãƒ¼ãƒ ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
        .room-list-scroll {
            overflow-y: auto;
            overscroll-behavior-y: contain;
            padding: 1rem;
            max-height: 50vh;
            /* â˜… v4: 80vh -> 50vh */
        }

        .log-container {
            overflow-y: auto;
            overscroll-behavior-y: contain;
        }

        .log-container::-webkit-scrollbar {
            width: 8px;
        }

        .log-container::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 4px;
        }

        .left-column-scroll {
            height: 100%;
            overflow-y: auto;
            padding: 1rem;
        }

        .loading-dot {
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1.0);
            }
        }

        .modal-content-scroll {
            max-height: 50vh;
            overflow-y: auto;
        }

        /* â˜… v4: 90vh -> 50vh */
        #image-preview-container button {
            transition: opacity 0.2s;
        }

        #image-preview-container:hover button {
            opacity: 1;
        }

        .prose ul {
            list-style-type: disc;
            padding-left: 1.5em;
        }

        .prose li {
            margin-top: 0.25em;
            margin-bottom: 0.25em;
        }

        .chat-bubble-ai {
            position: relative;
            margin-left: 12px;
        }

        .chat-bubble-ai::before {
            content: '';
            position: absolute;
            left: -12px;
            top: 20px;
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-right: 12px solid var(--bubble-color, #e5e7eb);
        }

        .chat-bubble-human {
            position: relative;
            margin-right: 12px;
        }

        .chat-bubble-human::before {
            content: '';
            position: absolute;
            right: -12px;
            top: 20px;
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-left: 12px solid var(--bubble-color, #3b82f6);
        }

        /* â˜… v23: å‰Šé™¤ (welcome-guideã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ)
        @keyframes pulse-border { 0%, 100% { opacity: 1; transform: scale(1); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 50% { opacity: 0.7; transform: scale(1.05); box-shadow: 0 0 0 8px rgba(59, 130, 246, 0); } }
        #welcome-guide-highlight { animation: pulse-border 2s infinite; }
        */
    </style>
</head>

<body>

    <!-- èªè¨¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ (â˜… ä¿®æ­£) -->
    <div id="auth-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 z-50 flex items-center justify-center">
        <div id="auth-overlay-content" class="bg-white p-8 rounded-xl shadow-2xl text-center w-full max-w-sm">
            <!-- ã“ã®å†…å®¹ã¯ initializeFirebase / signInWithGoogle / signInAsGuest ã«ã‚ˆã£ã¦å‹•çš„ã«æ›¸ãæ›ãˆã‚‰ã‚Œã¾ã™ -->
            <h2 class="text-xl font-bold text-indigo-700 mb-4">ã‚ˆã†ã“ãï¼</h2>
            <p class="text-gray-600 mb-6">ãƒãƒ£ãƒƒãƒˆã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ã¦ã„ã¾ã™...</p>
            <div class="flex justify-center items-center space-x-2">
                <div class="loading-dot w-3 h-3 bg-indigo-500 rounded-full"></div>
                <div class="loading-dot w-3 h-3 bg-indigo-500 rounded-full"></div>
                <div class="loading-dot w-3 h-3 bg-indigo-500 rounded-full"></div>
            </div>
        </div>
    </div>

    <!-- â˜… v3: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ã‚§ãƒ« -->
    <div id="app-shell" class="bg-white"> <!-- â˜… ä¿®æ­£: bg-white ã‚’è¿½åŠ  -->

        <!-- â˜… v3: ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ç”»é¢ (v1ã®UIã«æˆ»ã™) -->
        <div id="chat-room-view" class="h-full flex flex-col"> <!-- â˜… ä¿®æ­£: flex flex-col è¿½åŠ  -->

            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <header
                class="flex justify-between items-center px-2 sm:px-4 py-2 border-b border-indigo-200 bg-white w-full z-20 flex-shrink-0">
                <div class="flex items-center space-x-1 sm:space-x-2">
                    <!-- â˜… v3: ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒœã‚¿ãƒ³ (å·¦ã‚«ãƒ©ãƒ ç”¨) -->
                    <button id="hamburger-button" onclick="window.toggleLeftColumn()"
                        class="p-2 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h16m-7 6h7"></path>
                        </svg>
                    </button>
                    <!-- â˜… v3: ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒ«ãƒ¼ãƒ å -->
                    <div class="flex flex-col items-start leading-none">
                        <span class="text-xs text-indigo-600 title-font hidden sm:block">AIãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ãƒãƒ£ãƒƒãƒˆ</span>
                        <h1 class="text-xl sm:text-2xl font-bold text-indigo-700 title-font sm:-mt-1">ãƒ¦ãƒ¡ãƒŸãƒ«</h1>
                    </div>
                    <h2 id="chat-room-name"
                        class="text-lg font-semibold text-gray-700 ml-2 truncate max-w-[150px] sm:max-w-xs">
                        ãƒ«ãƒ¼ãƒ æœªå…¥å®¤
                    </h2>
                </div>
                <div class="flex items-center space-x-1 sm:space-x-2">
                    <!-- â˜… v3: ãƒ«ãƒ¼ãƒ é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ãƒœã‚¿ãƒ³ -->
                    <button id="room-modal-button" onclick="window.openRoomModal()"
                        class="p-2 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        title="ãƒ«ãƒ¼ãƒ ä¸€è¦§ã‚’é–‹ã">
                        <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6-4a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z">
                            </path>
                        </svg>
                    </button>

                    <div id="tts-indicator" class="hidden relative flex items-center justify-center w-5 h-5"
                        title="TTSã‚’å†ç”Ÿä¸­...">
                        <svg class="w-5 h-5 text-indigo-600 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none"
                            viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                        </svg>
                        <svg class="w-3 h-3 text-indigo-800 absolute" fill="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"
                                clip-rule="evenodd" fill-rule="evenodd"></path>
                        </svg>
                    </div>
                    <!-- â˜… ä¿®æ­£: è‡ªç™ºçš„ç™ºè¨€ãƒœã‚¿ãƒ³ã‚’SVGã«å¤‰æ›´ -->
                    <button id="spontaneous-speech-toggle-button" onclick="window.toggleSpontaneousSpeech()"
                        class="p-2 rounded-md hover:bg-gray-100 text-gray-400 relative" title="AIã®è‡ªç™ºçš„ç™ºè¨€ (ç¾åœ¨OFF)">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 11a7 7 0 01-7 7v0a7 7 0 01-7-7v0a7 7 0 017-7v0a7 7 0 017 7v0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19v2a3 3 0 006 0v-2"></path>
                        </svg>
                        <svg id="spontaneous-speech-icon-off"
                            class="w-6 h-6 absolute top-1.5 left-1.5 text-red-500 opacity-70" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M3 3l18 18">
                            </path>
                        </svg>
                    </button>
                    <!-- TTSãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ -->
                    <button id="tts-toggle-button" onclick="window.toggleAutoTTS()"
                        class="p-2 rounded-md hover:bg-gray-100 text-gray-400 relative" title="AIã®å¿œç­”ã‚’è‡ªå‹•å†ç”Ÿã™ã‚‹ (ç¾åœ¨OFF)">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z">
                            </path>
                        </svg>
                        <svg id="tts-icon-off" class="w-6 h-6 absolute top-2 left-2 text-red-500 opacity-70" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M3 3l18 18">
                            </path>
                        </svg>
                    </button>
                </div>
            </header>

            <!-- ãƒ¡ã‚¤ãƒ³ã®äºŒç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚³ãƒ³ãƒ†ãƒŠ -->
            <div class="flex-grow w-full relative overflow-hidden">
                <!-- === LEFT COLUMN: ãƒ­ãƒ¼ãƒ«ç®¡ç† (ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‘ãƒãƒ«) === -->
                <div id="left-column"
                    class="absolute top-0 left-0 h-full w-full max-w-sm md:max-w-md bg-indigo-50 shadow-xl z-30 transform -translate-x-full transition-transform duration-300 ease-in-out">
                    <div class="left-column-scroll">
                        <h2 class="text-lg font-bold text-indigo-700 mb-3">ãƒ­ãƒ¼ãƒ«ç®¡ç†ãƒ»è¨­å®š</h2>
                        <div
                            class="flex items-center justify-between p-3 mb-3 bg-white rounded-lg shadow-sm border border-gray-200">
                            <div class="flex items-center space-x-2 overflow-hidden">
                                <span class="text-sm font-semibold text-gray-500">ã‚ˆã†ã“ã,</span>
                                <span class="user-display-name text-sm font-bold text-indigo-700 truncate">ã‚²ã‚¹ãƒˆ</span>
                            </div>
                            <button onclick="window.updateUserName()"
                                class="p-2 rounded-full hover:bg-gray-200 text-gray-500 hover:text-indigo-600 transition flex-shrink-0"
                                title="è¡¨ç¤ºåã‚’å¤‰æ›´">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z">
                                    </path>
                                </svg>
                            </button>
                        </div>
                        <div class="mb-4 p-2 bg-indigo-100 rounded-lg border border-indigo-300">
                            <p class="text-xs font-semibold text-indigo-700 mb-1">â–¶ ç¾åœ¨ã®ç™»å ´äººç‰© (ã“ã®ãƒ«ãƒ¼ãƒ )</p>
                            <div id="active-roles-container" class="flex flex-wrap gap-2">
                                <!-- ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ãŒã“ã“ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ -->
                            </div>
                        </div>
                        <button onclick="window.getConversationSummary()"
                            class="w-full py-2 mb-2 text-sm font-semibold bg-green-500 text-white rounded-lg hover:bg-green-600 transition shadow-md">
                            âœ¨ ã“ã®ä¼šè©±ã‚’è¦ç´„ (AI)
                        </button>
                        <button onclick="window.createMyTemplateRole()"
                            class="w-full py-2 mb-2 text-sm font-semibold bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition shadow-md">
                            ğŸ‘¤ è‡ªåˆ†ã®åˆ†èº«ã‚’ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ä½œæˆ
                        </button>
                        <button onclick="window.openRoleEditor()"
                            class="w-full py-2 mb-4 text-sm font-semibold bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow-md">
                            ãƒ­ãƒ¼ãƒ«ã®ä½œæˆ (è©³ç´°)
                        </button>
                        <div class="mt-4 border-t pt-4">
                            <h3 class="text-md font-semibold text-gray-700 mb-2">è¨­å®šãƒ‡ãƒ¼ã‚¿ (ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—)</h3>
                            <p class="text-xs text-gray-500 mb-2">ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ã€ã”è‡ªèº«ãŒä½œæˆã—ãŸå…¨ãƒ­ãƒ¼ãƒ«ï¼ˆã‚¢ãƒã‚¿ãƒ¼ç”»åƒå«ã‚€ï¼‰ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ãƒ»å¾©å…ƒã§ãã¾ã™ã€‚
                            </p>
                            <div class="space-y-2">
                                <button onclick="window.exportSettings()"
                                    class="w-full py-2 text-sm font-semibold bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition shadow-md">
                                    ğŸ“¥ è¨­å®šã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                                </button>
                                <button onclick="document.getElementById('import-file').click()"
                                    class="w-full py-2 text-sm font-semibold bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition shadow-md">
                                    ğŸ“¤ è¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                                </button>
                                <input type="file" id="import-file" accept=".json" class="hidden"
                                    onchange="window.handleImportFile(this)">
                            </div>
                        </div>
                        <h3 class="text-md font-semibold text-gray-700 mb-2 mt-6">å…¨ãƒ­ãƒ¼ãƒ«ä¸€è¦§ (ç·¨é›†ãƒ»ãƒ«ãƒ¼ãƒ ã¸æ‹›å¾…)</h3>
                        <div id="role-list-container" class="space-y-2">
                            <!-- ãƒ­ãƒ¼ãƒ«ãƒªã‚¹ãƒˆãŒã“ã“ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ -->
                        </div>
                    </div>
                </div>
                <div id="left-column-overlay"
                    class="absolute inset-0 bg-black opacity-0 z-20 transition-opacity duration-300 ease-in-out hidden">
                </div>

                <!-- === RIGHT COLUMN: ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã¨å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  === -->
                <div id="right-column" class="w-full h-full flex flex-col bg-gray-100 relative">
                    <div id="dialog-log"
                        class="log-container bg-white p-4 flex-grow w-full overflow-y-auto overscroll-y-contain min-h-0">
                        <p class="text-center text-gray-500">ãƒ«ãƒ¼ãƒ ã«å…¥å®¤ã—ã¦ãã ã•ã„ã€‚</p>
                    </div>
                    <div id="image-preview-container"
                        class="hidden p-2 bg-gray-200 border-t border-b border-gray-300 relative flex-shrink-0">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-medium text-gray-700">æ·»ä»˜ç”»åƒ:</span>
                            <img id="image-preview-img" src=""
                                class="h-16 w-16 object-cover rounded-md border border-gray-400">
                            <button onclick="window.clearImageAttachment()"
                                class="absolute top-1 right-1 p-0.5 bg-red-600 text-white rounded-full opacity-0 hover:opacity-100 transition"
                                title="æ·»ä»˜ã‚’å–ã‚Šæ¶ˆã—">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <form id="chat-form-elements" onsubmit="window.submitMessage(event)"
                        class="bg-white p-3 border-t border-gray-200 shadow-inner w-full flex-shrink-0 h-[86px]">
                        <div class="flex items-center space-x-3">
                            <label for="image-upload"
                                class="p-2 rounded-lg border border-gray-300 hover:bg-gray-100 cursor-pointer text-gray-500 hover:text-indigo-600 transition flex items-center justify-center w-14 h-14 flex-shrink-0">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.414a4 4 0 00-5.656-5.656l-6.415 6.415a6 6 0 108.486 8.486L20.5 13">
                                    </path>
                                </svg>
                                <input type="file" id="image-upload" class="hidden" accept="image/*"
                                    onchange="window.handleImageAttachment(this)">
                            </label>
                            <button type="button" id="speaker-select-button" onclick="window.openSpeakerSelector()"
                                class="p-2 border border-gray-300 rounded-lg bg-white hover:bg-gray-50 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition flex items-center justify-center w-14 h-14 flex-shrink-0">
                                <div id="speaker-icon-preview"
                                    class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-xs overflow-hidden">
                                    <span class="text-gray-500">?</span>
                                </div>
                            </button>
                            <input type="hidden" id="speaker-select" value="">
                            <textarea id="chat-input" onkeydown="window.handleChatInputKeyDown(event)"
                                placeholder="ãƒ«ãƒ¼ãƒ ã«å…¥å®¤ã—ã¦ãã ã•ã„ã€‚"
                                class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm resize-none h-14"
                                autocomplete="off" disabled></textarea>
                            <button type="submit"
                                class="px-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-lg focus:outline-none focus:ring-4 focus:ring-indigo-300 active:bg-indigo-800 flex-shrink-0 h-14 flex items-center justify-center"
                                disabled>
                                <!-- â˜… ä¿®æ­£: é£›è¡Œæ©Ÿã®çµµæ–‡å­—ã‚’æ¨™æº–çš„ãªç´™ãƒ’ã‚³ãƒ¼ã‚­ã®SVGã‚¢ã‚¤ã‚³ãƒ³ã«ç½®æ› -->
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2"
                                    viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                </svg>
                            </button>
                        </div>
                        <p id="system-message-bar" class="text-sm text-red-600 mt-2 hidden text-center"></p>
                    </form>
                </div>
            </div>
        </div> <!-- / #chat-room-view -->
    </div> <!-- / #app-shell -->


    <!-- === å…¨ç”»é¢å…±é€šãƒ¢ãƒ¼ãƒ€ãƒ« === -->

    <!-- â˜… v3: ãƒ«ãƒ¼ãƒ ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="room-list-modal"
        class="fixed inset-0 bg-gray-900 bg-opacity-70 z-40 flex items-center justify-center p-4 hidden"
        onclick="window.closeRoomModal(event)">
        <div class="bg-white rounded-xl shadow-3xl w-full max-w-lg" onclick="event.stopPropagation()">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-indigo-700">ãƒ«ãƒ¼ãƒ ä¸€è¦§</h2>
                    <button onclick="window.closeRoomModal()"
                        class="p-2 rounded-full hover:bg-gray-200 text-gray-500 hover:text-gray-800 transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- ãƒ«ãƒ¼ãƒ ä½œæˆãƒ•ã‚©ãƒ¼ãƒ  -->
                <form onsubmit="window.createNewRoom(event)" class="p-4 bg-gray-50 border rounded-lg mb-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">æ–°ã—ã„ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</h3>
                    <div class="space-y-2">
                        <input type="text" id="new-room-name" placeholder="ãƒ«ãƒ¼ãƒ å" required
                            class="w-full p-2 border border-gray-300 rounded-lg shadow-sm">
                        <input type="text" id="new-room-desc" placeholder="ãƒ«ãƒ¼ãƒ ã®èª¬æ˜ï¼ˆä»»æ„ï¼‰"
                            class="w-full p-2 border border-gray-300 rounded-lg shadow-sm">
                        <button type="submit"
                            class="w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition shadow-lg">
                            ä½œæˆã—ã¦å…¥å®¤
                        </button>
                    </div>
                </form>

                <!-- ãƒ«ãƒ¼ãƒ ä¸€è¦§ã‚³ãƒ³ãƒ†ãƒŠ -->
                <div id="room-list-container" class="room-list-scroll">
                    <!-- ãƒ«ãƒ¼ãƒ ä¸€è¦§ãŒã“ã“ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ«ä½œæˆ/ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« (å¤‰æ›´ãªã—) -->
    <div id="role-editor-modal"
        class="fixed inset-0 bg-gray-900 bg-opacity-70 z-40 flex items-center justify-center p-4 hidden"
        onclick="window.closeRoleEditor(event)">
        <div class="bg-white rounded-xl shadow-3xl w-full max-w-3xl modal-content-scroll"
            onclick="event.stopPropagation()">
            <div id="role-editor-content" class="p-6"></div>
        </div>
    </div>
    <!-- å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« (å¤‰æ›´ãªã—) -->
    <div id="delete-confirm-modal"
        class="fixed inset-0 bg-gray-900 bg-opacity-70 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-3xl w-full max-w-md" onclick="event.stopPropagation()">
            <div id="delete-confirm-content" class="p-6"></div>
        </div>
    </div>
    <!-- è¦ç´„ãƒ¢ãƒ¼ãƒ€ãƒ« (å¤‰æ›´ãªã—) -->
    <div id="summary-modal"
        class="fixed inset-0 bg-gray-900 bg-opacity-70 z-50 flex items-center justify-center p-4 hidden"
        onclick="window.closeSummaryModal(event)">
        <div class="bg-white rounded-xl shadow-3xl w-full max-w-2xl modal-content-scroll"
            onclick="event.stopPropagation()">
            <div id="summary-content" class="p-6"></div>
        </div>
    </div>
    <!-- â˜… v23: ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ« (summary-modalã‚’ã‚³ãƒ”ãƒ¼) -->
    <div id="system-help-modal"
        class="fixed inset-0 bg-gray-900 bg-opacity-70 z-50 flex items-center justify-center p-4 hidden"
        onclick="window.closeSystemHelpModal(event)">
        <div class="bg-white rounded-xl shadow-3xl w-full max-w-2xl modal-content-scroll"
            onclick="event.stopPropagation()">
            <div id="system-help-content" class="p-6">
                <!-- AIã«ã‚ˆã‚‹è§£èª¬ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
            </div>
        </div>
    </div>
    <!-- æ·»ä»˜ç”»åƒæ‹¡å¤§ãƒ¢ãƒ¼ãƒ€ãƒ« (å¤‰æ›´ãªã—) -->
    <div id="image-modal"
        class="fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4 hidden transition-opacity"
        onclick="window.closeImageModal(event)">
        <img id="image-modal-img" src="" class="max-w-full max-h-full object-contain rounded-lg shadow-xl">
    </div>
    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼åç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« (å¤‰æ›´ãªã—) -->
    <div id="name-editor-modal"
        class="fixed inset-0 bg-gray-900 bg-opacity-70 z-50 flex items-center justify-center p-4 hidden"
        onclick="window.closeNameEditor(event)">
        <div class="bg-white rounded-xl shadow-3xl w-full max-w-md" onclick="event.stopPropagation()">
            <div class="p-6">
                <h3 class="text-xl font-bold text-indigo-700 mb-4">è¡¨ç¤ºåã®å¤‰æ›´</h3>
                <p class="text-gray-700 mb-4">æ–°ã—ã„è¡¨ç¤ºåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                <input type="text" id="new-name-input"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border"
                    onkeydown="if(event.key === 'Enter') { window.submitNewName(); event.preventDefault(); }">
                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="window.closeNameEditor()"
                        class="px-4 py-2 text-sm font-medium bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button onclick="window.submitNewName()"
                        class="px-4 py-2 text-sm font-semibold bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">ä¿å­˜ã™ã‚‹</button>
                </div>
            </div>
        </div>
    </div>
    <!-- â˜… v23: åˆå›ã‚¦ã‚§ãƒ«ã‚«ãƒ ã‚¬ã‚¤ãƒ‰ (ãƒ¢ãƒ¼ãƒ€ãƒ«ã«å¤‰æ›´) -->
    <div id="welcome-guide-modal"
        class="fixed inset-0 bg-gray-900 bg-opacity-70 z-50 flex items-center justify-center p-4 hidden"
        onclick="window.closeWelcomeGuideModal(event)">
        <div class="bg-white rounded-xl shadow-3xl w-full max-w-md" onclick="event.stopPropagation()">
            <div class="p-6">
                <h3 class="text-xl font-bold text-indigo-700 mb-4 title-font">ã‚ˆã†ã“ãã€ãƒ¦ãƒ¡ãƒŸãƒ«ã¸ï¼</h3>
                <div class="space-y-3 text-sm text-gray-700">
                    <p>ã“ã®ã‚¢ãƒ—ãƒªã¯ã€AIãƒ­ãƒ¼ãƒ«ï¼ˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼‰ãŸã¡ã¨è‡ªç”±ã«ä¼šè©±ã§ãã‚‹ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã§ã™ã€‚</p>
                    <div class="flex items-center p-3 bg-indigo-50 border border-indigo-200 rounded-lg">
                        <div
                            class="w-10 h-10 rounded-full bg-indigo-500 text-white flex items-center justify-center text-xl font-bold flex-shrink-0 mr-3">
                            â“
                        </div>
                        <div>
                            <p class="font-semibold text-indigo-800">ã€Œã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«ã€ã«ã¤ã„ã¦</p>
                            <p class="text-xs">
                                ãƒãƒ£ãƒƒãƒˆå…¥åŠ›æ¬„ã®å·¦ã«ã‚ã‚‹ã‚¢ã‚¤ã‚³ãƒ³ãŒ <b class="font-bold">â“</b> ã«ãªã£ã¦ã„ã‚‹æ™‚ã€
                                ã‚ãªãŸã¯ã€Œã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«ã€ã¨ã—ã¦ç™ºè¨€ã—ã¾ã™ã€‚
                            </p>
                        </div>
                    </div>
                    <p>
                        ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«é¸æŠä¸­ã«ãƒãƒ£ãƒƒãƒˆæ¬„ã«è³ªå•ï¼ˆä¾‹ï¼šã€Œãƒ­ãƒ¼ãƒ«ã®ä½œã‚Šæ–¹ã¯ï¼Ÿã€ï¼‰ã‚’å…¥åŠ›ã—ã¦é€ä¿¡ã™ã‚‹ã¨ã€AIãŒã“ã®ã‚¢ãƒ—ãƒªã®æ©Ÿèƒ½ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚
                    </p>
                    <p>
                        ä½¿ã„æ–¹ãŒã‚ã‹ã‚‰ãªããªã£ãŸã‚‰ã€ã„ã¤ã§ã‚‚ <b>â“</b> ã‚’é¸ã‚“ã§AIã«è³ªå•ã—ã¦ãã ã•ã„ã€‚
                    </p>
                </div>
                <div class="flex justify-end mt-6 border-t pt-4">
                    <button onclick="window.closeWelcomeGuideModal()"
                        class="px-4 py-2 text-sm font-semibold bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        ã¯ã˜ã‚ã‚‹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- â˜… v23: å¾“æ¥ã®ã‚¦ã‚§ãƒ«ã‚«ãƒ ã‚¬ã‚¤ãƒ‰ (å‰Šé™¤) -->
    <div id="welcome-guide" class="fixed inset-0 z-40 hidden">
        <div class="absolute inset-0 bg-black opacity-30"></div>
        <div id="welcome-guide-highlight" class="absolute z-50 rounded-md border-4 border-blue-400 animate-pulse"
            style="pointer-events: none;"></div>
        <div id="welcome-guide-arrow" class="absolute w-0 h-0 z-50"
            style="border-top: 8px solid transparent; border-bottom: 8px solid transparent; border-right: 12px solid #374151;">
        </div>
        <div id="welcome-guide-text" class="absolute bg-gray-800 text-white p-4 rounded-lg shadow-xl z-50 w-64">
            <h4 class="font-bold mb-2">ã‚ˆã†ã“ãï¼</h4>
            <p class="text-sm">
                ã¾ãšã¯ã€ã“ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œ<strong class="text-blue-300">ğŸ‘¤ è‡ªåˆ†ã®åˆ†èº«ã‚’ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ä½œæˆ</strong>ã€ã‚’æŠ¼ã—ã¦ã€ãƒãƒ£ãƒƒãƒˆã«å‚åŠ ã™ã‚‹æº–å‚™ã‚’ã—ã¾ã—ã‚‡ã†ï¼
                <br><br>
                ã‚ãªãŸã®è¡¨ç¤ºåï¼ˆç¾åœ¨ã¯ã€Œ<strong class="text-yellow-300" id="welcome-guide-username">ã‚²ã‚¹ãƒˆ</strong>ã€ï¼‰ã¯ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†…ã®<strong
                    class="text-yellow-300">âœï¸ãƒœã‚¿ãƒ³</strong>ã‹ã‚‰å¤‰æ›´ã§ãã¾ã™ã€‚
            </p>
        </div>
    </div>
    <!-- ãƒ­ãƒ¼ãƒ«é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« (å¤‰æ›´ãªã—) -->
    <div id="speaker-selector-modal"
        class="fixed inset-0 bg-gray-900 bg-opacity-70 z-50 flex items-center justify-center p-4 hidden"
        onclick="window.closeSpeakerSelector(event)">
        <div class="bg-white rounded-xl shadow-3xl w-full max-w-md" onclick="event.stopPropagation()">
            <div class="p-6">
                <h3 class="text-xl font-bold text-indigo-700 mb-4">ç™ºè¨€ã™ã‚‹ãƒ­ãƒ¼ãƒ«ã‚’é¸æŠ</h3>
                <div id="speaker-selector-content" class="grid grid-cols-4 gap-3 max-h-96 overflow-y-auto"></div>
                <div class="flex justify-end mt-6 border-t pt-4">
                    <button onclick="window.closeSpeakerSelector()"
                        class="px-4 py-2 text-sm font-medium bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

</body>

</html>
